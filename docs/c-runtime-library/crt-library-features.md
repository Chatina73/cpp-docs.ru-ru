---
title: Особенности библиотеки CRT
description: Файлы, содержащие библиотеки времени выполнения Microsoft C и связанные с ними параметры компилятора и директивы препроцессора.
ms.date: 09/03/2020
helpviewer_keywords:
- MSVCR71.dll
- libraries [C++], multithreaded
- library files, run-time
- LIBCMT.lib
- LIBCP.lib
- LIBCPMT.lib
- run-time libraries, C
- CRT, release versions
- MSVCP71.dll
- LIBC.lib
- libraries [C++]
- libraries [C++], run-time
- linking [C++], libraries
ms.assetid: a889fd39-807d-48f2-807f-81492612463f
ms.openlocfilehash: 2f46577ba81c57c2050f0cae4ae2af73152ba2a4
ms.sourcegitcommit: 0df2b7ab4e81284c5248e4584767591dcc1950c3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/09/2020
ms.locfileid: "89609111"
---
# <a name="crt-library-features"></a>Особенности библиотеки CRT

В этом разделе обсуждаются различные LIB-файлы, входящие в библиотеки времени выполнения C, а также связанные параметры компилятора и директивы препроцессора.

## <a name="c-run-time-libraries-crt"></a>Библиотеки среды выполнения C (CRT)

Библиотека времени выполнения C (CRT) является частью стандартной библиотеки C++, содержащей библиотеку C99 стандарта ISO. Библиотеки Visual C++, которые реализуют CRT, поддерживают разработку с использованием машинного кода, а также сочетания машинного и управляемого кода. Все версии библиотек CRT поддерживают разработку многопоточного кода. Большинство библиотек поддерживает как статическое связывание (для связывания библиотеки непосредственно в коде), так и динамическое связывание (для использования в коде общих библиотек DLL).

Начиная с Visual Studio 2015, был проведен рефакторинг CRT, повлекший создание новых двоичных файлов. Универсальная библиотека CRT (UCRT) содержит функции и глобальные переменные, экспортируемые стандартной библиотекой CRT C99. UCRT теперь является компонентом Windows и поставляется в составе Windows 10. Статическая библиотека, DLL-библиотека импорта и файлы заголовков для UCRT теперь входят в пакет SDK для Windows 10. При установке Visual C++ программа установки Visual Studio устанавливает набор компонентов из пакета SDK для Windows 10, необходимых для использования UCRT. Библиотеку UCRT можно использовать в любой версии Windows, поддерживаемой Visual Studio 2015 и более поздними версиями. Ее можно распространять с помощью vcredist для поддерживаемых версий Windows (кроме Windows 10). Дополнительные сведения см. в разделе [Распространение файлов Visual C++](../windows/redistributing-visual-cpp-files.md).

В следующей таблице перечислены библиотеки, которые реализуют UCRT.

| Библиотека | Связанная DLL | Характеристики | Параметр | Директивы препроцессора |
|--|--|--|--|--|
| *`libucrt.lib`* | Нет | Статически связывает UCRT в коде. | **`/MT`** | `_MT` |
| *`libucrtd.lib`* | Нет | Отладочная версия UCRT для статического связывания. Нераспространяемый компонент. | **`/MTd`** | `_DEBUG`, `_MT` |
| *`ucrt.lib`* | *`ucrtbase.dll`* | DLL-библиотека импорта для UCRT. | **`/MD`** | `_MT`, `_DLL` |
| *`ucrtd.lib`* | *`ucrtbased.dll`* | DLL-библиотека импорта для отладочной версии UCRT. Нераспространяемый компонент. | **`/MDd`** | `_DEBUG`, `_MT`, `_DLL` |

Библиотека vcruntime содержит код Visual C++, определяемый реализацией CRT (такой как поддержка обработки исключений и отладки), проверки времени выполнения, сведения о типах, сведения о реализации и некоторые расширенные функции библиотеки. Эта библиотека определяется версией используемого компилятора.

В этой таблице перечислены библиотеки, которые реализуют библиотеку vcruntime.

| Библиотека | Связанная DLL | Характеристики | Параметр | Директивы препроцессора |
|--|--|--|--|--|
| *`libvcruntime.lib`* | Нет | Статически связанная с кодом. | **`/MT`** | `_MT` |
| *`libvcruntimed.lib`* | Нет | Отладочная версия для статического связывания. Нераспространяемый компонент. | **`/MTd`** | `_MT`, `_DEBUG` |
| *`vcruntime.lib`* | *`vcruntime<version>.dll`* | DLL-библиотека импорта для vcruntime. | **`/MD`** | `_MT`, `_DLL` |
| *`vcruntimed.lib`* | *`vcruntime<version>d.dll`* | DLL-библиотека импорта для отладочной версии vcruntime. Нераспространяемый компонент. | **`/MDd`** | `_DEBUG`, `_MT`, `_DLL` |

> [!NOTE]
> Когда произошел рефакторинг UCRT, функции среда выполнения с параллелизмом были перемещены в *`concrt140.dll`* , которые были добавлены в распространяемый пакет C++. Эта библиотека DLL необходима для параллельных контейнеров и алгоритмов C++, таких как `concurrency::parallel_for`. Кроме того, стандартная библиотека C++ требует эту библиотеку DLL в Windows XP для поддержки примитивов синхронизации, так как Windows XP не поддерживает переменные условия.

Код, инициализирующий CRT, находится в одной из нескольких библиотек в зависимости от статического или динамического связывания библиотеки CRT и использования машинного, управляемого или смешанного кода. Этот код обрабатывает запуск, инициализацию внутренних данных потоков и завершение CRT. Он определяется версией используемого компилятора. Эта библиотека всегда статически связана, даже при использовании динамически связанной библиотеки UCRT.

В этой таблице перечислены библиотеки, которые реализуют инициализацию и завершение CRT.

| Библиотека | Характеристики | Параметр | Директивы препроцессора |
|--|--|--|--|
| *`libcmt.lib`* | Статически связывает в коде запуск CRT машинного кода. | **`/MT`** | `_MT` |
| *`libcmtd.lib`* | Статически связывает отладочную версию запуска CRT в машинном коде. Нераспространяемый компонент. | **`/MTd`** | `_DEBUG`, `_MT` |
| *`msvcrt.lib`* | Статическая библиотека для запуска CRT в машинном коде для использования с DLL, UCRT и vcruntime. | **`/MD`** | `_MT`, `_DLL` |
| *`msvcrtd.lib`* | Статическая библиотека для запуска отладочной версии CRT в машинном коде для использования с DLL, UCRT и vcruntime. Нераспространяемый компонент. | **`/MDd`** | `_DEBUG`, `_MT`, `_DLL` |
| *`msvcmrt.lib`* | Статическая библиотека для запуска CRT в смешанном машинном и управляемом коде для использования с DLL, UCRT и vcruntime. | **`/clr`** |  |
| *`msvcmrtd.lib`* | Статическая библиотека для запуска отладочной версии CRT в смешанном машинном и управляемом коде для использования с DLL, UCRT и vcruntime. Нераспространяемый компонент. | **`/clr`** |  |
| *`msvcurt.lib`* | **Нерекомендуемая** статическая библиотека для CRT с полностью управляемым кодом. | **`/clr:pure`** |  |
| *`msvcurtd.lib`* | **Нерекомендуемая** статическая библиотека для отладочной версии CRT с полностью управляемым кодом. Нераспространяемый компонент. | **`/clr:pure`** |  |

Если вы свяжете программу из командной строки без параметра компилятора, указывающего библиотеку времени выполнения C, компоновщик будет использовать статически связанные библиотеки CRT: *`libcmt.lib`* , *`libvcruntime.lib`* и *`libucrt.lib`* .

Использование статически скомпонованных CRT означает, что все сведения о состоянии, сохраненные библиотекой времени выполнения C, будут локальны по отношению к этому экземпляру CRT. Например, если используется [`strtok`](../c-runtime-library/reference/strtok-strtok-l-wcstok-wcstok-l-mbstok-mbstok-l.md) при использовании статически связанной CRT, то расположение `strtok` средства синтаксического анализа не связано с `strtok` состоянием, используемым в коде в том же процессе (но в другой библиотеке DLL или exe), связанном с другим экземпляром статической библиотеки CRT. Напротив, динамически скомпонованная библиотека CRT позволяет использовать состояние всему коду в процессе, который динамически скомпонован с этой библиотекой CRT. Это не относится к новым более безопасным версиям этих функций; например, эта проблема не распространяется на `strtok_s` .

Поскольку библиотека DLL, собранная путем компоновки со статической библиотекой CRT, будет иметь собственное состояние CRT, не рекомендуется использовать статическую компоновку с CRT для DLL без понимания последствий и конкретной необходимости. Например, при вызове [`_set_se_translator`](../c-runtime-library/reference/set-se-translator.md) в исполняемом файле, который загружает БИБЛИОТЕКУ DLL, связанную со своей собственной статической библиотекой CRT, все исключения оборудования, создаваемые кодом в библиотеке DLL, не будут перехвачены преобразователем, но аппаратные исключения, создаваемые кодом в основном исполняемом файле, будут перехвачены.

Если вы используете **`/clr`** параметр компилятора, код будет связан со статической библиотекой msvcmrt. lib. Эта статическая библиотека предоставляет функцию прокси между управляемым кодом и неуправляемой средой CRT. Статически связанные CRT ( **`/MT`** или **`/MTd`** Параметры) нельзя использовать с **`/clr`** . Вместо этого используйте динамически связываемые библиотеки ( **`/MD`** или **`/MDd`** ). Полностью управляемые библиотеки CRT отмечены как нерекомендуемые для использования в Visual Studio 2015 и не поддерживаются в Visual Studio 2017.

Дополнительные сведения об использовании CRT с см **`/clr`** . в разделе [смешанные (собственные и управляемые) сборки](../dotnet/mixed-native-and-managed-assemblies.md).

Чтобы создать отладочную версию приложения, [`_DEBUG`](../c-runtime-library/debug.md) необходимо определить флаг, и приложение должно быть связано с отладочной версией одной из этих библиотек. Дополнительные сведения об использовании отладочных версий файлов библиотек см. в разделе [Методы отладки CRT](/visualstudio/debugger/crt-debugging-techniques).

Эта версия CRT не полностью совместима со стандартом C99. В версиях до Visual Studio 2019 версии 16,8 \<tgmath.h> заголовок не поддерживается. Во всех версиях `CX_LIMITED_RANGE` `FP_CONTRACT` макросы и директивы pragma не поддерживаются. Некоторые элементы, такие как значения спецификаторов параметров в стандартных функциях ввода-вывода, по умолчанию используют интерпретации прежних версий. Можно использовать **`/Zc`** Параметры соответствия компилятора и указать параметры компоновщика для управления некоторыми аспектами соответствия библиотеки.

## <a name="c-standard-library"></a>Стандартная библиотека C++

| Стандартная библиотека C++ | Характеристики | Параметр | Директивы препроцессора |
|--|--|--|--|
| *`libcpmt.lib`* | Многопоточная, статическая компоновка. | **`/MT`** | `_MT` |
| *`msvcprt.lib`* | Многопоточная, динамическая компоновка (импорт библиотеки для *`msvcp<version>.dll`* ) | **`/MD`** | `_MT`, `_DLL` |
| *`libcpmtd.lib`* | Многопоточная, статическая компоновка. | **`/MTd`** | `_DEBUG`, `_MT` |
| *`msvcprtd.lib`* | Многопоточная, динамическая компоновка (импорт библиотеки для *`msvcp<version>d.dll`* ) | **`/MDd`** | `_DEBUG`, `_MT`, `_DLL` |

При создании окончательной версии проекта одна из базовых библиотек времени выполнения C ( *`libcmt.lib`* , *`msvcmrt.lib`* , *`msvcrt.lib`* ) по умолчанию связана в зависимости от выбранного параметра компилятора (многопоточная, DLL **`/clr`** ). Если вы включите в код любой из [файлов заголовка стандартной библиотеки C++](../standard-library/cpp-standard-library-header-files.md), Visual C++ автоматически подключит стандартную библиотеку C++ во время компиляции. Пример:

```cpp
#include <ios>
```

Для совместимости на уровне двоичного кода одна библиотека импорта может задавать несколько DLL-файлов. Обновления версий могут ввести *библиотеки dot* — отдельные DLL-файлы, которые вводят новые функции библиотеки. Например, Visual Studio 2017 версии 15,6 введена *`msvcp140_1.dll`* для поддержки дополнительных функций стандартной библиотеки без нарушения интерфейса ABI, поддерживаемого *`msvcp140.dll`* . *`msvcprt.lib`* Библиотека импорта, входящая в набор инструментов для Visual Studio 2017 версии 15,6, поддерживает обе библиотеки DLL, а для этой версии устанавливается обе библиотеки DLL. После доставки библиотека dot имеет фиксированный ABI и никогда не будет зависеть от библиотеки dot более поздней версии.

## <a name="what-problems-exist-if-an-application-uses-more-than-one-crt-version"></a>Если приложение использует несколько версий CRT, с какими проблемами можно столкнуться?

С каждым исполняемым образом (EXE или DLL) может статически связываться собственная библиотека CRT. В образе может создаваться динамическая ссылка на CRT. Версия CRT статически включена или динамически загружается в зависимости от версии средств и библиотек, в которой она был создана. В рамках одного процесса может загружаться несколько образов EXE и DLL, каждый с собственной библиотекой CRT. Распределители, внутренние структуры макета и варианты организации хранилища для этих CRT могут быть разными. Это означает, что выделенная память, ресурсы CRT или классы, которые передаются через границу библиотеки DLL, могут вызвать проблемы с управлением памятью, внутренним статическим использованием или интерпретацией макета. Например, если класс выделен в одной библиотеке DLL, но передан в другую и удален, какой используется метод освобождения CRT? Возникающие ошибки могут быть в диапазоне от несущественных до неустранимых. Поэтому настоятельно не рекомендуем передавать такие ресурсы напрямую.

Многих проблем можно избежать, воспользовавшись технологией двоичного интерфейса приложений (ABI). Она ориентирована на стабильность и поддержку версий. Разрабатывайте ваши интерфейсы экспорта DLL для передачи информации в виде значения или для работы в памяти, которая передается вызывающим объектом, а не в локально выделенной памяти, которая возвращается вызывающей стороне. Используйте методы маршалирования для копирования структурированных данных между исполняемыми образами. Инкапсулируйте ресурсы локально и допускайте действия только через дескрипторы или функции, которые вы предоставляете клиентам.

Кроме того, вы можете избежать некоторых из этих проблем, если для всех образов в процессе будет использоваться одна и та же версия динамически загружаемой библиотеки CRT. Чтобы убедиться, что все компоненты используют одну и ту же версию библиотеки CRT, создайте их с помощью **`/MD`** параметра и используйте тот же набор инструментов компилятора и параметров свойств.

Будьте внимательны, если программа передает определенные ресурсы CRT через границы DLL. Такие ресурсы, как дескрипторы файлов, языковые стандарты и переменные среды, могут вызывать проблемы даже при использовании той же версии CRT. Дополнительные сведения о связанных проблемах и способах их устранения см. в разделе [Потенциальные ошибки при передаче объектов CRT через границы DLL](../c-runtime-library/potential-errors-passing-crt-objects-across-dll-boundaries.md).

## <a name="see-also"></a>См. также раздел

- [Справочник по библиотеке времени выполнения C](../c-runtime-library/c-run-time-library-reference.md)
