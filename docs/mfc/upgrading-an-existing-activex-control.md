---
title: Обновление существующего элемента управления ActiveX
ms.date: 09/12/2018
helpviewer_keywords:
- ActiveX controls [MFC], Internet
- LPK files for Internet controls
- safe for scripting and initialization (controls)
- OLE controls [MFC], upgrading to ActiveX
- CAB files, for ActiveX controls
- Internet applications [MFC], ActiveX controls
- Internet applications [MFC], packaging code for download
- upgrading ActiveX controls
- licensing ActiveX controls
ms.assetid: 4d12ddfa-b491-4f9f-a0b7-b51458e05651
ms.openlocfilehash: 802640d5132c28dbda564afcb63c12d8a4133042
ms.sourcegitcommit: c123cc76bb2b6c5cde6f4c425ece420ac733bf70
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81353547"
---
# <a name="upgrading-an-existing-activex-control"></a>Обновление существующего элемента управления ActiveX

Существующие элементы управления ActiveX (ранее элементы управления OLE) могут использоваться в Интернете без изменений. Тем не менее, вы можете изменить элементы управления, чтобы улучшить их производительность.

> [!IMPORTANT]
> ActiveX является устаревшей технологией, которая не должна использоваться для новых разработок. Для получения дополнительной информации о современных технологиях, которые заменяли ActiveX, [см.](activex-controls.md)

При использовании элемента управления на веб-странице возникают дополнительные соображения. Файл .ocx и все вспомогательные файлы должны быть на целевой машине или быть загружены через Интернет. Это делает размер кода и время загрузки важным соображением. Загрузки могут быть упакованы в подписанный файл .cab. Вы можете пометить свой элемент как безопасный для сценариев и как безопасный для инициализации.

В этой статье рассматриваются следующие темы.

- [Упаковочный код для загрузки](#_core_packaging_code_for_downloading)

- [Маркировка безопасного элемента управления для сценариев и инициализации](#_core_marking_a_control_safe_for_scripting_and_initializing)

- [Вопросы лицензирования](#_core_licensing_issues)

- [Код подписи](#_core_signing_code)

- [Управление палитра](#_core_managing_the_palette)

- [Уровни безопасности браузера Internet Explorer и поведение контроля](#_core_internet_explorer_browser_safety_levels_and_control_behavior)

Вы также можете добавить оптимизацию, описанную в [ActiveX Controls: Оптимизация.](../mfc/mfc-activex-controls-optimization.md) Монеты можно использовать для загрузки свойств и больших BLOBs асинхронно, как описано в [ActiveX Controls в Интернете.](../mfc/activex-controls-on-the-internet.md)

## <a name="packaging-code-for-downloading"></a><a name="_core_packaging_code_for_downloading"></a>Упаковочный код для загрузки

Для получения дополнительной информации по этому вопросу, см [Упаковка ActiveX управления](https://docs.microsoft.com//previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa751974%28v%3dvs.85%29).

### <a name="the-codebase-tag"></a>Тег CODEBASE

Элементы управления ActiveX встраиваются в веб-страницы с помощью тега. `<OBJECT>` Параметр `CODEBASE` тега `<OBJECT>` определяет место, из которого можно загрузить элемент управления. `CODEBASE`может указать на ряд различных типов файлов успешно.

### <a name="using-the-codebase-tag-with-an-ocx-file"></a>Использование тега CODEBASE с файлом OCX

```
CODEBASE="http://example.microsoft.com/mycontrol.ocx#version=4,
    70,
    0,
    1086"
```

Это решение загружает только файл .ocx управления и требует, чтобы любые поддерживающие DLL уже были установлены на клиентской машине. Это будет работать для Internet Explorer и MFC ActiveX управления построен с Visual СЗ, потому что Internet Explorer судов с поддержкой DLLs для визуального управления СЗ. Если для просмотра этого элемента управления используется другой интернет-браузер, способный управлять системой ActiveX, это решение не будет работать.

### <a name="using-the-codebase-tag-with-an-inf-file"></a>Использование тега CODEBASE с файлом INF

```
CODEBASE="http://example.microsoft.com/trustme.inf"
```

Файл .inf будет контролировать установку .ocx и его вспомогательных файлов. Этот метод не рекомендуется, поскольку невозможно подписать файл .inf (см. [Код подписи](#_core_signing_code) для указателей на подписание кода).

### <a name="using-the-codebase-tag-with-a-cab-file"></a>Использование тега CODEBASE с файлом CAB

```
CODEBASE="http://example.microsoft.com/acontrol.cab#version=1,
    2,
    0,
    0"
```

Файлы кабинета являются рекомендуемым способом упаковки элементов управления ActiveX, которые используют MFC. Упаковка управления MFC ActiveX в файл кабинета позволяет включить файл .inf для управления управлением ActiveX и любых зависимых DLLs (например, DLLs MFC). Использование файла CAB автоматически сжимает код для более быстрой загрузки. Если вы используете файл .cab для загрузки компонентов, это быстрее, чтобы подписать весь файл .cab, чем каждый отдельный компонент.

### <a name="creating-cab-files"></a>Создание файлов CAB

Инструменты для создания файлов кабинета теперь являются частью [Windows 10 SDK](https://dev.windows.com/downloads/windows-10-sdk).

Файл кабинета, на `CODEBASE` который указывается, должен содержать файл .ocx для вашего управления ActiveX и файл .inf для управления его установкой. Вы создаете файл кабинета, указывая имя вашего файла управления и файл .inf. Не включайте зависимые DLL, которые могут уже существовать в системе, в этом файле кабинета. Например, DLL MFC упаковываются в отдельный файл кабинета и упоминаются в файле controlling .inf.

Для получения подробной информации о том, как создать файл CAB, [см.](/windows/win32/devnotes/cabinet-api-functions)

### <a name="the-inf-file"></a>Файл INF

Следующий пример, spindial.inf, перечисляет вспомогательные файлы и информацию версии, необходимую для управления MFC Spindial. Обратите внимание, что местоположение DLLs MFC — это веб-сайт Майкрософт. mfc42.cab предоставляется и подписан корпорацией Майкрософт.

```
Contents of spindial.inf:
[mfc42installer]
file-win32-x86=http://activex.microsoft.com/controls/vc/mfc42.cab
[Olepro32.dll] - FileVersion=5,
    0,
    4261,
    0
[Mfc42.dll] - FileVersion=6,
    0,
    8168,
    0
[Msvcrt.dll] - FileVersion=6,
    0,
    8168,
    0
```

### <a name="the-object-tag"></a>Тег \<> OBJECT

Следующий пример иллюстрирует `<OBJECT>` использование тега для упаковки контроля образца MFC Spindial.

```
<OBJECT ID="Spindial1" WIDTH=100 HEIGHT=51
    CLASSID="CLSID:06889605-B8D0-101A-91F1-00608CEAD5B3"
    CODEBASE="http://example.microsoft.com/spindial.cab#Version=1,0,0,001">
<PARAM NAME="_Version" VALUE="65536">
<PARAM NAME="_ExtentX" VALUE="2646">
<PARAM NAME="_ExtentY" VALUE="1323">
<PARAM NAME="_StockProps" VALUE="0">
<PARAM NAME="NeedlePosition" VALUE="2">
</OBJECT>
```

В этом случае spindial.cab будет содержать два файла, spindial.ocx и spindial.inf. Следующая команда будет строить файл кабинета:

```
C:\CabDevKit\cabarc.exe -s 6144 N spindial.cab spindial.ocx spindial.inf
```

Параметр `-s 6144` резервирует место в шкафу для подписания кода.

### <a name="the-version-tag"></a>Тег версии

Обратите внимание, `#Version` что информация, указанная в файле CAB, относится к элементу управления, указанному параметром *CLASSID* тега. `<OBJECT>`

В зависимости от указанной версии можно принудительно загрузить элемент управления. Для получения полных `OBJECT` спецификаций тега, включая параметр *CODEBASE,* см.

## <a name="marking-a-control-safe-for-scripting-and-initializing"></a><a name="_core_marking_a_control_safe_for_scripting_and_initializing"></a>Маркировка безопасного элемента управления для сценариев и инициализации

Элементы управления ActiveX, используемые на веб-страницах, должны быть помечены как безопасные для сценариев и безопасные для инициализации, если они на самом деле безопасны. Безопасный элемент управления не будет выполнять исправления диска или доступа к памяти или регистрам машины напрямую.

Элементы управления могут быть помечены как безопасные для сценариев и безопасны для инициализации через реестр. Измените `DllRegisterServer` добавление записей, аналогичных следующим, чтобы отметить элемент управления как безопасный для скриптов и настойчивости в реестре. Альтернативный метод заключается в реализации. `IObjectSafety`

Вы определите GUID (Глобально уникальные идентификаторы) для вашего управления, чтобы отметить его безопасным для сценариев и для настойчивости. Элементы управления, которые можно безопасно посценарить, будут содержать запись реестра, аналогичную следующему:

```
HKEY_CLASSES_ROOT\Component Categories\{7DD95801-9882-11CF-9FA9-00AA006C42C4}
```

Элементы управления, которые могут быть безопасно инициализированы из стойких данных, отмечены безопасными для настойчивости с записью реестра, аналогичной:

```
HKEY_CLASSES_ROOT\Component Categories\{7DD95802-9882-11CF-9FA9-00AA006C42C4}
```

Добавьте записи, аналогичные следующим (замена идентификатора `{06889605-B8D0-101A-91F1-00608CEAD5B3}`класса элемента управления вместо) для ассоциирования ключей со следующим идентификатором класса:

```
HKEY_CLASSES_ROOT\CLSID\{06889605-B8D0-101A-91F1-00608CEAD5B3}\Implemented Categories\{7DD95801-9882-11CF-9FA9-00AA006C42C4}
HKEY_CLASSES_ROOT\CLSID\{06889605-B8D0-101A-91F1-00608CEAD5B3}\Implemented Categories\{7DD95802-9882-11CF-9FA9-00AA006C42C4}
```

## <a name="licensing-issues"></a><a name="_core_licensing_issues"></a>Вопросы лицензирования

Если вы хотите использовать лицензированный элемент управления на веб-странице, необходимо убедиться, что лицензионное соглашение позволяет использовать его в Интернете, и создать для него файл пакет лицензионного пакета (LPK).

Лицензированный элемент управления ActiveX не загружается должным образом на страницу HTML, если компьютер под управлением Internet Explorer не имеет лицензии на использование элемента управления. Например, если лицензированный элемент управления был построен с помощью Visual C, HTML-страница с помощью элемента управления будет правильно загружена на компьютер, где был построен элемент управления, но она не будет загружаться на другой компьютер, если информация о лицензировании не будет включена.

Чтобы использовать лицензированный элемент управления ActiveX в Internet Explorer, необходимо проверить лицензионное соглашение поставщика, чтобы убедиться, что лицензия на контроль позволяет:

- Повторное распространение

- Использование контроля в Интернете

- Использование параметра Codebase

Чтобы использовать лицензированный элемент управления на странице HTML на нелицензированной машине, необходимо создать файл пакетов лицензий (LPK). Файл LPK содержит лицензии на время выполнения лицензий на лицензированные элементы управления на странице HTML. Этот файл генерируется через LPK_TOOL. EXE, который поставляется с ActiveX SDK.

#### <a name="to-create-an-lpk-file"></a>Создание файла LPK

1. Беги LPK_TOOL. EXE на компьютере, который имеет лицензию на использование элемента управления.

1. В диалоговом окне **пакетов лицензионных пакетов** в поле **списка доступных элементов управления** выберите каждый лицензированный элемент управления ActiveX, который будет использоваться на странице HTML, и нажмите **«Добавить».**

1. Нажмите **Сохранить & выход** и введите имя для файла LPK. Это создаст файл LPK и закроет приложение.

#### <a name="to-embed-a-licensed-control-on-an-html-page"></a>Вставлять лицензированный элемент управления на страницу HTML

1. Отоверьте свою страницу HTML. На странице HTML вставьте тег \<OBJECT> для объекта \<менеджера лицензии, прежде чем какие-либо другие теги OBJECT>. Менеджер лицензии — это элемент управления ActiveX, который устанавливается с помощью Internet Explorer. Идентификатор класса отображается ниже. Установите свойство LPKPath объекта менеджера лицензии на путь и имя файла LPK. На страницу HTML можно иметь только один файл LPK.

```
<OBJECT CLASSID = "clsid:5220cb21-c88d-11cf-b347-00aa00a28331">
<PARAM NAME="LPKPath" VALUE="relative URL to .LPK file">
</OBJECT>
```

1. Вставьте \<тег OBJECT> для вашего лицензионного управления после тега licence Manager.

   Например, ниже отображается страница HTML, на которой отображается элемент управления отсвачения майкрософт в маске. Идентификатор первого класса предназначен для управления диспетчером лицензий, идентификатор второго класса — для управления masked Edit. Измените теги, чтобы указать на относительный путь созданного ранее файла .lpk, и добавьте тег объекта, включав идентификатор класса для элемента управления.

1. Вставьте \<атрибут EMBED> для файла LPK, если с помощью плагина NCompass ActiveX.

   Если ваш элемент управления можно просматривать в других браузерах с поддержкой Active - например, Netscape с помощью плагина NCompass ActiveX - необходимо добавить \<> синтаксис EMBED, как показано ниже.

```
<OBJECT CLASSID="clsid:5220cb21-c88d-11cf-b347-00aa00a28331">
<PARAM NAME="LPKPath" VALUE="maskedit.lpk">

<EMBED SRC = "maskedit.LPK">

</OBJECT>
<OBJECT CLASSID="clsid:C932BA85-4374-101B-A56C-00AA003668DC" WIDTH=100 HEIGHT=25>
</OBJECT>
```

Для получения дополнительной информации [ActiveX Controls: Licensing an ActiveX Control](../mfc/mfc-activex-controls-licensing-an-activex-control.md)о лицензировании управления см.

## <a name="signing-code"></a><a name="_core_signing_code"></a>Код подписи

Подписание кода предназначено для определения источника кода и гарантии того, что код не изменился с момента его подписания. В зависимости от настроек безопасности браузера, пользователи могут быть предупреждены перед загрузкой кода. Пользователи могут доверять определенным владельцам сертификатов или компаниям, и в этом случае код, подписанный доверенными лицами, будет загружен без предупреждения. Код подписывается в цифровом виде, чтобы избежать фальсификации.

Убедитесь, что ваш окончательный код подписан, чтобы ваш элемент управления мог быть автоматически загружен без отображения сообщений о доверии. Для получения подробной информации о том, как подписать код, проверьте документацию по Authenticode в ActiveX SDK и просмотрите [Подписание файла CAB](/windows/win32/devnotes/cabinet-api-functions).

В зависимости от настроек доверия и уровня безопасности браузера, сертификат может отображаться для идентификации подписавшего лица или компании. Если уровень безопасности не является, или если владельцу сертификата подписанного элемента управления доверяют, сертификат не отображается. Подробнее о том, как настройка безопасности браузера определяет, загружается ли ваш элемент управления и отображается сертификат, смотрите [уровень безопасности браузера.](#_core_internet_explorer_browser_safety_levels_and_control_behavior)

Код гарантий цифрового подписания не изменился с момента его подписания. Хэш кода берется и встраивается в сертификат. Этот хэш позже сравнивается с хэшом кода, взятого после загрузки кода, но перед запуском. Такие компании, как Verisign, могут поставлять частные и публичные ключи, необходимые для подписания кода. ActiveX SDK поставляется с MakeCert, утилитой для создания тестовых сертификатов.

## <a name="managing-the-palette"></a><a name="_core_managing_the_palette"></a>Управление палитра

Контейнеры определяют палитру и делают ее доступной в качестве окружающего свойства, **DISPID_AMBIENT_PALETTE.** Контейнер (например, Internet Explorer) выбирает палитру, которая используется всеми элементами управления ActiveX на странице для определения своей собственной палитры. Это предотвращает мерцание дисплея и представляет собой последовательный внешний вид.

Элемент управления может `OnAmbientPropertyChange` переопределить для обработки уведомлений об изменениях в палитре.

Элемент управления может `OnGetColorSet` переопределить, чтобы вернуть набор цветов, чтобы нарисовать палитру. Контейнеры используют значение возврата, чтобы определить, является ли элемент управления осведомленным о палитре.

В соответствии с руководящими принципами OCX 96 элемент управления всегда должен осознавать свою палитру в фоновом режиме.

Старые контейнеры, не использовавающие свойство эмбиентной палитры, отправляют WM_QUERYNEWPALETTE и WM_PALETTECHANGED сообщения. Элемент управления может `OnQueryNewPalette` `OnPaletteChanged` переопределить и обрабатывать эти сообщения.

## <a name="internet-explorer-browser-safety-levels-and-control-behavior"></a><a name="_core_internet_explorer_browser_safety_levels_and_control_behavior"></a>Уровни безопасности браузера Internet Explorer и поведение контроля

Браузер имеет варианты уровня безопасности, настраиваемые пользователем. Поскольку веб-страницы могут содержать активный контент, который потенциально может нанести вред компьютеру пользователя, браузеры позволяют пользователю выбирать варианты для уровня безопасности. В зависимости от того, как браузер реализует уровни безопасности, элемент управления может вообще не быть загружен, или будет отображать сертификат или предупреждение, чтобы позволить пользователю выбрать во время выполнения или не скачать элемент управления. Ниже приводится поведение элементов управления ActiveX при высоком, среднем и низком уровне безопасности на Internet Explorer.

### <a name="high-safety-mode"></a>Режим высокой безопасности

- Неподписанные элементы управления не будут загружены.

- Подписанные элементы управления будут отображать сертификат, если не доверяют (пользователь может выбрать вариант, чтобы всегда доверять код от этого владельца сертификата отныне).

- Только элементы управления, помеченные как безопасные, будут иметь постоянные данные и/или быть скриптативными.

### <a name="medium-safety-mode"></a>Режим средней безопасности

- Неподписанные элементы управления будут отображать предупреждение перед загрузкой.

- Подписанные элементы управления будут отображать сертификат, если не доверяют.

- Элементы управления, не помеченные как безопасные, будут отображать предупреждение.

### <a name="low-safety-mode"></a>Низкий режим безопасности

- Элементы управления загружаются без предупреждения.

- Сценарий и настойчивость происходят без предупреждения.

## <a name="see-also"></a>См. также раздел

[Задачи программирования для интернет-решений MFC](../mfc/mfc-internet-programming-tasks.md)<br/>
[Основы программирования ВРЦ в Интернете](../mfc/mfc-internet-programming-basics.md)<br/>
[Элементы управления ActiveX в MFC. Лицензирование элемента управления ActiveX](../mfc/mfc-activex-controls-licensing-an-activex-control.md)
