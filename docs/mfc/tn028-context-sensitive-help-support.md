---
description: 'Дополнительные сведения о: TN028: Context-Sensitive поддержки справки'
title: TN028. Поддержка контекстной справки
ms.date: 11/04/2016
f1_keywords:
- vc.help
helpviewer_keywords:
- context-sensitive Help [MFC], MFC applications
- TN028
- resource identifiers, context-sensitive Help
ms.assetid: 884f1c55-fa27-4d4c-984f-30907d477484
ms.openlocfilehash: 96dd1d4356ac226d9377e14985de46e3d0f680ef
ms.sourcegitcommit: d6af41e42699628c3e2e6063ec7b03931a49a098
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2020
ms.locfileid: "97215655"
---
# <a name="tn028-context-sensitive-help-support"></a>TN028. Поддержка контекстной справки

В этом заметке описываются правила назначения идентификаторов контекстов справки и другие проблемы справки в MFC. Для поддержки контекстно-зависимой справки требуется компилятор справки, доступный в Visual C++.

> [!NOTE]
> Помимо реализации контекстной справки с помощью WinHelp, MFC также поддерживает использование HTML-справки. Дополнительные сведения об этой поддержке и программировании с помощью HTML-справки см. в разделе [Справка HTML: Context-Sensitive Справка по программам](../mfc/html-help-context-sensitive-help-for-your-programs.md).

## <a name="types-of-help-supported"></a>Поддерживаемые типы справки

В приложениях Windows реализовано два типа контекстно-зависимой справки. Первая, называемая "Справка F1", включает в себя запуск WinHelp с соответствующим контекстом, основанным на текущем активном объекте. Второй — режим "Shift + F1". В этом режиме курсор мыши меняется на курсор справки, и пользователь переходит к щелчку объекта. На этом этапе открывается WinHelp, чтобы получить справку для объекта, который щелкнул пользователь.

В Microsoft Foundation Classes реализованы обе эти формы справки. Кроме того, платформа поддерживает две простые команды справки, указатель справки и использование справки.

## <a name="help-files"></a>Файлы справки

Классы Microsoft Foundation предполагают наличие одного файла справки. Файл справки должен иметь то же имя и путь, что и приложение. Например, если исполняемый файл является C:\MyApplication\MyHelp.exe файл справки должен быть К:\мяппликатион\михелп.хлп. Путь задается с помощью переменной-члена *M_pszHelpFilePath* [класса CWinApp](../mfc/reference/cwinapp-class.md).

## <a name="help-context-ranges"></a>Диапазоны контекста справки

Реализация MFC по умолчанию требует, чтобы программа соследовала некоторым правилам назначения идентификаторов контекста справки. Эти правила представляют собой диапазон идентификаторов, выделенных для конкретных элементов управления. Эти правила можно переопределить, предоставив разные реализации различных функций-членов, связанных с справкой.

```
0x00000000 - 0x0000FFFF : user defined
0x00010000 - 0x0001FFFF : commands (menus/command buttons)
0x00010000 + ID_
(note: 0x18000-> 0x1FFFF is the practical range since command IDs are>=0x8000)
0x00020000 - 0x0002FFFF : windows and dialogs
0x00020000 + IDR_
(note: 0x20000-> 0x27FFF is the practical range since IDRs are <= 0x7FFF)
0x00030000 - 0x0003FFFF : error messages (based on error string ID)
0x00030000 + IDP_
0x00040000 - 0x0004FFFF : special purpose (non-client areas)
0x00040000 + HitTest area
0x00050000 - 0x0005FFFF : controls (those that are not commands)
0x00040000 + IDW_
```

## <a name="simple-help-commands"></a>Простые команды "Справка"

Существует две простые команды справки, реализуемые Microsoft Foundation Classes:

- ID_HELP_INDEX который реализуется с помощью [CWinApp:: онхелпиндекс](../mfc/reference/cwinapp-class.md#onhelpindex)

- ID_HELP_USING который реализуется с помощью [CWinApp:: онхелпусинг](../mfc/reference/cwinapp-class.md#onhelpusing)

Первая команда отображает Индекс справки для приложения. Во втором выводится справка по использованию программы WinHelp.

## <a name="context-sensitive-help-f1-help"></a>Справка Context-Sensitive (Справка F1)

Клавиша F1 обычно преобразуется в команду с ИДЕНТИФИКАТОРом ID_HELP ускорителем, помещенным в таблицу сочетаний клавиш главного окна. Команда ID_HELP может также быть создана с помощью кнопки с ИДЕНТИФИКАТОРом ID_HELP в главном окне или в диалоговом окне.

Независимо от того, как создается команда ID_HELP, она направляется в виде обычной команды до тех пор, пока не достигнет обработчика команд. Дополнительные сведения об архитектуре маршрутизации команд MFC см. в [технической заметке 21](../mfc/tn021-command-and-message-routing.md). Если в приложении включена справка, Команда ID_HELP будет обрабатываться с помощью команды [CWinApp:: OnHelp](../mfc/reference/cwinapp-class.md#onhelp). Объект приложения получает справочное сообщение, а затем направляет команду соответствующим образом. Это необходимо, поскольку маршрутизация команд по умолчанию не подходит для определения наиболее конкретного контекста.

`CWinApp::OnHelp` пытается запустить WinHelp в следующем порядке:

1. Проверяет активный `AfxMessageBox` вызов с помощью идентификатора справки. Если окно сообщения в настоящий момент активно, WinHelp запускается с контекстом, соответствующим этому полю сообщения.

1. Отправляет сообщение WM_COMMANDHELP в активное окно. Если это окно не отвечает, запустив WinHelp, то то же самое сообщение отправляется предкам этого окна до тех пор, пока сообщение не будет обработано или текущее окно не станет окном верхнего уровня.

1. Отправляет команду ID_DEFAULT_HELP в главное окно. При этом вызывается Справка по умолчанию. Эта команда обычно сопоставлена с `CWinApp::OnHelpIndex` .

Чтобы глобально переопределить базовые значения идентификатора по умолчанию (например, 0x10000 для команд и 0x20000 для ресурсов, таких как диалоговые окна), приложение должно переопределить метод [CWinApp:: WinHelp](../mfc/reference/cwinapp-class.md#winhelp).

Чтобы переопределить эту функциональность и способ определения контекста справки, следует обойти WM_COMMANDHELP сообщение. Вы можете указать более конкретную маршрутизацию справки, чем предоставляет платформа, так как в текущем дочернем окне MDI выполняется только глубокий уровень вложенности. Кроме того, может потребоваться предоставить более конкретную справку для конкретного окна или диалогового окна, возможно, на основе текущего внутреннего состояния этого объекта или активного элемента управления в диалоговом окне.

## <a name="wm_commandhelp"></a>WM_COMMANDHELP

```

afx_msg LRESULT CWnd::OnCommandHelp(WPARAM wParam, LPARAM lParam)
```

WM_COMMANDHELP является частным сообщением Windows MFC, которое получает активное окно при запросе справки. Когда окно получает это сообщение, оно может вызвать `CWinApp::WinHelp` контекст, соответствующий внутреннему состоянию окна.

*lParam*<br/>
Содержит контекст справки, доступный в настоящее время. значение *lParam* равно нулю, если контекст справки не определен. Реализация `OnCommandHelp` может использовать идентификатор контекста в *lParam* для определения другого контекста или просто передать его в `CWinApp::WinHelp` .

*wParam*<br/>
Не используется и будет равняться нулю.

Если `OnCommandHelp` функция вызывает `CWinApp::WinHelp` , она должна возвращать **значение true**. Возврат значения **true** останавливает маршрутизацию этой команды на другие классы и другие окна.

## <a name="help-mode-shiftf1-help"></a>Режим справки (Shift + Справка F1)

Это вторая форма контекстно-зависимой справки. Обычно этот режим осуществляется нажатием клавиш SHIFT + F1 или с помощью меню или панели инструментов. Он реализуется как команда (ID_CONTEXT_HELP). Обработчик фильтра сообщений не используется для преобразования этой команды в то время, когда модальное диалоговое окно или меню активно, поэтому эта команда доступна только пользователю, когда приложение исполняет основной конвейер сообщений ( `CWinApp::Run` ).

После ввода этого режима курсор мыши будет отображаться во всех областях приложения, даже если в приложении обычно отображается собственный курсор для этой области (например, граница изменения размера вокруг окна). Пользователь может использовать мышь или клавиатуру для выбора команды. Вместо выполнения команды отображается справка по этой команде. Кроме того, пользователь может щелкнуть видимый объект на экране, например кнопку на панели инструментов, и Справка будет отображаться для этого объекта. Этот режим справки предоставляется `CWinApp::OnContextHelp` .

Во время выполнения этого цикла все вводы с клавиатуры неактивны, за исключением ключей, обращающихся к меню. Кроме того, перевод команд по-прежнему выполняется с помощью, `PreTranslateMessage` позволяя пользователю нажать клавишу сочетания клавиш и получить справку по этой команде.

Если в функции выполняются определенные переводы или действия `PreTranslateMessage` , которые не должны выполняться во время смены и режима справки F1  , `CWinApp` перед выполнением этих операций следует проверить m_bHelpMode член. `CDialog`Реализация `PreTranslateMessage` проверяет это перед вызовом `IsDialogMessage` , например. Это отключает клавиши "навигации в диалоговом окне" в немодальных диалоговых окнах во время SHIFT + F1. Кроме того, в `CWinApp::OnIdle` этом цикле все еще вызывается.

Если пользователь выбирает команду из меню, он обрабатывается как Справка по этой команде (с помощью WM_COMMANDHELP см. ниже). Если пользователь щелкает видимую область окна приложения, выполняется определение того, является ли оно неклиентским щелчком мыши или щелчком клиента. `OnContextHelp` управляет автоматическим сопоставлением клиентов щелчками. Если щелкнуть Клиент, он отправляет WM_HELPHITTEST в окно, которое было выбрано. Если это окно возвращает ненулевое значение, это значение используется в качестве контекста для справки. Если он возвращает ноль, `OnContextHelp` то пытается выполнить родительское окно (и его неудачное завершение, его родительский элемент и т. д.). Если контекст справки определить нельзя, по умолчанию отправляется команда ID_DEFAULT_HELP в главное окно, которое затем (обычно) сопоставлено с `CWinApp::OnHelpIndex` .

## <a name="wm_helphittest"></a>WM_HELPHITTEST

```

afx_msg LRESULT CWnd::OnHelpHitTest(
WPARAM, LPARAM lParam)
```

WM_HELPHITTEST — это сообщение частного Windows в MFC, которое получает активное окно при нажатии клавиши SHIFT + F1 Help Mode. Когда окно получает это сообщение, оно возвращает идентификатор справки **DWORD** для использования средством WinHelp.

ЛОВОРД (lParam) содержит координату устройства оси X, в которой была нажата мышь относительно клиентской области окна.

HIWORD (lParam) содержит координаты оси Y.

*wParam*<br/>
не используется и будет равняться нулю. Если возвращаемое значение не равно нулю, то WinHelp вызывается с этим контекстом. Если возвращаемое значение равно нулю, то в родительском окне запрашивается справка.

Во многих случаях можно использовать код проверки попадания, который уже может быть создан. См `CToolBar::OnHelpHitTest` . Пример обработки сообщения WM_HELPHITTEST (код использует код проверки нажатия, используемый для кнопок и всплывающих подсказок в `CControlBar` ).

## <a name="mfc-application-wizard-support-and-makehm"></a>Поддержка мастера приложений MFC и МАКЕХМ

Мастер приложений MFC создает необходимые файлы для создания файла справки (CNT и HPJ-файлов). Он также включает ряд предварительно созданных RTF-файлов, которые принимаются компилятором справки Майкрософт. Многие из этих статей завершены, но для конкретного приложения их может потребоваться изменить.

Автоматическое создание файла "сопоставление справки" поддерживается служебной программой с именем МАКЕХМ. Служебная программа МАКЕХМ может перевести ресурс приложения. H-файл в файл сопоставления справки. Пример:

```
#define IDD_MY_DIALOG   2000
#define ID_MY_COMMAND   150
```

будет преобразован в:

```
HIDD_MY_DIALOG    0x207d0
HID_MY_COMMAND    0x10096
```

Этот формат совместим с механизмом компилятора справки, который сопоставляет идентификаторы контекста (числа с правой стороны) с именами разделов (символы в левой части).

Исходный код для МАКЕХМ доступен в примере [Макехм](../overview/visual-cpp-samples.md)программ программирования MFC.

## <a name="adding-help-support-after-running-the-mfc-application-wizard"></a>Добавление поддержки справки после запуска мастера приложений MFC

Лучший способ добавить справку в приложение — установить флажок "контекстно-зависимая справка" на странице "дополнительные компоненты" мастера приложений MFC перед созданием приложения. Таким образом мастер приложений MFC автоматически добавляет необходимые записи схемы сообщений в `CWinApp` класс, производный от, для поддержки справки.

## <a name="help-on-message-boxes"></a>Справка по окнам сообщений

Справка по окнам сообщений (иногда называемых предупреждениями) поддерживается через `AfxMessageBox` функцию — оболочку для `MessageBox` API Windows.

Существует две версии `AfxMessageBox` , одна для использования со СТРОКОВЫМ идентификатором и другая для использования с указателем на String ( `LPCSTR` ):

```
int AFXAPI AfxMessageBox(LPCSTR lpszText,
    UINT nType,
    UINT nIDHelp);

int AFXAPI AfxMessageBox(UINT nIDPrompt,
    UINT nType,
    UINT nIDHelp);
```

В обоих случаях имеется необязательный идентификатор справки.

В первом случае значение по умолчанию для Нидхелп равно 0, что означает отсутствие справки для этого окна сообщения. Если пользователь нажимает клавишу F1, так как окно сообщения активно, пользователь не сможет получить справку (даже если приложение поддерживает справку). Если это нежелательно, для Нидхелп необходимо указать идентификатор справки.

Во втором случае значение по умолчанию для Нидхелп равно-1, что означает, что идентификатор справки совпадает с Нидпромпт. Справка будет работать только в том случае, если приложение поддерживает поддержку, разумеется. Если вы хотите, чтобы окно сообщения не поддерживало справку, укажите 0 для Нидхелп. Если вы хотите, чтобы сообщение было включено, но ему нужен другой идентификатор справки, отличный от Нидпромпт, просто укажите положительное значение для Нидхелп, отличное от Нидпромпт.

## <a name="see-also"></a>См. также раздел

[Технические примечания по номеру](../mfc/technical-notes-by-number.md)<br/>
[Технические примечания по категориям](../mfc/technical-notes-by-category.md)
