---
title: Многостраничные документы
ms.date: 11/19/2018
helpviewer_keywords:
- pagination [MFC]
- overriding [MFC], View class functions for printing
- OnPrepareDC method [MFC]
- CPrintInfo structure [MFC], multipage documents
- OnEndPrinting method [MFC]
- protocols [MFC], printing protocol
- document pages vs. printer pages [MFC]
- printer mode [MFC]
- printing [MFC], multipage documents
- printers [MFC], printer mode
- documents [MFC], printing
- OnPreparePrinting method [MFC]
- OnPrint method [MFC]
- DoPreparePrinting method and pagination [MFC]
- OnDraw method [MFC], printing
- pagination [MFC], printing multipage documents
- printing [MFC], protocol
- pages [MFC], printing
- OnBeginPrinting method [MFC]
- multipage documents [MFC]
- printing [MFC], pagination
- documents [MFC], paginating
ms.assetid: 69626b86-73ac-4b74-b126-9955034835ef
ms.openlocfilehash: 87912c06a40740d25530235ee421c6c8bfa11aab
ms.sourcegitcommit: c123cc76bb2b6c5cde6f4c425ece420ac733bf70
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81370734"
---
# <a name="multipage-documents"></a>Многостраничные документы

В этой статье описывается протокол печати Windows и объясняется, как печатать документы, содержащие более одной страницы. Статья охватывает следующие темы:

- [Протокол печати](#_core_the_printing_protocol)

- [Функции класса переопределения представления](#_core_overriding_view_class_functions)

- [Пагинации](#_core_pagination)

- [Страницы принтера против страниц документов](#_core_printer_pages_vs.._document_pages)

- [Печать времени pagination](#_core_print.2d.time_pagination)

## <a name="the-printing-protocol"></a><a name="_core_the_printing_protocol"></a>Протокол печати

Для печати многостраничного документа фреймворк и представление взаимодействуют следующим образом. Сначала фреймворк отображает диалоговую коробку **Print,** создает контекст устройства для принтера и вызывает функцию члена [StartDoc](../mfc/reference/cdc-class.md#startdoc) объекта [CDC.](../mfc/reference/cdc-class.md) Затем для каждой страницы документа фреймворк вызывает `CDC` функцию элемента [Объекта На страницу участника StartPage,](../mfc/reference/cdc-class.md#startpage) инструктирует объект представления для печати страницы и вызывает функцию участника [EndPage.](../mfc/reference/cdc-class.md#endpage) Если режим принтера необходимо изменить перед запуском определенной страницы, представление вызывает [ResetDC,](../mfc/reference/cdc-class.md#resetdc)который обновляет структуру [DEVMODE,](/windows/win32/api/wingdi/ns-wingdi-devmodea) содержащую информацию о новом режиме принтера. Когда весь документ был напечатан, платформа называет функцию члена [EndDoc.](../mfc/reference/cdc-class.md#enddoc)

## <a name="overriding-view-class-functions"></a><a name="_core_overriding_view_class_functions"></a>Функции класса представления

Класс [CView](../mfc/reference/cview-class.md) определяет несколько функций-членов, которые вызываются фреймворкой во время печати. Переопределяя эти функции в классе представлений, вы предоставляете связи между логикой печати платформы и логикой печати класса представления. В следующей таблице перечислены эти функции членов.

### <a name="cviews-overridable-functions-for-printing"></a>CView в чрезмерной функции для печати

|Имя|Причина переопределения|
|----------|---------------------------|
|[OnPreparePrinting](../mfc/reference/cview-class.md#onprepareprinting)|Вставлять значения в диалоговую коробку Print, особенно длину документа|
|[OnBeginPrinting](../mfc/reference/cview-class.md#onbeginprinting)|Распределение шрифтов или других ресурсов GDI|
|[Onpreparedc](../mfc/reference/cview-class.md#onpreparedc)|Для настройки атрибутов контекста устройства для данной страницы или для проведения pagination в печатном времени|
|[Onprint](../mfc/reference/cview-class.md#onprint)|Печать данной страницы|
|[OnEndPrinting](../mfc/reference/cview-class.md#onendprinting)|Дераспределение ресурсов GDI|

Вы можете делать обработку, связанную с печатью, и в других функциях, но именно эти функции управляют процессом печати.

Следующая цифра иллюстрирует шаги, связанные с процессом `CView`печати, и показывает, где каждая из функций члена печати называется. В остальной части этой статьи более подробно описаны большинство этих шагов. Дополнительные части процесса печати описаны в статье [Распределение Ресурсов GDI](../mfc/allocating-gdi-resources.md).

![Процесс цикла печати](../mfc/media/vc37c71.gif "Процесс цикла печати") <br/>
Печатная петля

## <a name="pagination"></a><a name="_core_pagination"></a> Разбиение на страницы

В рамках этой структуры хранится большая часть информации о работе печати в структуре [CPrintInfo.](../mfc/reference/cprintinfo-structure.md) Некоторые из ценностей, `CPrintInfo` относящихся к pagination; эти значения доступны, как показано в следующей таблице.

### <a name="page-number-information-stored-in-cprintinfo"></a>Информация о номере страницы, хранящаяся в CPrintInfo

|Переменная участника или<br /><br /> имя функции (ы)|Номер страницы, на который ссылаются|
|-----------------------------------------------|----------------------------|
|`GetMinPage`/`SetMinPage`|Первая страница документа|
|`GetMaxPage`/`SetMaxPage`|Последняя страница документа|
|`GetFromPage`|Первая страница, которая будет напечатана|
|`GetToPage`|Последняя страница, которая будет напечатана|
|`m_nCurPage`|Страница, печатаемые в настоящее время|

Номера страниц начинаются с 1, то есть первая страница пронумерована 1, а не 0. Для получения дополнительной информации об этих и других членов [CPrintInfo](../mfc/reference/cprintinfo-structure.md), *см.*

В начале процесса печати фреймворк вызывает функцию члена [onPreparePrinting](../mfc/reference/cview-class.md#onprepareprinting) представления, передавая указатель на структуру. `CPrintInfo` Волшебник приложения обеспечивает `OnPreparePrinting` реализацию, что звонки [DoPreparePrinting](../mfc/reference/cview-class.md#doprepareprinting) `CView`, другой функции участника . `DoPreparePrinting`— это функция, которая отображает диалоговую коробку Print и создает контекст устройства принтера.

На данный момент приложение не знает, сколько страниц в документе. Он использует значения по умолчанию 1 и 0xFFFF для номеров первой и последней страницы документа. Если вы знаете, сколько страниц вашего документа, переопределить `OnPreparePrinting` и вызвать "SetMaxPage"---brokenlink--(ссылка / `CPrintInfo` cprintinfo-class.md'setmaxpage) для структуры, прежде чем отправить его `DoPreparePrinting`в . Это позволяет указать длину документа.

`DoPreparePrinting`затем отображает диалоговую коробку Print. Когда он возвращается, `CPrintInfo` структура содержит значения, указанные пользователем. Если пользователь желает распечатать только выбранный диапазон страниц, он может указать исходные и заканчивающиеся номера страниц в диалоговом поле Print. Платформа получает эти значения с `GetFromPage` `GetToPage` помощью и функций [CPrintInfo.](../mfc/reference/cprintinfo-structure.md) Если пользователь не указывает диапазон страниц, фреймворк вызывает `GetMinPage` и `GetMaxPage` использует значения, возвращенные для печати всего документа.

Для каждой страницы документа, подавённой, фреймворк вызывает две функции элемента в классе представлений, [OnPrepareDC](../mfc/reference/cview-class.md#onpreparedc) и `CPrintInfo` [OnPrint](../mfc/reference/cview-class.md#onprint)и передает каждому функции по двум параметрам: указатель на объект [CDC](../mfc/reference/cdc-class.md) и указатель на структуру. Каждый раз, `OnPrepareDC` `OnPrint`когда фреймворк вызывает и, `CPrintInfo` он проходит различное значение в *m_nCurPage* членструктуры. Таким образом, фреймворк сообщает представление, какая страница должна быть напечатана.

Функция члена [OnPrepareDC](../mfc/reference/cview-class.md#onpreparedc) также используется для отображения экрана. Он вносит коррективы в контекст устройства перед рисованием. `OnPrepareDC`выполняет аналогичную роль в печати, но есть несколько `CDC` отличий: во-первых, объект представляет контекст устройства `CPrintInfo` принтера вместо контекста устройства экрана, а во-вторых, объект передается как второй параметр. (Этот параметр `OnPrepareDC` **является NULL,** когда требуется для отображения экрана.) Переопределение `OnPrepareDC` для внесения коррективов в контекст устройства на основе того, какая страница печатается. Например, можно переместить происхождение порта представления и область отсечения, чтобы обеспечить печатание соответствующей части документа.

Функция участника [OnPrint](../mfc/reference/cview-class.md#onprint) выполняет фактическую печать страницы. В статье [«Как выполняется печать по умолчанию»,](../mfc/how-default-printing-is-done.md) показано, как фреймворк вызывает [OnDraw](../mfc/reference/cview-class.md#ondraw) с контекстом устройства принтера для выполнения печати. Точнее, `OnPrint` фреймворк `CPrintInfo` вызывает сявок `OnPrint` со структурой `OnDraw`и контекстом устройства, и передает контекст устройства в . Переопределение `OnPrint` для выполнения любых визуализаций, которые должны быть сделаны только во время печати, а не для отображения экрана. Например, для печати заголовки или колонтитулы (см. статью [заголовки и footers](../mfc/headers-and-footers.md) для получения дополнительной информации). Затем `OnDraw` вызов от переопределения `OnPrint` сделать рендеринг общим для отображения экрана и печати.

Тот факт, что рендеринг выполняется как для отображения экрана, так и для печати, означает, что ваше приложение является WYSIWYG: «То, что `OnDraw` вы видите, это то, что вы получаете». Однако предположим, что вы не пишете приложение WYSIWYG. Например, рассмотрим текстовый редактор, который использует жирный шрифт для печати, но отображает коды управления, чтобы указать жирный текст на экране. В такой ситуации вы `OnDraw` используете строго для отображения экрана. При переопределением `OnPrint`заменить `OnDraw` вызов на вызов отдельной функции чертежа. Эта функция рисует документ так, как он отображается на бумаге, используя атрибуты, которые не отображаются на экране.

## <a name="printer-pages-vs-document-pages"></a><a name="_core_printer_pages_vs.._document_pages"></a>Страницы принтеров против страниц документов

Когда вы ссылаетесь на номера страниц, иногда необходимо различать концепцию страницы принтера и концепцию страницы документа. С точки зрения принтера страница представляет собой один лист бумаги. Однако один лист бумаги не обязательно равен одной странице документа. Например, если вы печатаете бюллетень, где листы должны быть сложены, один лист бумаги может содержать как первую, так и последнюю страницы документа, бок о бок. Аналогичным образом, если вы печатаете электронную таблицу, документ вообще не состоит из страниц. Вместо этого один лист бумаги может содержать строки от 1 до 20, столбцы от 6 до 10.

Все номера страниц в структуре [CPrintInfo](../mfc/reference/cprintinfo-structure.md) относятся к страницам принтера. Рамки вызывает `OnPrepareDC` `OnPrint` и один раз для каждого листа бумаги, который будет проходить через принтер. При переопределении функции [OnPreparePrinting](../mfc/reference/cview-class.md#onprepareprinting) для указания длины документа необходимо использовать страницы принтера. Если есть один-к-одному корреспонденции (т.е. одна страница принтера равна одной странице документа), то это легко. Если, с другой стороны, страницы документов и страницы принтера напрямую не соответствуют, необходимо переводить между ними. Например, следует распечатать электронную таблицу. При переоценке `OnPreparePrinting`необходимо рассчитать, сколько листов бумаги потребуется для печати всей электронной таблицы, а затем использовать это значение при вызове `SetMaxPage` функции `CPrintInfo`участника. Аналогичным образом, `OnPrepareDC`при переопределениее необходимо перевести *m_nCurPage* в диапазон строк и столбцов, которые будут отображаться на этом конкретном листе, а затем соответствующим образом отрегулировать происхождение порта viewport.

## <a name="print-time-pagination"></a><a name="_core_print.2d.time_pagination"></a>Print-Time Pagination

В некоторых ситуациях класс представления может не знать заранее, сколько времени находится документ, пока он не будет напечатан. Например, предположим, что ваше приложение не является WYSIWYG, поэтому длина документа на экране не соответствует его длине при печати.

Это вызывает проблему при переопределение [onPreparePrinting](../mfc/reference/cview-class.md#onprepareprinting) для класса представления: вы не `SetMaxPage` можете передать значение функции структуры [CPrintInfo,](../mfc/reference/cprintinfo-structure.md) потому что вы не знаете длину документа. Если пользователь не указывает номер страницы, чтобы остановить использование диалогового окна печати, фреймворк не знает, когда остановить цикл печати. Единственный способ определить, когда остановить цикл печати, это распечатать документ и посмотреть, когда он закончится. Класс представления должен проверить конец документа во время его печати, а затем сообщить об этом в фреймворке, когда конец будет достигнут.

Платформа опирается на функцию [OnPrepareDC](../mfc/reference/cview-class.md#onpreparedc) класса представления, чтобы указывать ей, когда следует остановиться. После каждого `OnPrepareDC`звонка в фреймворк проверяет члена `CPrintInfo` структуры под названием *m_bContinuePrinting.* Его значение по умолчанию **является правдой.** До тех пор, пока она остается таковым, фреймворк продолжает цикл печати. Если он установлен на **FALSE,** фреймворк останавливается. Для выполнения pagination времени печати `OnPrepareDC` переудалите, чтобы проверить, был ли достигнут конец документа, и установите *m_bContinuePrinting* **FALSE,** когда он имеет.

Реализация наборов `OnPrepareDC` по умолчанию *m_bContinuePrinting* **FALSE,** если текущая страница превышает 1. Это означает, что если длина документа не была указана, то платформа предполагает, что длина документа составляет одну страницу. Одним из следствий этого является то, что вы `OnPrepareDC`должны быть осторожны, если вы называете версию базового класса . Не думайте, что *m_bContinuePrinting* будет **правдой** после вызова версии базового класса.

### <a name="what-do-you-want-to-know-more-about"></a>Что вы хотите узнать больше о

- [Заголовки и колонтитулы](../mfc/headers-and-footers.md)

- [Распределение ресурсов GDI](../mfc/allocating-gdi-resources.md)

## <a name="see-also"></a>См. также раздел

[Печати](../mfc/printing.md)<br/>
[Класс CView](../mfc/reference/cview-class.md)<br/>
[Класс CDC](../mfc/reference/cdc-class.md)
