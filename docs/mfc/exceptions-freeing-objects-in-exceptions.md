---
title: Исключения. Высвобождение объектов в исключениях
ms.date: 11/04/2016
helpviewer_keywords:
- throwing exceptions [MFC], freeing objects in exceptions
- local exception handling
- memory leaks, caused by exception
- try-catch exception handling [MFC], destroying objects
- destroying objects [MFC]
- freeing objects [MFC]
- throwing exceptions [MFC], after destroying
- exception handling [MFC], destroying objects
ms.assetid: 3b14b4ee-e789-4ed2-b8e3-984950441d97
ms.openlocfilehash: a02b71609ec19d6106153bf67e9d56b860cfdfff
ms.sourcegitcommit: 1f009ab0f2cc4a177f2d1353d5a38f164612bdb1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/27/2020
ms.locfileid: "87217939"
---
# <a name="exceptions-freeing-objects-in-exceptions"></a>Исключения. Высвобождение объектов в исключениях

В этой статье объясняется потребность и метод освобождения объектов при возникновении исключения. Будут рассмотрены следующие задачи:

- [Локальная обработка исключения](#_core_handling_the_exception_locally)

- [Создание исключений после уничтожения объектов](#_core_throwing_exceptions_after_destroying_objects)

Исключения, вызванные платформой или приложением, прерываются при нормальном потоке программы. Таким образом, очень важно продолжать отслеживание объектов, чтобы их можно было правильно удалить в случае возникновения исключения.

Это можно сделать двумя основными методами.

- Обрабатывайте исключения локально с **`try`** помощью **`catch`** ключевых слов и, затем удалите все объекты с помощью одной инструкции.

- Удалите любой объект в **`catch`** блоке перед вызовом исключения за пределами блока для дальнейшей обработки.

Эти два подхода иллюстрируются ниже как решения для следующего проблемного примера.

[!code-cpp[NVC_MFCExceptions#14](codesnippet/cpp/exceptions-freeing-objects-in-exceptions_1.cpp)]

Как написано выше, `myPerson` не будет удалено, если исключение порождается `SomeFunc` . Выполнение переходит непосредственно к следующему внешнему обработчику исключений, минуя нормальный выход функции и код, который удаляет объект. Указатель на объект выходит из области видимости, когда исключение выходит за пределы функции, и память, занятая объектом, никогда не будет восстановлена при условии, что программа выполняется. Это утечка памяти; Он будет обнаружен с помощью диагностики памяти.

## <a name="handling-the-exception-locally"></a><a name="_core_handling_the_exception_locally"></a>Локальная обработка исключения

Парадигма **try/catch** предоставляет защищенный программный метод для предотвращения утечек памяти и обеспечения уничтожения объектов при возникновении исключений. Например, пример, приведенный ранее в этой статье, можно перезаписать следующим образом:

[!code-cpp[NVC_MFCExceptions#15](codesnippet/cpp/exceptions-freeing-objects-in-exceptions_2.cpp)]

Этот новый пример настраивает обработчик исключений для перехвата исключения и его обработки локально. Затем функция выходит из функции в обычном режиме и уничтожает объект. Важным аспектом этого примера является то, что контекст для перехвата исключения устанавливается с блоками **try/catch** . Без локального фрейма исключений функция никогда не знала о том, что было создано исключение и у него нет возможности нормального выхода и уничтожения объекта.

## <a name="throwing-exceptions-after-destroying-objects"></a><a name="_core_throwing_exceptions_after_destroying_objects"></a>Создание исключений после уничтожения объектов

Другим способом обработки исключений является передача их в следующий внешний контекст обработки исключений. В своем **`catch`** блоке можно выполнить очистку локально выделенных объектов, а затем создать исключение для дальнейшей обработки.

Функция, вызывающая генерацию, может или не требовать освобождения объектов кучи. Если функция всегда освобождает объект кучи перед возвратом в обычном случае, функция должна также освободить объект кучи перед созданием исключения. С другой стороны, если функция обычно не освобождает объект перед возвратом в обычном случае, необходимо выбрать вариант в зависимости от того, следует ли освободить объект кучи.

В следующем примере показано, как можно очистить локально распределенные объекты:

[!code-cpp[NVC_MFCExceptions#16](codesnippet/cpp/exceptions-freeing-objects-in-exceptions_3.cpp)]

Механизм исключения автоматически освобождает объекты фрейма; также вызывается деструктор объекта Frame.

При вызове функций, которые могут вызывать исключения, можно использовать блоки **try/catch** , чтобы перехватить исключения и создать шанс уничтожить все созданные объекты. В частности, имейте в виду, что многие функции MFC могут создавать исключения.

Дополнительные сведения см. в разделе [исключения: перехват и удаление исключений](exceptions-catching-and-deleting-exceptions.md).

## <a name="see-also"></a>См. также раздел

[Обработка исключений](exception-handling-in-mfc.md)
