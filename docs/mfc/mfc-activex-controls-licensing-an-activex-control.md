---
title: Элементы управления ActiveX в MFC. Лицензирование элемента управления ActiveX
ms.date: 11/19/2018
helpviewer_keywords:
- COleObjectFactory class [MFC], licensing controls
- MFC ActiveX controls [MFC], licensing
- VerifyLicenseKey method [MFC]
- VerifyUserLicense method [MFC]
- GetLicenseKey method [MFC]
- licensing ActiveX controls
ms.assetid: cacd9e45-701a-4a1f-8f1f-b0b39f6ac303
ms.openlocfilehash: aaab4ae3bb13790784a66d53b41dbc3a7cdaec89
ms.sourcegitcommit: c123cc76bb2b6c5cde6f4c425ece420ac733bf70
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81364604"
---
# <a name="mfc-activex-controls-licensing-an-activex-control"></a>Элементы управления ActiveX в MFC. Лицензирование элемента управления ActiveX

Поддержка лицензирования, необязательная функция управления ActiveX, позволяет контролировать, кто может использовать или распространять элемент управления. (Для дополнительного обсуждения вопросов лицензирования см. [Upgrading an Existing ActiveX Control](../mfc/upgrading-an-existing-activex-control.md)

> [!IMPORTANT]
> ActiveX является устаревшей технологией, которая не должна использоваться для новых разработок. Для получения дополнительной информации о современных технологиях, которые заменяли ActiveX, [см.](activex-controls.md)

В этой статье рассматриваются следующие темы.

- [Обзор лицензирования управления ActiveX](#_core_overview_of_activex_control_licensing)

- [Создание лицензионного управления](#_core_creating_a_licensed_control)

- [Поддержка лицензирования](#_core_licensing_support)

- [Настройка лицензирования управления ActiveX](#_core_customizing_the_licensing_of_an_activex_control)

Элементы управления ActiveX, осуществляющие лицензирование, позволяют, как разработчику управления, определять, как другие люди будут использовать элемент управления ActiveX. Вы предоставляете покупателю управления элемент и . LIC файл, с соглашением, что покупатель может распространять элемент управления, но не . LIC файл, с приложением, которое использует элемент управления. Это не позволяет пользователям этого приложения писать новые приложения, которые используют элемент управления, без предварительного лицензирования управления от вас.

## <a name="overview-of-activex-control-licensing"></a><a name="_core_overview_of_activex_control_licensing"></a>Обзор лицензирования управления ActiveX

Для обеспечения поддержки лицензирования для элементов управления ActiveX класс [COleObjectFactory](../mfc/reference/coleobjectfactory-class.md) обеспечивает реализацию нескольких функций в `IClassFactory2` интерфейсе: `IClassFactory2::RequestLicKey` `IClassFactory2::GetLicInfo`, и `IClassFactory2::CreateInstanceLic`. Когда разработчик контейнерного приложения делает запрос на создание экземпляра `GetLicInfo` элемента управления, делается вызов для проверки того, что элемент управления. Файл LIC присутствует. Если элемент управления лицензирован, можно создать экземпляр элемента управления и поместить его в контейнер. После того, как разработчик закончил строительство контейнерного приложения, `RequestLicKey`другой вызов функции, на этот раз, сделан. Эта функция возвращает ключ лицензии (простую строку символов) в контейнерное приложение. Затем возвращенный ключ встраивается в приложение.

Приведенная ниже цифра демонстрирует проверку лицензии на элемент управления ActiveX, который будет использоваться при разработке контейнерного приложения. Как упоминалось ранее, разработчик контейнерных приложений должен иметь соответствующий. LIC файл, установленный на машине разработки для создания экземпляра управления.

![Лицензированный элемент управления ActiveX, проверяемый на этапе разработки](../mfc/media/vc374d1.gif "Лицензированный элемент управления ActiveX, проверяемый на этапе разработки") <br/>
Проверка лицензированного управления ActiveX во время разработки

Следующий процесс, показанный на следующем рисунке, происходит, когда конечный пользователь запускает контейнерное приложение.

При начале работы приложения обычно требуется создание экземпляра элемента управления. Контейнер выполняет это, делая `CreateInstanceLic`вызов, передавая встроенный ключ лицензии в качестве параметра. Сравнение строки производится между встроенным ключом лицензии и собственной копией ключа лицензии. Если матч выполнен успешно, создается экземпляр элемента управления и приложение продолжает выполняться в обычном режиме. Обратите внимание, что . LIC файл не должен присутствовать на машине пользователя управления.

![Лицензированный элемент управления ActiveX, проверяемый на этапе выполнения](../mfc/media/vc374d2.gif "Лицензированный элемент управления ActiveX, проверяемый на этапе выполнения") <br/>
Проверка лицензированного управления ActiveX во время выполнения

Лицензирование управления состоит из двух основных компонентов: специфического кода в реализации управления DLL и лицензионного файла. Код состоит из двух (или, возможно, трех) вызовов функций и строки символов, которая в дальнейшем называется «лицензионной строкой», содержащей уведомление об авторском праве. Эти вызовы и строка лицензии находятся в реализации управления (. CPP) файл. Лицензионный файл, созданный Мастером управления ActiveX, представляет собой текстовый файл с заявлением об авторском праве. Он называется с использованием названия проекта с . Расширение LIC, например SAMPLE. Lic. Лицензированный контроль должен сопровождаться файлом лицензии, если требуется использование времени проектирования.

## <a name="creating-a-licensed-control"></a><a name="_core_creating_a_licensed_control"></a>Создание лицензионного управления

При использовании ActiveX Control Wizard для создания системы управления легко включить поддержку лицензирования. Когда вы указываете, что элемент управления должен иметь лицензию времени выполнения, мастер управления ActiveX добавляет код в класс управления для поддержки лицензирования. Код состоит из функций, которые используют ключ и файл лицензии для проверки лицензии. Эти функции также могут быть изменены для настройки лицензирования управления. Для получения дополнительной информации [Customizing the Licensing of an ActiveX Control](#_core_customizing_the_licensing_of_an_activex_control) о настройке лицензии см.

#### <a name="to-add-support-for-licensing-with-the-activex-control-wizard-when-you-create-your-control-project"></a>Добавление поддержки лицензирования с помощью Мастера управления ActiveX при создании проекта управления

1. Используйте инструкции при [создании MFC ActiveX Control.](../mfc/reference/creating-an-mfc-activex-control.md) Страница **Настроек приложений** мастера управления ActiveX содержит возможность создания элемента управления с лицензией времени выполнения.

Мастер управления ActiveX теперь создает систему управления ActiveX, которая включает базовую поддержку лицензирования. Подробное объяснение кода лицензирования можно просмотреть следующую тему.

## <a name="licensing-support"></a><a name="_core_licensing_support"></a>Поддержка лицензирования

При использовании ActiveX Control Wizard для добавления поддержки лицензирования в элемент управления ActiveX мастер управления ActiveX добавляет код, который объявляет и реализует возможность лицензирования, добавляется в файлы управления и реализации. Этот код состоит `VerifyUserLicense` из функции `GetLicenseKey` участника и функции участника, которые переопределяют реализации по умолчанию, найденные в [COleObjectFactory.](../mfc/reference/coleobjectfactory-class.md) Эти функции извлекают и проверяют лицензию управления.

> [!NOTE]
> Функция третьего `VerifyLicenseKey` члена не генерируется мастером управления ActiveX, но может быть перекрыта для настройки поведения проверки ключа лицензии.

Эти функции члена:

- [VerifyUserLicense](../mfc/reference/coleobjectfactory-class.md#verifyuserlicense)

   Проверяет, что элемент управления позволяет использовать время проектирования, проверяя систему на наличие файла лицензии управления. Эта функция вызывается фреймворкой как часть обработки `IClassFactory2::GetLicInfo` и `IClassFactory::CreateInstanceLic`.

- [GetLicenseKey](../mfc/reference/coleobjectfactory-class.md#getlicensekey)

   Запрашивает уникальный ключ от управления DLL. Этот ключ встроен в контейнерное приложение `VerifyLicenseKey`и используется позже, в сочетании с, для создания экземпляра управления. Эта функция вызывается фреймворкой как часть обработки. `IClassFactory2::RequestLicKey`

- [VerifyLicenseKey](../mfc/reference/coleobjectfactory-class.md#verifylicensekey)

   Проверяет, что встроенный ключ и уникальный ключ элемента управления одинаковы. Это позволяет контейнеру создать экземпляр элемента управления для его использования. Эта функция называется фреймворком как часть обработки `IClassFactory2::CreateInstanceLic` и может быть отменена, чтобы обеспечить индивидуальную проверку ключа лицензии. Реализация по умолчанию выполняет сравнение строк. Для получения дополнительной информации, [см Настройка Лицензирование ActiveX управления](#_core_customizing_the_licensing_of_an_activex_control), позже в этой статье.

### <a name="header-file-modifications"></a><a name="_core_header_file_modifications"></a>Модификации файлов заголовка

Мастер управления ActiveX помещает следующий код в файл заголовка управления. В этом примере объявляются две функции `CSampleCtrl`элемента объекта's, `factory` одна из них проверяет наличие элемента управления. LIC файл и другой, который получает ключ лицензии, который будет использоваться в приложении, содержащем элемент управления:

[!code-cpp[NVC_MFC_AxUI#39](../mfc/codesnippet/cpp/mfc-activex-controls-licensing-an-activex-control_1.h)]

### <a name="implementation-file-modifications"></a><a name="_core_implementation_file_modifications"></a>Модификации файлов реализации

Мастер управления ActiveX помещает следующие две инструкции в файл реализации элемента управления, чтобы объявить имя файла лицензии и строку лицензии:

[!code-cpp[NVC_MFC_AxUI#40](../mfc/codesnippet/cpp/mfc-activex-controls-licensing-an-activex-control_2.cpp)]

> [!NOTE]
> Если вы `szLicString` каким-либо образом измените, необходимо также изменить первую строку в элементе управления. LIC файл или лицензирование не будет функционировать должным образом.

Мастер управления ActiveX помещает следующий код в файл реализации `VerifyUserLicense` `GetLicenseKey` элемента управления для определения класса управления и функций:

[!code-cpp[NVC_MFC_AxUI#41](../mfc/codesnippet/cpp/mfc-activex-controls-licensing-an-activex-control_3.cpp)]

Наконец, **Мастер управления ActiveX** изменяет проект управления. IdL файл. **Лицензированное** ключевое слово добавляется в кодирование совместного класса элемента управления, как в следующем примере:

[!code-cpp[NVC_MFC_AxUI#42](../mfc/codesnippet/cpp/mfc-activex-controls-licensing-an-activex-control_4.idl)]

## <a name="customizing-the-licensing-of-an-activex-control"></a><a name="_core_customizing_the_licensing_of_an_activex_control"></a>Настройка лицензирования управления ActiveX

Потому что, `VerifyUserLicense` `GetLicenseKey`и `VerifyLicenseKey` объявлены в качестве виртуальных функций члена класса фабрики управления, вы можете настроить лицензирование поведения управления.

Например, можно предоставить несколько уровней лицензирования `VerifyLicenseKey` для управления, переопределив функции или функции `VerifyUserLicense` члена. Внутри этой функции можно настроить, какие свойства или методы подвергаются пользователю в зависимости от обнаруженного уровня лицензии.

Вы также можете добавить код в функцию, `VerifyLicenseKey` которая обеспечивает индивидуальный метод для информирования пользователя о том, что создание элемента управления не удалось. Например, в `VerifyLicenseKey` функции участника можно отобразить поле сообщений, в котором говорится, что элемент управления не удалось инициализировать и почему.

> [!NOTE]
> Еще один способ настроить проверку лицензии управления ActiveX — проверить базу `AfxVerifyLicFile`данных регистрации на наличие определенного ключа реестра, а не вызова. На примере реализации по умолчанию смотрите раздел [изменений файлов реализации](#_core_implementation_file_modifications) в этой статье.

Для дополнительного обсуждения вопросов лицензирования см. [Upgrading an Existing ActiveX Control](../mfc/upgrading-an-existing-activex-control.md)

## <a name="see-also"></a>См. также раздел

[Элементы ActiveX библиотеки MFC](../mfc/mfc-activex-controls.md)<br/>
[Мастер управления MFC ActiveX](../mfc/reference/mfc-activex-control-wizard.md)
