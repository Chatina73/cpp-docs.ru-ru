---
description: Дополнительные сведения об элементах управления ActiveX в MFC. Лицензирование элемента управления ActiveX
title: Элементы управления ActiveX в MFC. Лицензирование элемента управления ActiveX
ms.date: 11/19/2018
helpviewer_keywords:
- COleObjectFactory class [MFC], licensing controls
- MFC ActiveX controls [MFC], licensing
- VerifyLicenseKey method [MFC]
- VerifyUserLicense method [MFC]
- GetLicenseKey method [MFC]
- licensing ActiveX controls
ms.assetid: cacd9e45-701a-4a1f-8f1f-b0b39f6ac303
ms.openlocfilehash: cf7b797ecfd7ae19af7c922443850d115b4cc2b3
ms.sourcegitcommit: d6af41e42699628c3e2e6063ec7b03931a49a098
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2020
ms.locfileid: "97341598"
---
# <a name="mfc-activex-controls-licensing-an-activex-control"></a>Элементы управления ActiveX в MFC. Лицензирование элемента управления ActiveX

Поддержка лицензирования, Необязательная функция элементов управления ActiveX, позволяет контролировать, кто может использовать или распространять элемент управления. (Дополнительные сведения о проблемах лицензирования см. в статье вопросы лицензирования при [обновлении существующего элемента управления ActiveX](upgrading-an-existing-activex-control.md).)

> [!IMPORTANT]
> ActiveX — это устаревшая технология, которую не следует использовать для новой разработки. Дополнительные сведения о современных технологиях, которые заменяют ActiveX, см. в разделе [элементы управления ActiveX](activex-controls.md).

Темы этой статьи:

- [Общие сведения о лицензировании элементов управления ActiveX](#_core_overview_of_activex_control_licensing)

- [Создание лицензированного элемента управления](#_core_creating_a_licensed_control)

- [Поддержка лицензирования](#_core_licensing_support)

- [Настройка лицензирования элемента управления ActiveX](#_core_customizing_the_licensing_of_an_activex_control)

Элементы управления ActiveX, реализующие лицензирование, позволяют разработчику элемента управления определить, как другие пользователи будут использовать элемент управления ActiveX. Покупатель элемента управления предоставляет элемент управления и. LIC файл с соглашением, которое покупатель может распространить на элемент управления, но не на. LIC файл с приложением, использующим элемент управления. Это предотвращает создание пользователями этого приложения новых приложений, использующих этот элемент управления, без предварительного лицензирования элемента управления.

## <a name="overview-of-activex-control-licensing"></a><a name="_core_overview_of_activex_control_licensing"></a> Общие сведения о лицензировании элементов управления ActiveX

Чтобы обеспечить поддержку лицензирования для элементов управления ActiveX, класс [COleObjectFactory](reference/coleobjectfactory-class.md) предоставляет реализацию для нескольких функций в `IClassFactory2` интерфейсе: `IClassFactory2::RequestLicKey` , `IClassFactory2::GetLicInfo` и `IClassFactory2::CreateInstanceLic` . Когда разработчик приложения-контейнера выполняет запрос на создание экземпляра элемента управления, выполняется вызов для `GetLicInfo` проверки того, что элемент управления. Файл LIC находится в наличии. Если элемент управления лицензирован, экземпляр элемента управления может быть создан и помещен в контейнер. После того как разработчик завершит создание приложения-контейнера, выполняется другой вызов функции, на этот раз `RequestLicKey` . Эта функция возвращает в приложение-контейнер ключ лицензии (простую строку символов). Затем возвращаемый ключ внедряется в приложение.

На рисунке ниже показана проверка лицензии элемента управления ActiveX, который будет использоваться во время разработки приложения-контейнера. Как упоминалось ранее, разработчик приложения контейнера должен иметь правильное значение. Файл LIC, установленный на компьютере разработки для создания экземпляра элемента управления.

![Лицензированный элемент управления ActiveX, проверяемый на этапе разработки](../mfc/media/vc374d1.gif "Лицензированный элемент управления ActiveX, проверяемый на этапе разработки") <br/>
Проверка лицензированного элемента управления ActiveX во время разработки

Следующий процесс, показанный на следующем рисунке, происходит, когда конечный пользователь запускает приложение контейнера.

При запуске приложения обычно требуется создать экземпляр элемента управления. Контейнер выполняет эту задачу, выполняя вызов `CreateInstanceLic` , передавая внедренный лицензионный ключ в качестве параметра. Затем между внедренным лицензионным ключом и собственной копией лицензионного ключа выполняется сравнение строк. Если сопоставление выполнено успешно, создается экземпляр элемента управления, и приложение продолжит выполнение в обычном режиме. Обратите внимание, что. Файл LIC не должен присутствовать на компьютере пользователя управления.

![Лицензированный элемент управления ActiveX, проверяемый на этапе выполнения](../mfc/media/vc374d2.gif "Лицензированный элемент управления ActiveX, проверяемый на этапе выполнения") <br/>
Проверка лицензированного элемента управления ActiveX во время выполнения

Лицензирование элементов управления состоит из двух основных компонентов: конкретного кода в библиотеке DLL реализации элемента управления и файла лицензии. Код состоит из двух (или, возможно, трех) вызовов функций и строки символов, которая в дальнейшем называется «строкой лицензии», содержащей уведомление об авторских правах. Эти вызовы и строка лицензии находятся в реализации элемента управления (. CPP). Файл лицензии, созданный мастером элементов управления ActiveX, является текстовым файлом с заявлением об авторских правах. Он называется именем проекта с именем. Расширение LIC, например SAMPLE. LIC. Лицензированный элемент управления должен сопровождаться файлом лицензии, если требуется использование времени разработки.

## <a name="creating-a-licensed-control"></a><a name="_core_creating_a_licensed_control"></a> Создание лицензированного элемента управления

При использовании мастера элементов управления ActiveX для создания платформы элементов управления можно легко включить поддержку лицензирования. Если указать, что элемент управления должен иметь лицензию времени выполнения, мастер элементов управления ActiveX добавляет код в класс Control для поддержки лицензирования. Код состоит из функций, использующих ключ и файл лицензии для проверки лицензий. Эти функции также можно изменить, чтобы настроить лицензирование элементов управления. Дополнительные сведения о настройке лицензий см. в разделе [Настройка лицензирования элемента управления ActiveX](#_core_customizing_the_licensing_of_an_activex_control) далее в этой статье.

#### <a name="to-add-support-for-licensing-with-the-activex-control-wizard-when-you-create-your-control-project"></a>Добавление поддержки лицензирования с помощью мастера элементов управления ActiveX при создании проекта элемента управления

1. Используйте инструкции по [созданию элемента управления ACTIVEX MFC](reference/creating-an-mfc-activex-control.md). Страница **Параметры приложения** в мастере элементов управления ActiveX содержит параметр для создания элемента управления с лицензией времени выполнения.

Мастер элементов управления ActiveX теперь создает платформу элементов управления ActiveX, которая включает базовую поддержку лицензирования. Подробное описание кода лицензирования см. в следующем разделе.

## <a name="licensing-support"></a><a name="_core_licensing_support"></a> Поддержка лицензирования

При использовании мастера элементов ActiveX для добавления поддержки лицензирования в элемент управления ActiveX мастер элементов управления ActiveX добавляет код, который объявляет и реализует возможность лицензирования, добавляется в заголовок элемента управления и файлы реализации. Этот код состоит из функции- `VerifyUserLicense` члена и функции- `GetLicenseKey` члена, которая переопределяет реализации по умолчанию, найденные в [COleObjectFactory](reference/coleobjectfactory-class.md) . Эти функции извлекают и проверяют лицензию на управление.

> [!NOTE]
> Третья функция `VerifyLicenseKey` -член не создается мастером элементов управления ActiveX, но может быть переопределена для настройки поведения проверки лицензионного ключа.

Эти функции элементов:

- [верифюсерлиценсе](reference/coleobjectfactory-class.md#verifyuserlicense)

   Проверяет, допускает ли элемент управления использование времени разработки, проверяя систему на наличие файла лицензии элемента управления. Эта функция вызывается платформой в процессе обработки `IClassFactory2::GetLicInfo` и `IClassFactory::CreateInstanceLic` .

- [жетлиценсекэй](reference/coleobjectfactory-class.md#getlicensekey)

   Запрашивает уникальный ключ из библиотеки DLL элемента управления. Этот ключ внедряется в приложение-контейнер и используется позднее, в сочетании с `VerifyLicenseKey` , для создания экземпляра элемента управления. Эта функция вызывается платформой в процессе обработки `IClassFactory2::RequestLicKey` .

- [верифилиценсекэй](reference/coleobjectfactory-class.md#verifylicensekey)

   Проверяет, что внедренный ключ и уникальный ключ элемента управления одинаковы. Это позволяет контейнеру создать экземпляр элемента управления для его использования. Эта функция вызывается платформой в процессе обработки `IClassFactory2::CreateInstanceLic` и может быть переопределена для предоставления настраиваемой проверки лицензионного ключа. Реализация по умолчанию выполняет сравнение строк. Дополнительные сведения см. в подразделе [Настройка лицензирования элемента управления ActiveX](#_core_customizing_the_licensing_of_an_activex_control)далее в этой статье.

### <a name="header-file-modifications"></a><a name="_core_header_file_modifications"></a> Изменения в файле заголовка

Мастер элементов управления ActiveX помещает следующий код в файл заголовка элемента управления. В этом примере объявляются две функции члена `CSampleCtrl` объекта `factory` , одна из которых проверяет наличие элемента управления. LIC File и другой, который извлекает лицензионный ключ, который будет использоваться в приложении, содержащем элемент управления:

[!code-cpp[NVC_MFC_AxUI#39](codesnippet/cpp/mfc-activex-controls-licensing-an-activex-control_1.h)]

### <a name="implementation-file-modifications"></a><a name="_core_implementation_file_modifications"></a> Изменения файла реализации

Мастер элементов управления ActiveX помещает следующие две инструкции в файл реализации элемента управления, чтобы объявить имя файла лицензии и строку лицензии:

[!code-cpp[NVC_MFC_AxUI#40](codesnippet/cpp/mfc-activex-controls-licensing-an-activex-control_2.cpp)]

> [!NOTE]
> При изменении `szLicString` в любом случае необходимо также изменить первую строку в элементе управления. LIC файл или лицензирование будет работать неправильно.

Мастер элементов управления ActiveX помещает следующий код в файл реализации элемента управления для определения класса элемента управления `VerifyUserLicense` и `GetLicenseKey` функций:

[!code-cpp[NVC_MFC_AxUI#41](codesnippet/cpp/mfc-activex-controls-licensing-an-activex-control_3.cpp)]

Наконец, **Мастер элементов управления ActiveX** изменяет проект элемента управления. IDL-файл. Ключевое слово **Licensed** добавляется в объявление кокласса элемента управления, как показано в следующем примере:

[!code-cpp[NVC_MFC_AxUI#42](codesnippet/cpp/mfc-activex-controls-licensing-an-activex-control_4.idl)]

## <a name="customizing-the-licensing-of-an-activex-control"></a><a name="_core_customizing_the_licensing_of_an_activex_control"></a> Настройка лицензирования элемента управления ActiveX

Поскольку `VerifyUserLicense` , `GetLicenseKey` и `VerifyLicenseKey` объявляются как виртуальные функции-члены класса фабрики элементов управления, можно настроить поведение при лицензировании элемента управления.

Например, можно предоставить несколько уровней лицензирования для элемента управления, переопределив `VerifyUserLicense` `VerifyLicenseKey` функции члена или. Внутри этой функции можно настроить, какие свойства или методы предоставляются пользователю в соответствии с обнаруженным уровнем лицензии.

Можно также добавить в `VerifyLicenseKey` функцию код, который предоставляет настраиваемый метод для формирования пользователем неудачного создания элемента управления. Например, в функции- `VerifyLicenseKey` члене можно отобразить окно сообщения о том, что не удалось инициализировать элемент управления и почему.

> [!NOTE]
> Другим способом настройки проверки лицензии элемента управления ActiveX является проверка базы данных регистрации на наличие определенного раздела реестра вместо вызова `AfxVerifyLicFile` . Пример реализации по умолчанию см. в разделе [Реализация модификаций файла](#_core_implementation_file_modifications) этой статьи.

Дополнительные сведения о проблемах лицензирования см. в статье вопросы лицензирования при [обновлении существующего элемента управления ActiveX](upgrading-an-existing-activex-control.md).

## <a name="see-also"></a>См. также раздел

[Элементы управления ActiveX в MFC](mfc-activex-controls.md)<br/>
[Мастер элементов ActiveX MFC](reference/mfc-activex-control-wizard.md)
