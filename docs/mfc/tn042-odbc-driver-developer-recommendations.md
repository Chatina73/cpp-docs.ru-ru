---
description: 'Дополнительные сведения о: TN042: рекомендации для разработчиков драйверов ODBC'
title: TN042. Рекомендации по драйверу ODBC для разработчиков
ms.date: 11/04/2016
f1_keywords:
- vc.odbc
helpviewer_keywords:
- ODBC drivers [MFC], writing
- databases [MFC], ODBC
- TN042
ms.assetid: ecc6b5d9-f480-4582-9e22-8309fe561dad
ms.openlocfilehash: 896c99ffeba98f1ea38771676475c85abf13d983
ms.sourcegitcommit: d6af41e42699628c3e2e6063ec7b03931a49a098
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2020
ms.locfileid: "97215304"
---
# <a name="tn042-odbc-driver-developer-recommendations"></a>TN042. Рекомендации по драйверу ODBC для разработчиков

> [!NOTE]
> Следующее техническое примечание не было обновлено, поскольку сначала оно было включено в электронную документацию. В результате некоторые процедуры и разделы могут быть устаревшими или неверными. Для получения последних сведений рекомендуется выполнить поиск интересующей темы в алфавитном указателе документации в Интернете.

Это примечание описывает рекомендации для модулей записи драйвера ODBC. В нем описываются общие требования и предположения функций ODBC, создаваемых классами базы данных MFC, и различные ожидаемые семантические сведения. Ниже описаны необходимые функции драйвера для поддержки трех `CRecordset` открытых режимов (**форвардонли**, **snapshot** и **динамический** набор).

## <a name="odbcs-cursor-library"></a>Библиотека курсоров ODBC

Классы баз данных MFC предоставляют пользователю функциональные возможности, которые в большинстве случаев превосходят функциональные возможности, предоставляемые большинством драйверов ODBC уровня 1. К счастью, Библиотека курсоров ODBC будет иметь сам слой между классами базы данных и драйвером и автоматически предоставит большую часть этих дополнительных функций.

Например, большинство драйверов 1,0 не поддерживает обратную прокрутку. Библиотека курсоров может обнаружить это, и будет кэшировать строки из драйвера и предоставлять их в соответствии с запросом FETCH_PREV вызовах в `SQLExtendedFetch` .

Еще один важный пример зависимостей библиотеки курсоров — позиционированные обновления. Большинство драйверов 1,0 также не имеют позиционированных обновлений, но библиотека курсоров формирует инструкции UPDATE, которые указывают целевую строку в источнике данных на основе текущих значений кэшированных данных или кэшированного значения timestamp.

Библиотека классов никогда не использует несколько наборов строк. Поэтому несколько `SQLSetPos` инструкций всегда применяются к строке 1 набора строк.

## <a name="cdatabases"></a>CDatabase

Каждый `CDatabase` из них выделяет один **хдбк**. (Если `CDatabase` `ExecuteSQL` используется функция, **хстмт** временно выделяется.) Поэтому, если `CDatabase` требуется несколько объектов, необходимо поддерживать несколько **хдбк** s на **хенв** .

Для классов баз данных требуется библиотека курсоров. Это отражено в `SQLSetConnections` вызове **SQL_ODBC_CURSORS** **SQL_CUR_USE_ODBC**.

`SQLDriverConnect`, **SQL_DRIVER_COMPLETE** используется `CDatabase::Open` для установления соединения с источником данных.

Драйвер должен поддерживать `SQLGetInfo SQL_ODBC_API_CONFORMANCE`  >=  **SQL_OAC_LEVEL1**, `SQLGetInfo SQL_ODBC_SQL_CONFORMANCE`  >=  **SQL_OSC_MINIMUM**.

Чтобы транзакции поддерживались для `CDatabase` и зависимых от нее наборов записей, `SQLGetInfo SQL_CURSOR_COMMIT_BEHAVIOR` а **SQL_CURSOR_ROLLBACK_BEHAVIOR** должны иметь **SQL_CR_PRESERVE**. В противном случае попытки выполнить управление транзакциями будут проигнорированы.

`SQLGetInfo SQL_DATA_SOURCE_READ_ONLY` должен поддерживаться. Если возвращается значение "Y", операции обновления для источника данных выполняться не будут.

Если объект `CDatabase` открыт только для чтения, попытка установить источник данных будет выполнена с помощью `SQLSetConnectOption SQL_ACCESS_MODE` , **SQL_MODE_READ_ONLY**.

Если идентификаторы требуются для заключения в кавычки, эти сведения должны возвращаться из драйвера с помощью `SQLGetInfo SQL_IDENTIFIER_QUOTE_CHAR` вызова.

Для целей отладки `SQLGetInfo SQL_DBMS_VER` и **SQL_DBMS_NAME** извлекаются из драйвера.

`SQLSetStmtOption SQL_QUERY_TIMEOUT` и **SQL_ASYNC_ENABLE** могут вызываться в `CDatabase` **хдбк**.

`SQLError` может вызываться с любым или любыми аргументами NULL.

Разумеется,, `SQLAllocEnv` `SQLAllocConnect` `SQLDisconnect` и `SQLFreeConnect` должны поддерживаться.

## <a name="executesql"></a>ExecuteSQL

Помимо выделения и освобождения временного **хстмт**, `ExecuteSQL` вызывает `SQLExecDirect` , `SQLFetch` `SQLNumResultCol` и `SQLMoreResults` . `SQLCancel` может вызываться для **хстмт**.

## <a name="getdatabasename"></a>GetDatabaseName

`SQLGetInfo SQL_DATABASE_NAME` будет вызван.

## <a name="begintrans-committrans-rollback"></a>Примеры BeginTrans, CommitTrans, откат

`SQLSetConnectOption SQL_AUTOCOMMIT` и `SQLTransact SQL_COMMIT` **SQL_ROLLBACK** и **SQL_AUTOCOMMIT** будут вызываться, если выполняются запросы транзакций.

## <a name="crecordsets"></a>CRecordsets

`SQLAllocStmt``SQLPrepare` `SQLExecute` Должны поддерживаться,, (для `Open` и `Requery` ), `SQLExecDirect` (для операций обновления) `SQLFreeStmt` . `SQLNumResultCols` и `SQLDescribeCol` будут вызываться для набора результатов в различные моменты времени.

`SQLSetParam` широко используется для привязки данных параметров и **DATA_AT_EXEC** функциональных возможностей.

`SQLBindCol` используется для регистрации места хранения данных выходного столбца в ODBC.

`SQLGetData`Для получения **SQL_LONG_VARCHAR** и **SQL_LONG_VARBINARY** данных используются два вызова. Первый вызов пытается найти общую длину значения столбца путем вызова `SQLGetData` с параметром кбмаксвалуе, равным 0, но с допустимым пкбвалуе. Если Пкбвалуе содержит **SQL_NO_TOTAL**, возникает исключение. В противном случае выделяется **хглобал** , и `SQLGetData` выполняется другой вызов для получения всего результата.

## <a name="updating"></a>Обновление

При запросе пессимистической блокировки будет выполнен `SQLGetInfo SQL_LOCK_TYPES` запрос. Если **SQL_LCK_EXCLUSIVE** не поддерживается, будет выдано исключение.

Попытка обновить `CRecordset` (**моментальный снимок** или **динамический** набор) приведет к выделению второго **хстмт** . Для драйверов, которые не поддерживают вторую **хстмт**, Библиотека курсоров имитирует эту функциональность. К сожалению, это иногда может означать принудительное выполнение текущего запроса на первом **хстмт** перед обработкой запроса второго **хстмт**.

`SQLFreeStmt SQL_CLOSE` и **SQL_RESET_PARAMS** и `SQLGetCursorName` будут вызываться во время операций обновления.

Если в **аутпутколумнс** есть **клонгбинарис** , должны поддерживаться функции **DATA_AT_EXEC** ODBC. Сюда входит возврат **SQL_NEED_DATA** из `SQLExecDirect` , `SQLParamData` и `SQLPutData` .

`SQLRowCount` вызывается после выполнения, чтобы убедиться, что обновлена только одна запись `SQLExecDirect` .

## <a name="forwardonly-cursors"></a>Форвардонли курсоры

`SQLFetch`Для операций требуется только `Move` . Обратите внимание, что **форвардонли** курсоры не поддерживают обновления.

## <a name="snapshot-cursors"></a>Курсоры моментальных снимков

Для работы с моментальными снимками требуется `SQLExtendedFetch` поддержка. Как отмечалось выше, Библиотека курсоров ODBC обнаружит, что драйвер не поддерживает `SQLExtendedFetch` , и предоставьте необходимую поддержку.

`SQLGetInfo`**SQL_SCROLL_OPTIONS** должны поддерживать **SQL_SO_STATIC**.

## <a name="dynaset-cursors"></a>Курсоры динамического набора

Ниже приведена минимальная поддержка, необходимая для открытия динамического набора:

`SQLGetInfo`**SQL_ODBC_VER** должен возвращать > «01».

`SQLGetInfo`**SQL_SCROLL_OPTIONS** должны поддерживать **SQL_SO_KEYSET_DRIVEN**.

`SQLGetInfo`, **SQL_ROW_UPDATES** должен возвращать "Y".

`SQLGetInfo`**SQL_POSITIONED_UPDATES** должны поддерживать **SQL_PS_POSITIONED_DELETE** и **SQL_PS_POSITIONED_UPDATE**.

Кроме того, если запрашивается Пессимистическая блокировка, `SQLSetPos` будет выполнен вызов с параметром IRow 1, ФРЕФРЕШ false и флокк **SQL_LCK_EXCLUSIVE** .

## <a name="see-also"></a>См. также раздел

[Технические примечания по номеру](../mfc/technical-notes-by-number.md)<br/>
[Технические примечания по категориям](../mfc/technical-notes-by-category.md)
