---
title: Архитектура предварительного просмотра
ms.date: 11/04/2016
helpviewer_keywords:
- print preview [MFC], process
- previewing printing
- print preview [MFC], architecture
- printing [MFC], print preview
- print preview [MFC], modifications to MFC
ms.assetid: 0efc87e6-ff8d-43c5-9d72-9b729a169115
ms.openlocfilehash: 1956313d4e904255ba59e79690fe3d7144669a29
ms.sourcegitcommit: c21b05042debc97d14875e019ee9d698691ffc0b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/09/2020
ms.locfileid: "84623941"
---
# <a name="print-preview-architecture"></a>Архитектура предварительного просмотра

В этой статье объясняется, как платформа MFC реализует функцию предварительной версии для печати. Здесь рассматриваются такие темы:

- [Процесс предварительного просмотра](#_core_the_print_preview_process)

- [Изменение предварительного просмотра печати](#_core_modifying_print_preview)

Режим предварительного просмотра не отличается от отображения экрана и печати, поскольку вместо непосредственного рисования изображения на устройстве приложение должно имитировать принтер с помощью экрана. Для этого библиотека Microsoft Foundation Class определяет специальный (недокументированный) класс, производный от [класса CDC](reference/cdc-class.md), который называется `CPreviewDC` . Все `CDC` объекты содержат два контекста устройств, но обычно они идентичны. В `CPreviewDC` объекте они отличаются: первый представляет моделируемый принтер, а второй — экран, на котором на самом деле выводится вывод.

## <a name="the-print-preview-process"></a><a name="_core_the_print_preview_process"></a>Процесс предварительного просмотра

Когда пользователь выбирает команду предварительного просмотра в меню **файл** , платформа создает `CPreviewDC` объект. Каждый раз, когда приложение выполняет операцию, которая задает характеристику контекста устройства печати, платформа также выполняет аналогичные операции с контекстом устройства экрана. Например, если приложение выбирает шрифт для печати, платформа выбирает шрифт для экрана, который имитирует шрифт принтера. Когда приложение будет отправлять выходные данные на принтер, платформа отправляет выходные данные на экран.

Предварительный просмотр также отличается от печати в том порядке, в котором каждый из них рисует страницы документа. Во время печати платформа возобновляет цикл печати до тех пор, пока не будет отображен определенный диапазон страниц. Во время предварительного просмотра одна или две страницы отображаются в любое время, а затем приложение ждет; дальнейшие страницы не отображаются, пока пользователь не ответит. Во время просмотра предварительной версии приложение должно также реагировать на WM_PAINT сообщения, как и при обычном отображении экрана.

Функция [CView:: онпрепарепринтинг](reference/cview-class.md#onprepareprinting) вызывается при вызове режима предварительного просмотра точно так же, как в начале задания печати. Структура [структуры CPrintInfo](reference/cprintinfo-structure.md) , передаваемая в функцию, содержит несколько членов, значения которых можно настроить для настройки определенных характеристик операции просмотра печати. Например, можно задать элемент *m_nNumPreviewPages* , чтобы указать, следует ли выполнять предварительный просмотр документа в режиме одной или двух страниц.

## <a name="modifying-print-preview"></a><a name="_core_modifying_print_preview"></a>Изменение предварительного просмотра печати

Изменить поведение и внешний вид предварительного просмотра можно несколькими способами. Например, можно, помимо прочего, выполнить следующие действия:

- В окне предварительного просмотра печати отображается полоса прокрутки для быстрого доступа к любой странице документа.

- Вызвать предварительный просмотр для сохранения позиции пользователя в документе, начиная с ее отображения на текущей странице.

- Вызывает другую инициализацию для предварительного просмотра и печати.

- Вызвать предварительный просмотр для отображения номеров страниц в собственных форматах.

Если известно, сколько времени документ и вызывается `SetMaxPage` с помощью соответствующего значения, платформа может использовать эти сведения в режиме предварительного просмотра, а также во время печати. После того, как платформа знает длину документа, она может предоставить окно предварительного просмотра с полосой прокрутки, позволяя пользователю переходить по документу в режиме предварительного просмотра. Если длина документа не задана, платформа не может установить ползунок полосы прокрутки, чтобы показать текущую координату, поэтому платформа не добавляет полосу прокрутки. В этом случае пользователь должен использовать кнопки Следующая страница и Предыдущая страница на панели управления окна предварительного просмотра, чтобы пролистать документ.

Для предварительного просмотра может оказаться полезным присвоить значение элементу *m_nCurPage* `CPrintInfo` , даже если это не будет сделано для обычной печати. Во время обычной печати этот член передает сведения из платформы в класс представления. Таким образом платформа сообщает представление о необходимости печати страницы.

И наоборот, при запуске режима предварительного просмотра элемент *m_nCurPage* передает информацию в обратном направлении: от представления к платформе. Платформа использует значение этого элемента, чтобы определить, какую страницу следует предварительно просмотреть. Значение по умолчанию для этого элемента равно 1, поэтому первая страница документа отображается изначально. Можно переопределить `OnPreparePrinting` , чтобы присвоить этому элементу номер просматриваемой страницы во время вызова команды предварительного просмотра. Таким образом, приложение сохраняет текущую точку пользователя при переходе от обычного режима отображения к режиму предварительного просмотра печати.

Иногда может потребоваться `OnPreparePrinting` выполнить другую инициализацию в зависимости от того, вызывается ли он для задания печати или для предварительного просмотра. Это можно определить, изучив переменную члена *m_bPreview* в `CPrintInfo` структуре. Этот элемент устанавливается в **значение true** при вызове предварительного просмотра печати.

Эта `CPrintInfo` структура также содержит элемент с именем *m_strPageDesc*, который используется для форматирования строк, отображаемых в нижней части экрана в одностраничном и многостраничном режиме. По умолчанию эти строки имеют форму "Page *n*" и "Pages *n*  -  *m*", но вы можете изменить *m_strPageDesc* из в `OnPreparePrinting` и задать строки как более сложные. Дополнительные сведения см. в разделе [Структура CPrintInfo](reference/cprintinfo-structure.md) в *справочнике по MFC* .

## <a name="see-also"></a>См. также раздел

[Печать и предварительный просмотр печати](printing-and-print-preview.md)<br/>
[Вывод на печать](printing.md)<br/>
[Класс CView](reference/cview-class.md)<br/>
[CDC, класс](reference/cdc-class.md)
