---
title: Класс CDatabase
ms.date: 11/04/2016
f1_keywords:
- CDatabase
- AFXDB/CDatabase
- AFXDB/CDatabase::CDatabase
- AFXDB/CDatabase::BeginTrans
- AFXDB/CDatabase::BindParameters
- AFXDB/CDatabase::Cancel
- AFXDB/CDatabase::CanTransact
- AFXDB/CDatabase::CanUpdate
- AFXDB/CDatabase::Close
- AFXDB/CDatabase::CommitTrans
- AFXDB/CDatabase::ExecuteSQL
- AFXDB/CDatabase::GetBookmarkPersistence
- AFXDB/CDatabase::GetConnect
- AFXDB/CDatabase::GetCursorCommitBehavior
- AFXDB/CDatabase::GetCursorRollbackBehavior
- AFXDB/CDatabase::GetDatabaseName
- AFXDB/CDatabase::IsOpen
- AFXDB/CDatabase::OnSetOptions
- AFXDB/CDatabase::Open
- AFXDB/CDatabase::OpenEx
- AFXDB/CDatabase::Rollback
- AFXDB/CDatabase::SetLoginTimeout
- AFXDB/CDatabase::SetQueryTimeout
- AFXDB/CDatabase::m_hdbc
helpviewer_keywords:
- CDatabase [MFC], CDatabase
- CDatabase [MFC], BeginTrans
- CDatabase [MFC], BindParameters
- CDatabase [MFC], Cancel
- CDatabase [MFC], CanTransact
- CDatabase [MFC], CanUpdate
- CDatabase [MFC], Close
- CDatabase [MFC], CommitTrans
- CDatabase [MFC], ExecuteSQL
- CDatabase [MFC], GetBookmarkPersistence
- CDatabase [MFC], GetConnect
- CDatabase [MFC], GetCursorCommitBehavior
- CDatabase [MFC], GetCursorRollbackBehavior
- CDatabase [MFC], GetDatabaseName
- CDatabase [MFC], IsOpen
- CDatabase [MFC], OnSetOptions
- CDatabase [MFC], Open
- CDatabase [MFC], OpenEx
- CDatabase [MFC], Rollback
- CDatabase [MFC], SetLoginTimeout
- CDatabase [MFC], SetQueryTimeout
- CDatabase [MFC], m_hdbc
ms.assetid: bd0de70a-e3c3-4441-bcaa-bbf434426ca8
ms.openlocfilehash: ebc36d82af9bfe12ab30a86214e58610b5eaab95
ms.sourcegitcommit: 0ab61bc3d2b6cfbd52a16c6ab2b97a8ea1864f12
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62253718"
---
# <a name="cdatabase-class"></a>Класс CDatabase

Представляет подключение к источнику данных, с помощью которого можно получить доступ к данным.

## <a name="syntax"></a>Синтаксис

```
class CDatabase : public CObject
```

## <a name="members"></a>Участники

### <a name="public-constructors"></a>Открытые конструкторы

|name|Описание|
|----------|-----------------|
|[CDatabase::CDatabase](#cdatabase)|Создает объект `CDatabase`. Необходимо инициализировать объект путем вызова `OpenEx` или `Open`.|

### <a name="public-methods"></a>Открытые методы

|name|Описание|
|----------|-----------------|
|[CDatabase::BeginTrans](#begintrans)|Запускает «транзакция» — ряд обратимое вызовы `AddNew`, `Edit`, `Delete`, и `Update` функции-члены класса `CRecordset` — на подключенном источнике данных. Источник данных должен поддерживать транзакции для `BeginTrans` в действие.|
|[CDatabase::BindParameters](#bindparameters)|Позволяет выполнить привязку параметров перед вызовом `CDatabase::ExecuteSQL`.|
|[CDatabase::Cancel](#cancel)|Отменяет асинхронную операцию или процесс из второго потока.|
|[CDatabase::CanTransact](#cantransact)|Возвращает ненулевое значение, если источник данных поддерживает транзакции.|
|[CDatabase::CanUpdate](#canupdate)|Возвращает ненулевое значение, если `CDatabase` объекта является обновляемым (не только для чтения).|
|[CDatabase::Close](#close)|Закрывает соединение с источником данных.|
|[CDatabase::CommitTrans](#committrans)|Завершает транзакцию, начатого `BeginTrans`. Команды в транзакции, изменяющие источнике данных выполняются.|
|[CDatabase::ExecuteSQL](#executesql)|Выполняет инструкцию SQL. Записи данных, не возвращаются.|
|[CDatabase::GetBookmarkPersistence](#getbookmarkpersistence)|Определяет операции, выполнении которых закладки сохраняются в объектах набор записей.|
|[CDatabase::GetConnect](#getconnect)|Возвращает строку подключения ODBC, используемые для подключения `CDatabase` объекта к источнику данных.|
|[CDatabase::GetCursorCommitBehavior](#getcursorcommitbehavior)|Определяет эффект фиксирует транзакцию для объекта открыть набор записей.|
|[CDatabase::GetCursorRollbackBehavior](#getcursorrollbackbehavior)|Определяет эффект отката транзакции объекта открыть набор записей.|
|[CDatabase::GetDatabaseName](#getdatabasename)|Возвращает имя базы данных в настоящее время используется.|
|[CDatabase::IsOpen](#isopen)|Возвращает ненулевое значение, если `CDatabase` объект в данный момент подключен к источнику данных.|
|[CDatabase::OnSetOptions](#onsetoptions)|Вызывается платформой для задания параметров стандартное подключение. Реализация по умолчанию задает значение времени ожидания запроса. Вы можете установить эти параметры заранее путем вызова `SetQueryTimeout`.|
|[CDatabase::Open](#open)|Устанавливает подключение к источнику данных (с помощью драйвера ODBC).|
|[CDatabase::OpenEx](#openex)|Устанавливает подключение к источнику данных (с помощью драйвера ODBC).|
|[CDatabase::Rollback](#rollback)|Отменяет изменения, внесенные во время текущей транзакции. Источник данных возвращает в предыдущее состояние, как определено в `BeginTrans` вызов, без изменений.|
|[CDatabase::SetLoginTimeout](#setlogintimeout)|Задает количество секунд, после чего попытки подключения источника данных время ожидания истечет.|
|[CDatabase::SetQueryTimeout](#setquerytimeout)|Операции запроса в секундах после базу данных, которая задает время ожидания истечет. Влияет на всех последующих записей `Open`, `AddNew`, `Edit`, и `Delete` вызовов.|

### <a name="public-data-members"></a>Открытые члены данных

|name|Описание|
|----------|-----------------|
|[CDatabase::m_hdbc](#m_hdbc)|Open Database Connectivity (ODBC) дескриптора соединения с источником данных. Тип *HDBC*.|

## <a name="remarks"></a>Примечания

Источник данных — с определенным экземпляром данным, размещенным в некоторые системы управления базами данных (СУБД). Примеры Microsoft SQL Server, Microsoft Access, Borland dBASE и xBASE. Можно иметь один или несколько `CDatabase` объектов в каждый момент времени в приложении.

> [!NOTE]
>  Если вы работаете с классами объектов доступа к данным (DAO) вместо классов Open Database Connectivity (ODBC), используйте класс [CDaoDatabase](../../mfc/reference/cdaodatabase-class.md) вместо этого. Дополнительные сведения см. в статье [Обзор: Программирование баз данных](../../data/data-access-programming-mfc-atl.md).

Чтобы использовать `CDatabase`, создания `CDatabase` и вызовите его `OpenEx` функция-член. Это открывает соединение. При создании затем `CRecordset` объектов для работы с подключенного источника данных, передайте в конструктор набора записей указатель на вашей `CDatabase` объекта. Когда вы закончите, используя соединение, вызовите `Close` члена функции и уничтожать `CDatabase` объекта. `Close` Закрывает все наборы записей, которые ранее не закрыта.

Дополнительные сведения о `CDatabase`, см. в статьях [источника данных (ODBC)](../../data/odbc/data-source-odbc.md) и [Обзор: Программирование баз данных](../../data/data-access-programming-mfc-atl.md).

## <a name="inheritance-hierarchy"></a>Иерархия наследования

[CObject](../../mfc/reference/cobject-class.md)

`CDatabase`

## <a name="requirements"></a>Требования

**Заголовок:** afxdb.h

##  <a name="begintrans"></a>  CDatabase::BeginTrans

Вызовите эту функцию-член для начала транзакции с подключенного источника данных.

```
BOOL BeginTrans();
```

### <a name="return-value"></a>Возвращаемое значение

Ненулевое значение, если вызов был успешным и фиксируются изменения только вручную; в противном случае 0.

### <a name="remarks"></a>Примечания

Транзакция состоит из одного или нескольких вызовов к `AddNew`, `Edit`, `Delete`, и `Update` функциями-членами `CRecordset` объекта. Перед началом транзакции, `CDatabase` объект должен уже подключен к источнику данных, вызвав его `OpenEx` или `Open` функция-член. Для завершения транзакции вызовите [CommitTrans](#committrans) для принятия всех изменений в источник данных (и их выполнения) или вызвать [отката](#rollback) для отмены всей транзакции. Вызовите `BeginTrans` после того, как открыть все наборы записей, включенных в транзакцию и как можно ближе к фактическим операции обновления максимально.

> [!CAUTION]
>  В зависимости от своего драйвера ODBC, открыв набор записей, перед вызовом `BeginTrans` может привести к проблемам при вызове `Rollback`. Следует проверить конкретный драйвер, который вы используете. Например при использовании драйвера Microsoft Access, включенного в 3.0 пакет драйвера Microsoft ODBC рабочего стола, необходимо учитывать требования СУБД Jet, что не следует начинать транзакции в любой базе данных с открытым курсором. В классы баз данных MFC, открытый курсор означает, что открытый `CRecordset` объекта. Дополнительные сведения см. в разделе [технические 68 Примечание](../../mfc/tn068-performing-transactions-with-the-microsoft-access-7-odbc-driver.md).

`BeginTrans` также может блокировать записи данных на сервере, в зависимости от запрошенного параллелизма и возможности источника данных. Сведения о блокировке данных см. в статье [набор записей: Блокировка (ODBC)](../../data/odbc/recordset-locking-records-odbc.md).

В этой статье рассматриваются пользовательские транзакции [транзакции (ODBC)](../../data/odbc/transaction-odbc.md).

`BeginTrans` устанавливает состояние, к которому последовательности транзакций можно выполнить откат (в обратном порядке). Чтобы установить новое состояние для отката, фиксации любой текущей транзакции, затем вызовите `BeginTrans` еще раз.

> [!CAUTION]
>  Вызов `BeginTrans` еще раз без вызова `CommitTrans` или `Rollback` является ошибкой.

Вызовите [CanTransact](#cantransact) функция-член для определения, поддерживает ли драйвер транзакций для заданной базы данных. Вам также следует вызвать [GetCursorCommitBehavior](#getcursorcommitbehavior) и [GetCursorRollbackBehavior](#getcursorrollbackbehavior) для определения поддержки для хранения курсора.

Дополнительные сведения о транзакциях см. в статье [транзакции (ODBC)](../../data/odbc/transaction-odbc.md).

### <a name="example"></a>Пример

  См. в статье [транзакции: Выполнение транзакции в наборе записей (ODBC)](../../data/odbc/transaction-performing-a-transaction-in-a-recordset-odbc.md).

##  <a name="bindparameters"></a>  CDatabase::BindParameters

Переопределить `BindParameters` при необходимости для привязки параметров перед вызовом [помощью функции CDatabase::ExecuteSQL](#executesql).

```
virtual void BindParameters(HSTMT hstmt);
```

### <a name="parameters"></a>Параметры

*HSTMT*<br/>
Дескриптор инструкции ODBC, для которого необходимо выполнить привязку параметров.

### <a name="remarks"></a>Примечания

Этот подход полезен, если результат не обязательно задайте из хранимой процедуры.

В переопределении, вызовите `SQLBindParameters` и соответствующие функции ODBC для привязки параметров. MFC вызывает переопределенный до обращения к `ExecuteSQL`. Необходимо вызвать `SQLPrepare`; `ExecuteSQL` вызовы `SQLExecDirect` и уничтожает *hstmt*, который используется только один раз.

##  <a name="cancel"></a>  CDatabase::Cancel

Вызовите эту функцию-член для запроса, что источник данных отмена выполняемой асинхронной операции или процесс из второго потока.

```
void Cancel();
```

### <a name="remarks"></a>Примечания

Обратите внимание, что классам ODBC библиотеки MFC больше не использовать асинхронной обработки; для выполнения асинхронной операции, необходимо непосредственно вызвать функцию ODBC API [SQLSetConnectOption](/sql/odbc/reference/syntax/sqlsetconnectoption-function). Дополнительные сведения см. в разделе [асинхронное выполнение](/sql/odbc/reference/develop-app/asynchronous-execution).

##  <a name="cantransact"></a>  CDatabase::CanTransact

Вызывайте эту функцию члена, чтобы определить, допускает ли базы данных транзакций.

```
BOOL CanTransact() const;
```

### <a name="return-value"></a>Возвращаемое значение

Ненулевое значение наборы записей с помощью этого `CDatabase` объект разрешить транзакции; в противном случае — 0.

### <a name="remarks"></a>Примечания

Сведения о транзакциях см. в статье [транзакции (ODBC)](../../data/odbc/transaction-odbc.md).

##  <a name="canupdate"></a>  CDatabase::CanUpdate

Вызывайте эту функцию члена, чтобы определить ли `CDatabase` объект позволяет обновлений.

```
BOOL CanUpdate() const;
```

### <a name="return-value"></a>Возвращаемое значение

Ненулевое значение `CDatabase` объект позволяет обновления; в противном случае — 0, указывающая, что либо, переданное значение TRUE *bReadOnly* при открытии `CDatabase` объекта или с источником данных, сам доступен только для чтения. Источник данных доступно только для чтения, если в вызове функции ODBC API `SQLGetInfo` для SQL_DATASOURCE_READ_ONLY возвращает «y».

### <a name="remarks"></a>Примечания

Не все драйверы поддерживают обновления.

##  <a name="cdatabase"></a>  CDatabase::CDatabase

Создает объект `CDatabase`.

```
CDatabase();
```

### <a name="remarks"></a>Примечания

После создания объекта, необходимо вызвать его `OpenEx` или `Open` функция-член для установления соединения с источником данных.

Вы может оказаться более удобным для внедрения `CDatabase` объекта в классе документа.

### <a name="example"></a>Пример

Этот пример иллюстрирует использование `CDatabase` в `CDocument`-производного класса.

[!code-cpp[NVC_MFCDatabase#9](../../mfc/codesnippet/cpp/cdatabase-class_1.h)]

[!code-cpp[NVC_MFCDatabase#10](../../mfc/codesnippet/cpp/cdatabase-class_2.cpp)]

##  <a name="close"></a>  CDatabase::Close

Вызовите эту функцию-член, если вы хотите отключиться от источника данных.

```
virtual void Close();
```

### <a name="remarks"></a>Примечания

Необходимо закрыть все наборы записей, связанных с `CDatabase` объект перед вызовом этой функции-члена. Так как `Close` не уничтожает `CDatabase` объекта, вы можете повторно использовать объект путем открытия нового подключения к тому же источнику данных или другого источника данных.

Все ожидающие `AddNew` или `Edit` операторы наборов записей, с помощью базы данных будут отменены, и всех незавершенных транзакций выполняется откат. Все наборы записей, зависит от `CDatabase` объект остается в неопределенном состоянии.

### <a name="example"></a>Пример

[!code-cpp[NVC_MFCDatabase#12](../../mfc/codesnippet/cpp/cdatabase-class_3.cpp)]

##  <a name="committrans"></a>  CDatabase::CommitTrans

Вызовите эту функцию-член по завершении транзакции.

```
BOOL CommitTrans();
```

### <a name="return-value"></a>Возвращаемое значение

Ненулевое значение, если обновление выполнено успешно зафиксировано; в противном случае 0. Если `CommitTrans` завершается ошибкой, состояние источника данных не определено. Необходимо проверить данные, чтобы определить его состояние.

### <a name="remarks"></a>Примечания

Транзакция состоит из ряда вызовов `AddNew`, `Edit`, `Delete`, и `Update` функциями-членами `CRecordset` объект, который начинается с вызова [BeginTrans](#begintrans) функция-член. `CommitTrans` Фиксирует транзакцию. По умолчанию обновления фиксируются немедленно; вызов `BeginTrans` вызывает обновлений приверженность отложено до `CommitTrans` вызывается.

До вызова метода `CommitTrans` до конца транзакции, можно вызвать [отката](#rollback) функцию-член для прервать транзакцию и сохранить источник данных в исходное состояние. Чтобы начать новую транзакцию, вызвать `BeginTrans` еще раз.

Дополнительные сведения о транзакциях см. в статье [транзакции (ODBC)](../../data/odbc/transaction-odbc.md).

### <a name="example"></a>Пример

  См. в статье [транзакции: Выполнение транзакции в наборе записей (ODBC)](../../data/odbc/transaction-performing-a-transaction-in-a-recordset-odbc.md).

##  <a name="executesql"></a>  Помощью функции CDatabase::ExecuteSQL

Вызовите эту функцию-член, при необходимости для выполнения команды SQL напрямую.

```
void ExecuteSQL(LPCTSTR lpszSQL);
```

### <a name="parameters"></a>Параметры

*lpszSQL*<br/>
Указатель на заканчивающуюся нулем строку, содержащую допустимую команду SQL для выполнения. Вы можете передать [CString](../../atl-mfc-shared/reference/cstringt-class.md).

### <a name="remarks"></a>Примечания

Создайте команду как строку, завершающуюся символом null. `ExecuteSQL` не возвращает записей данных. Если вы хотите работать с записями, используйте объект набора записей.

Большинство команд для источника данных выдаются через объекты набора записей, которые поддерживают команды для выбора данных, Вставка новых записей, удаление записей и изменение записей. Однако не все функции ODBC непосредственно поддерживается классами баз данных, поэтому в некоторых случаях может потребоваться передать прямой вызов SQL с `ExecuteSQL`.

### <a name="example"></a>Пример

[!code-cpp[NVC_MFCDatabase#13](../../mfc/codesnippet/cpp/cdatabase-class_4.cpp)]

##  <a name="getbookmarkpersistence"></a>  CDatabase::GetBookmarkPersistence

Вызовите эту функцию-член, чтобы определить наличие закладок в объекте recordset после определенных операций.

```
DWORD GetBookmarkPersistence() const;
```

### <a name="return-value"></a>Возвращаемое значение

Битовая маска, определяющая операции, при выполнении которых закладки сохраняются в объекте recordset. Дополнительные сведения см. в разделе "Заметки".

### <a name="remarks"></a>Примечания

Например, если вызвать метод `CRecordset::GetBookmark`, а затем вызвать`CRecordset::Requery`, закладка, полученная от `GetBookmark`, может быть недействительной. Перед вызовом `GetBookmarkPersistence` следует вызвать метод `CRecordset::SetBookmark`.

В следующей таблице перечислены значения битовой маски, которые можно объединять для возвращаемого значения `GetBookmarkPersistence`.

|Значение битовой маски|Сохранение закладки|
|-------------------|--------------------------|
|SQL_BP_CLOSE|Закладки являются действительными после `Requery` операции.|
|SQL_BP_DELETE|Закладка для строки действительна после `Delete` операции в этой строке.|
|SQL_BP_DROP|Закладки являются действительными после `Close` операции.|
|SQL_BP_SCROLL|Закладки являются действительными после `Move` операции. Этот параметр просто определяет, поддерживаются ли закладки для объекта recordset в соответствии со значением, возвращенным `CRecordset::CanBookmark`.|
|SQL_BP_TRANSACTION|Закладки являются действительными после фиксации или отката транзакции.|
|SQL_BP_UPDATE|Закладка для строки действительна после `Update` операции в этой строке.|
|SQL_BP_OTHER_HSTMT|Закладки, связанные с одним объектом recordset, действительны для второго объекта recordset.|

Дополнительные сведения об этом значении см. в разделе функции ODBC API `SQLGetInfo` в пакете Windows SDK. Дополнительные сведения о закладках см. в статье [набор записей: Закладки и абсолютное позиционирование (ODBC)](../../data/odbc/recordset-bookmarks-and-absolute-positions-odbc.md).

##  <a name="getconnect"></a>  CDatabase::GetConnect

Вызовите эту функцию-член для получения строку подключения, используемую при вызове `OpenEx` или `Open` , подключенном `CDatabase` объекта к источнику данных.

```
const CString GetConnect() const;
```

### <a name="return-value"></a>Возвращаемое значение

Объект **const**[CString](../../atl-mfc-shared/reference/cstringt-class.md) со строкой подключения, если `OpenEx` или `Open` вызван; в противном случае — пустая строка.

### <a name="remarks"></a>Примечания

См. в разделе [CDatabase::Open](#open) описание способ создания строки подключения.

##  <a name="getcursorcommitbehavior"></a>  CDatabase::GetCursorCommitBehavior

Вызывайте эту функцию члена, чтобы определить, как [CommitTrans](#committrans) операция затрагивает курсоры в объекты открыть набор записей.

```
int GetCursorCommitBehavior() const;
```

### <a name="return-value"></a>Возвращаемое значение

Значение, указывающее влияние транзакций на объектах открыть набор записей. Дополнительные сведения см. в разделе "Заметки".

### <a name="remarks"></a>Примечания

В следующей таблице перечислены возможные возвращаемые значения для `GetCursorCommitBehavior` и соответствующим образом отразится на открыть набор записей.

|Возвращаемое значение|Влияние на CRecordset-объекты|
|------------------|----------------------------------|
|SQL_CB_CLOSE|Вызовите `CRecordset::Requery` сразу после фиксации транзакции.|
|SQL_CB_DELETE|Вызовите `CRecordset::Close` сразу после фиксации транзакции.|
|SQL_CB_PRESERVE|Обычно Продолжить `CRecordset` операций.|

Дополнительные сведения об этом значении см. в разделе функции ODBC API `SQLGetInfo` в пакете Windows SDK. Дополнительные сведения о транзакциях см. в статье [транзакции (ODBC)](../../data/odbc/transaction-odbc.md).

##  <a name="getcursorrollbackbehavior"></a>  CDatabase::GetCursorRollbackBehavior

Вызывайте эту функцию члена, чтобы определить, как [отката](#rollback) операция затрагивает курсоры в объекты открыть набор записей.

```
int GetCursorRollbackBehavior() const;
```

### <a name="return-value"></a>Возвращаемое значение

Значение, указывающее влияние транзакций на объектах открыть набор записей. Дополнительные сведения см. в разделе "Заметки".

### <a name="remarks"></a>Примечания

В следующей таблице перечислены возможные возвращаемые значения для `GetCursorRollbackBehavior` и соответствующим образом отразится на открыть набор записей.

|Возвращаемое значение|Влияние на CRecordset-объекты|
|------------------|----------------------------------|
|SQL_CB_CLOSE|Вызовите `CRecordset::Requery` сразу после отката транзакции.|
|SQL_CB_DELETE|Вызовите `CRecordset::Close` сразу после отката транзакции.|
|SQL_CB_PRESERVE|Обычно Продолжить `CRecordset` операций.|

Дополнительные сведения об этом значении см. в разделе функции ODBC API `SQLGetInfo` в пакете Windows SDK. Дополнительные сведения о транзакциях см. в статье [транзакции (ODBC)](../../data/odbc/transaction-odbc.md).

##  <a name="getdatabasename"></a>  CDatabase::GetDatabaseName

Вызовите эту функцию-член для извлечения имени текущей подключенной базы данных, (при условии, что источник данных определяет именованный объект, называемый «database»).

```
CString GetDatabaseName() const;
```

### <a name="return-value"></a>Возвращаемое значение

Объект [CString](../../atl-mfc-shared/reference/cstringt-class.md) содержащее имя базы данных, если успешно; в противном случае — пустой `CString`.

### <a name="remarks"></a>Примечания

Это не то же самое, как имя источника данных (DSN), указанный в `OpenEx` или `Open` вызова. Что `GetDatabaseName` возвращает зависит от ODBC. Как правило база данных находится коллекция таблиц. Если эта сущность имеет имя, `GetDatabaseName` возвращает его.

Может например, будет отображаться это имя в заголовке. Если произошла ошибка при получении имени из ODBC, `GetDatabaseName` возвращает пустую коллекцию `CString`.

##  <a name="isopen"></a>  CDatabase::IsOpen

Вызывайте эту функцию члена, чтобы определить ли `CDatabase` объект в данный момент подключен к источнику данных.

```
BOOL IsOpen() const;
```

### <a name="return-value"></a>Возвращаемое значение

Ненулевое значение `CDatabase` в настоящее время подключен объект; в противном случае 0.

##  <a name="m_hdbc"></a>  CDatabase::m_hdbc

Содержит открытый дескриптор соединения с источником данных ODBC — «дескриптор подключения».

### <a name="remarks"></a>Примечания

Как правило вы получите прямой доступ к этой переменной-члена не нужно. Вместо этого платформа выделяет дескриптор при вызове `OpenEx` или `Open`. Платформа освобождает дескриптор, при вызове **удалить** оператора `CDatabase` объекта. Обратите внимание, что `Close` функция-член не освобождает дескриптор.

Однако в некоторых случаях может потребоваться напрямую использовать дескриптор. Например, если вам нужно вызывать функции ODBC API напрямую, а не через класс `CDatabase`, может понадобиться передать в качестве параметра дескриптор соединения. См. в примере кода.

### <a name="example"></a>Пример

[!code-cpp[NVC_MFCDatabase#15](../../mfc/codesnippet/cpp/cdatabase-class_5.cpp)]

##  <a name="onsetoptions"></a>  CDatabase::OnSetOptions

Эта функция-член вызывается платформой, при непосредственного выполнения инструкции SQL с `ExecuteSQL` функция-член.

```
virtual void OnSetOptions(HSTMT hstmt);
```

### <a name="parameters"></a>Параметры

*HSTMT*<br/>
Дескриптор инструкции ODBC, для которого задаются параметры.

### <a name="remarks"></a>Примечания

`CRecordset::OnSetOptions` также вызывается эта функция-член.

`OnSetOptions` Задает время ожидания входа. Если были сделаны предыдущими вызовами `SetQueryTimeout` и функции-члена `OnSetOptions` отражает текущие значения; в противном случае он задает значения по умолчанию.

> [!NOTE]
>  До MFC 4.2 `OnSetOptions` также задавать режим обработки, либо snychronous или асинхронной. Начиная с версии 4.2 MFC, все операции являются синхронными. Чтобы выполнить асинхронную операцию, необходимо передать прямой вызов функции ODBC API `SQLSetPos`.

Необходимо переопределить `OnSetOptions` Чтобы изменить значение времени ожидания. Вместо этого, чтобы настроить значение времени ожидания запроса, вызовите `SetQueryTimeout` перед созданием записей; `OnSetOptions` будут использовать новое значение. Набор значений применяется к последующие операции на все наборы записей или прямых вызовов SQL.

Переопределить `OnSetOptions` Если вы хотите установить дополнительные параметры. Переопределение должно вызвать базовый класс `OnSetOptions` до или после вызова функции ODBC API `SQLSetStmtOption`. Выполните метод, описанный в реализации по умолчанию платформы `OnSetOptions`.

##  <a name="open"></a>  CDatabase::Open

Вызов этой функции-члена для инициализации нового созданного `CDatabase` объекта.

```
virtual BOOL Open(
    LPCTSTR lpszDSN,
    BOOL bExclusive = FALSE,
    BOOL bReadOnly = FALSE,
    LPCTSTR lpszConnect = _T("ODBC;"),
    BOOL bUseCursorLib = TRUE);
```

### <a name="parameters"></a>Параметры

*lpszDSN*<br/>
Указывает имя источника данных — имя зарегистрирован с помощью ODBC с помощью программы администрирования ODBC. Если задано значение DSN в *lpszConnect* (в форме «DSN =\<источник данных >»), оно не должно быть указано в *lpszDSN*. В этом случае *lpszDSN* должен иметь значение NULL. В противном случае можно передать NULL, если вы хотите предоставить пользователю диалоговое окно источника данных, в котором пользователь может выбрать источник данных. Для получения дополнительных сведений см. в разделе "Примечания".

*bExclusive*<br/>
Не поддерживается в этой версии библиотеки классов. В настоящее время утверждение не выполняется, если этот параметр имеет значение TRUE. Источник данных всегда открывается как shared (не является монопольной особенностью).

*bReadOnly*<br/>
Значение TRUE, если планируется подключение только для чтения и запретить обновления в источнике данных. Все зависимые наборы записей, наследуют этот атрибут. Значение по умолчанию — FALSE.

*lpszConnect*<br/>
Указывает строку подключения. Строка подключения объединяет сведения, возможно, включающий имя источника данных, допустимый идентификатор пользователя в источнике данных, строку проверки подлинности пользователя (пароль, если источник данных требуется один) и другие сведения. Строка соединения целиком должны предваряться строку «ODBC». (в верхнем или нижнем регистре). «ODBC»; строка используется для указания, что является подключение к источнику данных ODBC; Это вверх совместимости при будущих версий библиотеки классов могут поддерживать источники данных не ODBC.

*bUseCursorLib*<br/>
Значение TRUE, если курсор библиотеки DLL-Библиотека ODBC для загрузки. Библиотека курсоров скрывает некоторую функциональность базового драйвера ODBC, фактически не позволяет использовать динамических подмножеств данных (если драйвер поддерживает их). Только курсоров поддерживается, если загружается библиотека курсоров используются статические снимки и однонаправленные курсоры. Значение по умолчанию — TRUE. Если вы планируете создать непосредственно из объекта набора записей `CRecordset` без его производными, не должен загружать библиотеку курсоров.

### <a name="return-value"></a>Возвращаемое значение

Ненулевое значение, если соединение устанавливается успешно; в противном случае 0, если пользователь выбирает отменить, когда появится диалоговое окно с запросом для дополнительных сведений о соединении. Во всех остальных случаях платформа создает исключение.

### <a name="remarks"></a>Примечания

Необходимо инициализировать объект базы данных, прежде чем его можно использовать для создания объекта набора записей.

> [!NOTE]
>  Вызов [OpenEx](#openex) функция-член является предпочтительным способом подключения к источнику данных и инициализировать объект базы данных.

Если параметры в вашей `Open` вызова не содержат достаточно сведений для подключения, драйвер ODBC открывает диалоговое окно, чтобы получить необходимую информацию от пользователя. При вызове `Open`, строки подключения, *lpszConnect*, хранится в частном порядке `CDatabase` объекта и по телефону [GetConnect](#getconnect) функция-член.

При желании можно открыть диалоговое окно, перед вызовом метода `Open` для получения сведений от пользователя, такие как пароль, затем добавить эту информацию к строке подключения, передаваемый `Open`. Или может потребоваться сохранить строку подключения, можно передать, чтобы ее можно повторно использовать следующий раз, когда ваши приложения вызывает `Open` на `CDatabase` объекта.

Можно также использовать строку подключения для нескольких уровней авторизации имени входа (для другой `CDatabase` объекта) или для передачи других сведений зависящие от источника данных. Дополнительные сведения о строках подключения см. в разделе Глава 5 в пакете Windows SDK.

Существует возможность попытки подключения к времени ожидания, если, например, узел СУБД недоступен. Если попытка соединения завершается, `Open` вызывает `CDBException`.

### <a name="example"></a>Пример

[!code-cpp[NVC_MFCDatabase#14](../../mfc/codesnippet/cpp/cdatabase-class_6.cpp)]

##  <a name="openex"></a>  CDatabase::OpenEx

Вызов этой функции-члена для инициализации нового созданного `CDatabase` объекта.

```
virtual BOOL OpenEx(
    LPCTSTR lpszConnectString,
    DWORD dwOptions = 0);
```

### <a name="parameters"></a>Параметры

*lpszConnectString*<br/>
Задает строку подключения ODBC. Это включает в себя имя источника данных, а также другие данные, такие как идентификатор пользователя и пароль. Например «DSN = SQLServer_Source; UID = SA; PWD = abc123» представляет собой строку подключения. Обратите внимание, что если передать значение NULL *lpszConnectString*, диалоговое окно источника данных будет предлагать пользователю выбрать источник данных.

*dwOptions*<br/>
Битовая маска, который указывает сочетание следующих значений. Значение по умолчанию — 0, это означает, что базы данных будет открыт как предоставлен доступ на запись, эти Библиотеки курсоров ODBC не будет загружен и диалоговым окном соединения ODBC будет отображаться только в том случае, если не имеется достаточно сведений для подключения.

- `CDatabase::openExclusive` Не поддерживается в этой версии библиотеки классов. Источник данных всегда открывается как shared (не является монопольной особенностью). В настоящее время утверждение не выполняется, если этот параметр.

- `CDatabase::openReadOnly` Откройте этот источник данных только для чтения.

- `CDatabase::useCursorLib` Загрузите DLL-библиотека курсоров ODBC. Библиотека курсоров скрывает некоторую функциональность базового драйвера ODBC, фактически не позволяет использовать динамических подмножеств данных (если драйвер поддерживает их). Только курсоров поддерживается, если загружается библиотека курсоров используются статические снимки и однонаправленные курсоры. Если вы планируете создать непосредственно из объекта набора записей `CRecordset` без его производными, не должен загружать библиотеку курсоров.

- `CDatabase::noOdbcDialog` Не отображать диалоговое ODBC-подключения, независимо от того, предоставляется ли достаточно информации для подключения.

- `CDatabase::forceOdbcDialog` Всегда отображать диалоговое окно соединения ODBC.

### <a name="return-value"></a>Возвращаемое значение

Ненулевое значение, если соединение устанавливается успешно; в противном случае 0, если пользователь выбирает отменить, когда появится диалоговое окно с запросом для дополнительных сведений о соединении. Во всех остальных случаях платформа создает исключение.

### <a name="remarks"></a>Примечания

Необходимо инициализировать объект базы данных, прежде чем его можно использовать для создания объекта набора записей.

Если *lpszConnectString* параметр в вашей `OpenEx` вызова не содержит достаточно информации для подключения, драйвер ODBC открывает диалоговое окно, чтобы получить необходимую информацию от пользователя, при этом не требуется Задайте `CDatabase::noOdbcDialog` или `CDatabase::forceOdbcDialog` в *dwOptions* параметра. При вызове `OpenEx`, строки подключения, *lpszConnectString*, хранится в частном порядке `CDatabase` объекта и по телефону [GetConnect](#getconnect) функция-член.

При желании можно открыть диалоговое окно, перед вызовом метода `OpenEx` для получения сведений от пользователя, например, пароля и затем добавить эту информацию к строке подключения, передаваемый `OpenEx`. Или может потребоваться сохранить строку подключения, можно передать, чтобы ее можно повторно использовать следующий раз, когда ваши приложения вызывает `OpenEx` на `CDatabase` объекта.

Можно также использовать строку подключения для нескольких уровней авторизации имени входа (для другой `CDatabase` объекта) или для передачи других сведений зависящие от источника данных. Дополнительные сведения о строках подключения см. в разделе Глава 6 в *Справочник по программированию ODBC*.

Существует возможность попытки подключения к времени ожидания, если, например, узел СУБД недоступен. Если попытка соединения завершается, `OpenEx` вызывает `CDBException`.

### <a name="example"></a>Пример

[!code-cpp[NVC_MFCDatabase#11](../../mfc/codesnippet/cpp/cdatabase-class_7.cpp)]

##  <a name="rollback"></a>  CDatabase::Rollback

Вызовите эту функцию-член для отмены изменений, внесенных во время транзакции.

```
BOOL Rollback();
```

### <a name="return-value"></a>Возвращаемое значение

Ненулевое значение, если транзакция была успешно отменена; в противном случае 0. Если `Rollback` вызов завершается ошибкой, источник данных и транзакции состояний не определены. Если `Rollback` возвращает 0, необходимо проверить источник данных для определения его состояния.

### <a name="remarks"></a>Примечания

Все `CRecordset` `AddNew`, `Edit`, `Delete`, и `Update` вызовы после последнего [BeginTrans](#begintrans) происходит возврат к состоянию, существовавшему на момент вызова.

После вызова `Rollback`, превышает время ожидания транзакции, и необходимо вызвать `BeginTrans` за другой транзакцией. Запись, которая была текущей до вызова `BeginTrans` становится текущей записи еще раз после `Rollback`.

После отката записи, которая была текущей до отката остаются актуальными. Дополнительные сведения о состояние набора записей и источником данных после отката, см. в статье [транзакции (ODBC)](../../data/odbc/transaction-odbc.md).

### <a name="example"></a>Пример

  См. в статье [транзакции: Выполнение транзакции в наборе записей (ODBC)](../../data/odbc/transaction-performing-a-transaction-in-a-recordset-odbc.md).

##  <a name="setlogintimeout"></a>  CDatabase::SetLoginTimeout

Вызовите эту функцию-член — перед вызовом метода `OpenEx` или `Open` , чтобы переопределить значение по умолчанию число секунд, разрешенное данных соединения с источником времени ожидания.

```
void SetLoginTimeout(DWORD dwSeconds);
```

### <a name="parameters"></a>Параметры

*dwSeconds*<br/>
Количество секунд, чтобы разрешить до попытки подключения времени ожидания.

### <a name="remarks"></a>Примечания

Попытка соединения может истечь, если, например, СУБД не поддерживается. Вызовите `SetLoginTimeout` после создания неинициализированный `CDatabase` объекта, но прежде чем обращаться в `OpenEx` или `Open`.

Значение по умолчанию для времени ожидания входа составляет 15 секунд. Не все источники данных поддерживают возможность задать значение времени ожидания входа. Если источник данных не поддерживает время ожидания, вы получите выходные данные трассировки, но не исключение. Значение 0 означает «бесконечность».

##  <a name="setquerytimeout"></a>  CDatabase::SetQueryTimeout

Вызывайте эту функцию члена, чтобы переопределить значение по умолчанию число секунд, чтобы перед выполнением последующих операций на время ожидания источника данных.

```
void SetQueryTimeout(DWORD dwSeconds);
```

### <a name="parameters"></a>Параметры

*dwSeconds*<br/>
Количество секунд, чтобы разрешить до попытки запроса времени ожидания.

### <a name="remarks"></a>Примечания

Операция может время ожидания выполнения из-за проблем доступа к сети, время обработки запроса чрезмерное и т. д. Вызовите `SetQueryTimeout` перед открытием набора записей или до вызова метода набора записей `AddNew`, `Update` или `Delete` функций-членов. Если вы хотите изменить запрашиваемое значение времени ожидания. Этот параметр влияет на все последующие `Open`, `AddNew`, `Update`, и `Delete` вызовы все наборы записей, связанный с данным `CDatabase` объекта. Изменение значение времени ожидания запроса для объекта recordset после открытия не приводит к изменению значения для набора записей. Например, последующие `Move` операции не используют новое значение.

Значение по умолчанию для времени ожидания запросов составляет 15 секунд. Не все источники данных поддерживают возможность установить значение времени ожидания запроса. Если задать значение 0, время ожидания запроса происходит без времени ожидания; обмен данными с источником данных может перестать отвечать на запросы. Такое поведение может быть полезным во время разработки. Если источник данных не поддерживает время ожидания, вы получите выходные данные трассировки, но не исключение.

## <a name="see-also"></a>См. также

[Класс CObject](../../mfc/reference/cobject-class.md)<br/>
[Диаграмма иерархии](../../mfc/hierarchy-chart.md)<br/>
[Класс CRecordset](../../mfc/reference/crecordset-class.md)
