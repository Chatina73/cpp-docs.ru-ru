---
title: TN030. Настройка печати и предварительного просмотра
ms.date: 06/28/2018
f1_keywords:
- vc.print
helpviewer_keywords:
- TN030
- customizing printing and print preview
- printing [MFC], views
- printing views [MFC]
- print preview [MFC], customizing
ms.assetid: 32744697-c91c-41b6-9a12-b8ec01e0d438
ms.openlocfilehash: 09938c5cec2812998d5e76e15154754ad3ac3e0b
ms.sourcegitcommit: 6052185696adca270bc9bdbec45a626dd89cdcdd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/31/2018
ms.locfileid: "50667913"
---
# <a name="tn030-customizing-printing-and-print-preview"></a>TN030. Настройка печати и предварительного просмотра

> [!NOTE]
> Следующее техническое примечание не было обновлено, поскольку сначала оно было включено в электронную документацию. В результате некоторые процедуры и разделы могут быть устаревшими или неверными. Для получения последних сведений рекомендуется выполнить поиск интересующей темы в алфавитном указателе документации в Интернете.

Эта заметка описывает процесс настройки печати и предварительного просмотра и в рамках процедуры обратного вызова, используемый в `CView` и процедуры обратного вызова и функции-члены `CPreviewView`.

## <a name="the-problem"></a>Проблема

MFC предоставляет полноценное решение для большинства печати и предварительного просмотра требуется. В большинстве случаев немного дополнительного кода обязательно должно иметь вид, возможность печати и предварительного просмотра. Тем не менее существуют способы оптимизации печати, требуют значительных усилий со стороны разработчика, и некоторым приложениям требуется добавить конкретных элементов пользовательского интерфейса в режим предварительного просмотра печати.

## <a name="efficient-printing"></a>Эффективный печати

При печати в приложении MFC, с помощью стандартных методов, Windows направляет все вызовы интерфейса графических устройств (GDI) выходных данных метафайла в памяти. Когда `EndPage` — вызове Windows играет метафайла один раз для каждого физического аппаратного контроллера управления, принтер для печати одной страницы. Во время этой визуализации GDI часто выполняются запросы процедуры отмены, чтобы определить, если ему следует продолжить. Обычно процедуры прерывания позволяет сообщениям обрабатываться таким образом, пользователь может прервать задание печати, с помощью диалогового окна печати.

К сожалению это может замедлить процесс печати. Если печать в приложении должен быть быстрее, чем можно сделать при помощи стандартным способом, необходимо реализовать вручную чередования.

## <a name="print-banding"></a>Печать чередования

Чтобы вручную полосы, необходимо повторно реализовать цикл печати таким образом, чтобы `OnPrint` вызывается несколько раз на каждой странице (один раз в составе пакета обновления). Цикл печати реализуется в `OnFilePrint` функции в viewprnt.cpp. В вашей `CView`-производного класса, чтобы элемент карты сообщений для обработки команд печати вызывает функцию печати перегрузке этой функции. Копировать `OnFilePrint` подпрограммы и изменение цикла печати для реализации чередования. Вы, вероятно, будет также требуется передать чередования прямоугольник для функций печати, таким образом, вы можете оптимизировать зависимости от области печати страницы документа.

Во-вторых, часто необходимо вызвать `QueryAbort` при рисовании аппаратного контроллера управления. В противном случае процедура прервать вызван не будет, и пользователь сможет отменить задание печати.

## <a name="print-preview-electronic-paper-with-user-interface"></a>Предварительный просмотр печати: Электронного документа с пользовательским интерфейсом

Предварительный просмотр, по сути, пытается включить отображение в эмуляции принтера. По умолчанию клиентской области главного окна используется для отображения одного или двух страниц, полностью в пределах окна. Пользователь имеет возможность увеличить область страницы, чтобы увидеть, как это более подробно. С дополнительной поддержкой пользователь может даже быть разрешено редактирование документа в режиме предварительного просмотра.

## <a name="customizing-print-preview"></a>Настройка предварительного просмотра

Эта заметка имеет дело только с одним аспектом предварительного изменения: Добавление пользовательского интерфейса в режиме предварительного просмотра. Возможны и другие изменения, но такие изменения выходят за рамки данной статьи.

## <a name="to-add-ui-to-the-preview-mode"></a>Добавление пользовательского интерфейса в режиме предварительного просмотра

1. Производный от класса представления `CPreviewView`.

2. Добавьте обработчики команд для аспектов пользовательского интерфейса, которые необходимы.

3. При добавлении визуальных характеристик для отображения переопределить `OnDraw` и выполнять документ после вызова метода `CPreviewView::OnDraw`.

## <a name="onfileprintpreview"></a>OnFilePrintPreview

Это обработчик команд для предварительного просмотра печати. Его реализация по умолчанию выглядит так:

```cpp
void CView::OnFilePrintPreview()
{
    // In derived classes, implement special window handling here
    // Be sure to Unhook Frame Window close if hooked.

    // must not create this on the frame. Must outlive this function
    CPrintPreviewState* pState = new CPrintPreviewState;

    if (!DoPrintPreview(AFX_IDD_PREVIEW_TOOLBAR, this,
        RUNTIME_CLASS(CPreviewView), pState))
    {
        // In derived classes, reverse special window handling
        // here for Preview failure case

        TRACE0("Error: DoPrintPreview failed");
        AfxMessageBox(AFX_IDP_COMMAND_FAILURE);
        delete pState;  // preview failed to initialize, delete State now
    }
}
```

`DoPrintPreview` будет скрыт на главной панели приложения. Панели элементов управления, такие как строка состояния, могут храниться, указывая их в состояния производительности "->"*dwStates* член (это битовая маска и биты для отдельных панелей определены AFX_CONTROLBAR_MASK (AFX_IDW_MYBAR)). Окно состояния производительности "->"*nIDMainPane* является окном, которое будет автоматически скрыто и reshown. `DoPrintPreview` Затем создается строка кнопок для стандартный пользовательский Интерфейс предварительной версии. Если требуется специальное окно обработки, например, скрыть или отобразить другие окна, которые следует выполнить до `DoPrintPreview` вызывается.

По умолчанию по завершении предварительного возвращается панелей элементов управления в исходное состояние и главной области, чтобы видимым. Если необходима специальная обработка, ее следует применять в переопределении `EndPrintPreview`. Если `DoPrintPreview` не работает, также укажите специальной обработки.

DoPrintPreview вызывается с:

- Идентификатор ресурса шаблона диалогового окна для панели инструментов предварительного просмотра.

- Указатель на представлении, чтобы выполнять печать для предварительного просмотра печати.

- Класс среды выполнения класс Предварительный просмотр. Это будет динамически создан в DoPrintPreview.

- Указатель CPrintPreviewState. Обратите внимание, что структура CPrintPreviewState (или производный структуры, если приложению требуются дополнительные состояния, сохраненного) необходимо *не* создаваться в кадре. DoPrintPreview является немодальной и этой структуры должны выдерживать, пока не будет вызван EndPrintPreview.

  > [!NOTE]
  > Отдельное представление или класс представления при необходимости для поддержки печати, указатель на объект должны передаваться в качестве второго параметра.

## <a name="endprintpreview"></a>EndPrintPreview

Это называется для режима предварительного просмотра печати. Часто желательно, чтобы перейти на страницу в документе, который отображался в режиме предварительного просмотра последнего. `EndPrintPreview` — приложения шанс сделать это. "->" PInfo*m_nCurPage* член по странице, который был отображен последний (крайний слева, если две страницы отображались), которое указатель указание относительно которых на странице пользователя было нужно. Так как структура представления приложения неизвестен к .NET framework, то необходимо указать код, чтобы перейти к выбранной точке.

Следует выполнять большинство операций перед вызовом `CView::EndPrintPreview`. Этот вызов отменяет результаты `DoPrintPreview` и удаляет pView, основного контроллера домена и pInfo.

```cpp
// Any further cleanup should be done here.
CView::EndPrintPreview(pDC, pInfo, point, pView);
```

## <a name="cwinapponfileprintsetup"></a>CWinApp::OnFilePrintSetup

Это должны быть сопоставлены для пункта меню Параметры печати. В большинстве случаев не требуется переопределять реализацию.

## <a name="page-nomenclature"></a>Номенклатура страницы

Еще одна проблема — это нумерацию страниц и порядок. Для приложений типа простой текстовый процессор это просто проблема. Большинство систем предварительного предполагается, что каждой отпечатанной странице соответствует одной страницы в документе.

При попытке создания универсального решения, которые следует учитывать несколько моментов. Представьте систему САПР. У пользователя есть, охватывающей несколько листов E-размер рисунка. На размере E (или меньшего размера, масштабировании) плоттера, нумерацию страниц может быть как в случае простой. Но на лазерном принтере, печать 16 A размер страницы на листе, что предварительного учитывает «страница»

Как говорится в вводный абзац, предварительный просмотр печати действует как принтер. Таким образом пользователь будет видеть, что недр определенного принтера, который выбран. Возлагается представление, чтобы определить, какой образ выводится на каждой странице.

Строка описания страницы в `CPrintInfo` структура предоставляет средства отображения номер страницы для пользователя, если он может быть представлено как одно число на одной странице (как в «Страница 1» или «страницы 1-2»). Эта строка используется в реализации по умолчанию из `CPreviewView::OnDisplayPageNumber`. Если требуется другое отображаемое один может переопределить это виртуальная функция, чтобы указать, например, «Лист1 разделах A, B».

## <a name="see-also"></a>См. также

[Технические примечания по номеру](../mfc/technical-notes-by-number.md)<br/>
[Технические примечания по категории](../mfc/technical-notes-by-category.md)
