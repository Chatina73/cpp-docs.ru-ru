---
description: 'Дополнительные сведения о: TN030: Настройка печати и предварительного просмотра печати'
title: TN030. Настройка печати и предварительного просмотра
ms.date: 06/28/2018
f1_keywords:
- vc.print
helpviewer_keywords:
- TN030
- customizing printing and print preview
- printing [MFC], views
- printing views [MFC]
- print preview [MFC], customizing
ms.assetid: 32744697-c91c-41b6-9a12-b8ec01e0d438
ms.openlocfilehash: 6fc0571b908f85b24b8a0752a00842077d537dce
ms.sourcegitcommit: d6af41e42699628c3e2e6063ec7b03931a49a098
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2020
ms.locfileid: "97215616"
---
# <a name="tn030-customizing-printing-and-print-preview"></a>TN030. Настройка печати и предварительного просмотра

> [!NOTE]
> Следующее техническое примечание не было обновлено, поскольку сначала оно было включено в электронную документацию. В результате некоторые процедуры и разделы могут быть устаревшими или неверными. Для получения последних сведений рекомендуется выполнить поиск интересующей темы в алфавитном указателе документации в Интернете.

В этом заметке описывается процесс настройки печати и предварительного просмотра печати, а также описание целей подпрограмм обратного вызова, используемых в `CView` , и процедур обратного вызова и функций элементов `CPreviewView` .

## <a name="the-problem"></a>Проблема

MFC предоставляет полное решение для большинства задач печати и предварительного просмотра печати. В большинстве случаев для просмотра и предварительного просмотра может потребоваться небольшой дополнительный код. Однако существуют способы оптимизации печати, требующие значительных усилий в части разработчика, а некоторым приложениям необходимо добавить определенные элементы пользовательского интерфейса в режим предварительного просмотра.

## <a name="efficient-printing"></a>Эффективная печать

Когда приложение MFC печатает с использованием стандартных методов, Windows направляет все выходные вызовы GDI в метафайл в памяти. При `EndPage` вызове Windows воспроизводит метафайл один раз для каждого физического диапазона, требуемого принтером для печати одной страницы. Во время этой отрисовки GDI часто запрашивает процедуру прерывания, чтобы определить, должна ли она продолжаться. Обычно процедура Abort позволяет обрабатывать сообщения, чтобы пользователь мог прервать задание печати с помощью диалогового окна печати.

К сожалению, это может замедлять процесс печати. Если печать в приложении должна быть быстрее, чем может быть достигнута с помощью стандартного метода, необходимо реализовать ручное чередование.

## <a name="print-banding"></a>Полоса печати

Для ручного управления необходимо повторно реализовать цикл печати, который `OnPrint` вызывается несколько раз для каждой страницы (один раз для каждого диапазона). Цикл печати реализуется в `OnFilePrint` функции в виевпрнт. cpp. В `CView` классе, производном от класса, вы передаете эту функцию таким образом, чтобы запись схемы сообщений для обработки команды Print вызывала функцию печати. Скопируйте `OnFilePrint` подпрограммы и измените цикл печати, чтобы реализовать чередование. Вам, вероятно, потребуется передать прямоугольник с чередованием в функции печати, чтобы можно было оптимизировать рисование на основе раздела печатаемой страницы.

Во вторых, при `QueryAbort` рисовании полосы необходимо часто вызывать. В противном случае процедура Abort не будет вызываться и пользователь не сможет отменить задание печати.

## <a name="print-preview-electronic-paper-with-user-interface"></a>Предварительный просмотр: электронный документ с пользовательским интерфейсом

Предварительный просмотр, по сути, пытается превратить экран в эмуляцию принтера. По умолчанию клиентская область главного окна используется для того, чтобы в окне полностью отображалась одна или две страницы. Пользователь может увеличить область страницы, чтобы увидеть ее более подробно. Благодаря дополнительной поддержке пользователю даже может быть разрешено изменять документ в режиме предварительного просмотра.

## <a name="customizing-print-preview"></a>Настройка предварительного просмотра печати

В этой заметке действует только один аспект изменения режима предварительного просмотра: Добавление пользовательского интерфейса в режим предварительного просмотра. Возможны другие изменения, но эти изменения выходят за рамки данного обсуждения.

## <a name="to-add-ui-to-the-preview-mode"></a>Добавление пользовательского интерфейса в режим предварительного просмотра

1. Создайте производный класс представления от `CPreviewView` .

2. Добавьте обработчики команд для нужных аспектов пользовательского интерфейса.

3. При добавлении визуальных аспектов к отображению Переопределите `OnDraw` и выполните Рисование после вызова метода `CPreviewView::OnDraw` .

## <a name="onfileprintpreview"></a>онфилепринтпревиев

Это обработчик команд для предварительного просмотра. Реализация по умолчанию:

```cpp
void CView::OnFilePrintPreview()
{
    // In derived classes, implement special window handling here
    // Be sure to Unhook Frame Window close if hooked.

    // must not create this on the frame. Must outlive this function
    CPrintPreviewState* pState = new CPrintPreviewState;

    if (!DoPrintPreview(AFX_IDD_PREVIEW_TOOLBAR, this,
        RUNTIME_CLASS(CPreviewView), pState))
    {
        // In derived classes, reverse special window handling
        // here for Preview failure case

        TRACE0("Error: DoPrintPreview failed");
        AfxMessageBox(AFX_IDP_COMMAND_FAILURE);
        delete pState;  // preview failed to initialize, delete State now
    }
}
```

`DoPrintPreview` скрывает основную область приложения. Панели управления, например строка состояния, можно хранить, указывая их в элементе Пстате->*двстатес* (это битовая маска, а биты отдельных панелей элементов управления определяются AFX_CONTROLBAR_MASK (AFX_IDW_MYBAR)). Окно Пстате->*нидмаинпане* — это окно, которое будет автоматически скрыто и показано повторно. `DoPrintPreview` затем создаст панель кнопок для стандартного пользовательского интерфейса предварительной версии. Если требуется обработка специальных окон, например, для скрытия или отображения других окон, необходимо выполнить перед `DoPrintPreview` вызовом метода.

По умолчанию, когда предварительный просмотр печати завершается, он возвращает панели элементов управления в исходное состояние, а основную панель — видимой. Если требуется специальная обработка, ее следует выполнять в переопределении `EndPrintPreview` . `DoPrintPreview`В случае сбоя также обеспечивается специальная обработка.

Допринтпревиев вызывается с:

- Идентификатор ресурса шаблона диалогового окна для панели инструментов предварительного просмотра.

- Указатель на представление для выполнения печати предварительного просмотра.

- Класс времени выполнения класса представления предварительного просмотра. Он будет создан динамически в Допринтпревиев.

- Указатель Кпринтпревиевстате. Обратите внимание, что структура Кпринтпревиевстате (или производная структура, если приложению требуется дополнительное состояние) *не* должно быть создано в кадре. Допринтпревиев является немодальным, и эта структура должна сохраняться до тех пор, пока не будет вызван Ендпринтпревиев.

  > [!NOTE]
  > Если для поддержки печати требуется отдельное представление или класс представления, указатель на этот объект должен быть передан как второй параметр.

## <a name="endprintpreview"></a>ендпринтпревиев

Этот метод вызывается для завершения режима предварительного просмотра печати. Часто желательно перейти на страницу в документе, который был последний раз отображался в режиме предварительного просмотра. `EndPrintPreview` является шансом приложения сделать это. Элемент Пинфо->*m_nCurPage* — это страница, которая была последний раз отображена (крайний левый, если отображались две страницы), а указатель является подсказкой, где на странице, которую заинтересовал пользователь. Так как структура представления приложения неизвестна для платформы, необходимо указать код для перехода к выбранной точке.

Перед вызовом следует выполнить большинство действий `CView::EndPrintPreview` . Этот вызов изменяет последствия `DoPrintPreview` и удаляет pView, PDC и пинфо.

```cpp
// Any further cleanup should be done here.
CView::EndPrintPreview(pDC, pInfo, point, pView);
```

## <a name="cwinapponfileprintsetup"></a>CWinApp:: Онфилепринтсетуп

Этот элемент должен быть сопоставлен с пунктом меню «Настройка печати». В большинстве случаев переопределение реализации не требуется.

## <a name="page-nomenclature"></a>Страничная номенклатура

Другой проблемой является нумерация страниц и их порядок. Для приложений простого текстового процессора это простая проблема. В большинстве систем предварительной версии предполагается, что каждая напечатанная страница соответствует одной странице документа.

При попытке предоставить обобщенное решение необходимо учитывать несколько моментов. Представьте себе систему САПР. У пользователя есть рисунок, охватывающий несколько листов с электронным размером. Для плоттера E-size (или меньшего масштабированного) нумерация страниц будет так же, как в простом случае. Но на лазерном принтере при печати 16-страничных страниц на листе, что делает предварительный просмотр, рассмотрим «страницу»

Как и в случае с вводным абзацом, предварительный просмотр действует как принтер. Поэтому пользователь увидит, что будет выведено из выбранного принтера. Это представление позволяет определить, какое изображение печатается на каждой странице.

Строка описания страницы в `CPrintInfo` структуре предоставляет способ отображения номера страницы пользователю, если он может быть представлен одним числом на страницу (например, "стр. 1" или "pages 1-2"). Эта строка используется реализацией по умолчанию `CPreviewView::OnDisplayPageNumber` . Если требуется другое отображение, можно переопределить эту виртуальную функцию, чтобы предоставить, например, "Sheet1, Sections A, B".

## <a name="see-also"></a>См. также раздел

[Технические примечания по номеру](../mfc/technical-notes-by-number.md)<br/>
[Технические примечания по категориям](../mfc/technical-notes-by-category.md)
