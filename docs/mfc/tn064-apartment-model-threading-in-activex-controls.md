---
title: TN064. Потоки изолированной модели в элементах управления ActiveX
ms.date: 11/04/2016
helpviewer_keywords:
- OLE controls [MFC], container support
- containers [MFC], multithreaded
- TN064 [MFC]
- multithread container [MFC]
- apartment model threading [MFC]
ms.assetid: b2ab4c88-6954-48e2-9a74-01d4a60df073
ms.openlocfilehash: 0c6a42124b4b2b03ae7cd9277fa14d43eac7a2bb
ms.sourcegitcommit: c123cc76bb2b6c5cde6f4c425ece420ac733bf70
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81366061"
---
# <a name="tn064-apartment-model-threading-in-activex-controls"></a>TN064. Потоки изолированной модели в элементах управления ActiveX

> [!NOTE]
> Следующее техническое примечание не было обновлено, поскольку сначала оно было включено в электронную документацию. В результате некоторые процедуры и разделы могут быть устаревшими или неверными. Для получения последних сведений рекомендуется выполнить поиск интересующей темы в алфавитном указателе документации в Интернете.

В этой технической записке объясняется, как включить резьбу по модели апартаментов в элементе управления ActiveX. Обратите внимание, что резьба по модели квартиры поддерживается только в версиях Visual C'2 или позже.

## <a name="what-is-apartment-model-threading"></a>Что такое квартира-модель резьбы

Модель апартаментов представляет собой подход к поддержке встроенных объектов, таких как элементы управления ActiveX, в многопоточном контейнерном приложении. Хотя приложение может иметь несколько потоков, каждый экземпляр встроенного объекта будет назначен одной "квартире", которая будет выполняться только на одном потоке. Другими словами, все вызовы в экземпляр элемента управления будут происходить в одном потоке.

Однако различные экземпляры одного и того же типа контроля могут быть назначены разным квартирам. Таким образом, если несколько экземпляров элемента управления разделяют любые общие данные (например, статические или глобальные данные), то доступ к этим общим данным должен быть защищен объектом синхронизации, например критическим разделом.

Для получения полной информации о модели резьбы по квартире, пожалуйста, смотрите [Процессы и темы](/windows/win32/ProcThread/processes-and-threads) в *справке ПРОГРАММИСТа OLE*.

## <a name="why-support-apartment-model-threading"></a>Почему поддержка Квартира-Модель Резьба

Элементы управления, поддерживающие потоковую часть модели апартаментов, могут использоваться в многопоточных контейнерных приложениях, которые также поддерживают модель апартаментов. Если вы не включаете резьбу по модели квартиры, вы ограничите потенциальный набор контейнеров, в которых может быть использован ваш элемент управления.

Включение резьбы по модели апартаментов легко для большинства элементов управления, особенно если они имеют мало или вообще не имеют общих данных.

## <a name="protecting-shared-data"></a>Защита общих данных

Если элемент управления использует общие данные, такие как статическая переменная члена, доступ к этим данным должен быть защищен критическим разделом, чтобы предотвратить изменение данных в течение нескольких раз. Чтобы настроить критический раздел для этой цели, объявить статическую переменную элемента класса `CCriticalSection` в классе элемента управления. Используйте `Lock` `Unlock` функции и функции членов этого важного объекта раздела, где бы ваш код не был доступом к общим данным.

Рассмотрим, например, класс управления, который должен поддерживать строку, которая является общей для всех экземпляров. Эта строка может быть сохранена в статической переменной члена и защищена критическим разделом. Классная декларация управления будет содержать следующее:

```cpp
class CSampleCtrl : public COleControl
{
...
    static CString _strShared;
    static CCriticalSection _critSect;
};
```

Реализация для класса будет включать определения для этих переменных:

```cpp
int CString CSampleCtrl::_strShared;
CCriticalSection CSampleCtrl::_critSect;
```

Доступ к `_strShared` статическому члену может быть защищен критическим разделом:

```cpp
void CSampleCtrl::SomeMethod()
{
    _critSect.Lock();
if (_strShared.Empty())
    _strShared = "<text>";
    _critSect.Unlock();

...
}
```

## <a name="registering-an-apartment-model-aware-control"></a>Регистрация квартиры-модель-осознавая управления

Элементы управления, поддерживающие потоки квартиры-модели, должны указывать эту возможность в реестре, добавляя названное значение "ThreadingModel" со значением "Apartment" в их регистрационном реестре класса ID под ключом *класса id*\\**InprocServer32.** Чтобы вызвать автоматику по автоматической регистрации этого ключа, передайте флаг `AfxOleRegisterControlClass` *afxRegApartmentThreading* в шестом параметре:

```cpp
BOOL CSampleCtrl::CSampleCtrlFactory::UpdateRegistry(BOOL bRegister)
{
    if (bRegister)
    return AfxOleRegisterControlClass(
    AfxGetInstanceHandle(),
    m_clsid,
    m_lpszProgID,
    IDS_SAMPLE,
    IDB_SAMPLE,
    afxRegApartmentThreading,
    _dwSampleOleMisc,
    _tlid,
    _wVerMajor,
    _wVerMinor);

else
    return AfxOleUnregisterClass(m_clsid,
    m_lpszProgID);

}
```

Если ваш проект управления был создан ControlWizard в визуальной версии 4.1 или позже, этот флаг уже будет присутствовать в вашем коде. Для регистрации модели потоков не требуется никаких изменений.

Если ваш проект был создан более ранней версией ControlWizard, существующий код будет иметь значение Boolean в качестве шестого параметра. Если существующий параметр является правдой, измените его на *afxRegInsertable s afxRegApartmentThreading.* Если существующий параметр FALSE, измените его на *afxRegApartmentThreading.*

Если ваш элемент управления не соответствует правилам для резьбы по квартире-модели, вы не должны проходить *afxRegApartmentThreading* в этом параметре.

## <a name="see-also"></a>См. также раздел

[Технические примечания по номеру](../mfc/technical-notes-by-number.md)<br/>
[Технические заметки по категориям](../mfc/technical-notes-by-category.md)
