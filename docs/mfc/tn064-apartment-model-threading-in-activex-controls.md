---
title: TN064. Потоки изолированной модели в элементах управления ActiveX
ms.date: 11/04/2016
helpviewer_keywords:
- OLE controls [MFC], container support
- containers [MFC], multithreaded
- TN064 [MFC]
- multithread container [MFC]
- apartment model threading [MFC]
ms.assetid: b2ab4c88-6954-48e2-9a74-01d4a60df073
ms.openlocfilehash: f490e82e179da4614eea345136a9edfb1d320705
ms.sourcegitcommit: 63784729604aaf526de21f6c6b62813882af930a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/17/2020
ms.locfileid: "79442111"
---
# <a name="tn064-apartment-model-threading-in-activex-controls"></a>TN064. Потоки изолированной модели в элементах управления ActiveX

> [!NOTE]
>  Следующее техническое примечание не было обновлено, поскольку сначала оно было включено в электронную документацию. В результате некоторые процедуры и разделы могут быть устаревшими или неверными. Для получения последних сведений рекомендуется выполнить поиск интересующей темы в алфавитном указателе документации в Интернете.

В этом техническом примечании объясняется, как включить потоковую модель потоков в элементе управления ActiveX. Обратите внимание, что потоковые модели потоков поддерживаются только C++ в Visual versions 4,2 или более поздней версии.

## <a name="what-is-apartment-model-threading"></a>Что такое потоковая модель-контейнер

Модель подразделения является подходом к поддержке внедренных объектов, таких как элементы управления ActiveX, в многопоточном приложении-контейнере. Несмотря на то, что приложение может иметь несколько потоков, каждый экземпляр внедренного объекта будет назначен одному «апартаменту», который будет выполняться только в одном потоке. Иными словами, все вызовы к экземпляру элемента управления будут выполняться в одном потоке.

Однако разные подразделения могут назначать различные экземпляры одного и того же типа элементов управления. Таким образом, если несколько экземпляров элемента управления совместно используют общие данные (например, статические или глобальные), доступ к этим общим данным должен быть защищен объектом синхронизации, например критическим разделом.

Подробные сведения о потоковой модели апартамента см. в разделе [процессы и потоки](/windows/win32/ProcThread/processes-and-threads) в *справочнике по программированию для OLE*.

## <a name="why-support-apartment-model-threading"></a>Почему поддерживается потоковая модель подразделения

Элементы управления, поддерживающие потоковую модель потоков, можно использовать в многопоточных приложениях-контейнерах, которые также поддерживают модель подразделения. Если не включить потоковую модель потоков, вы сможете ограничить потенциальный набор контейнеров, в которых может использоваться элемент управления.

Включение потоков с замкнутой моделью — это простой для большинства элементов управления, особенно в том случае, если общие данные не имеют большого объема или вообще нет.

## <a name="protecting-shared-data"></a>Защита общих данных

Если элемент управления использует общие данные, например статическую переменную-член, доступ к этим данным должен быть защищен с помощью критической секции, чтобы предотвратить одновременное изменение данных несколькими потоками. Чтобы настроить критическую секцию для этой цели, объявите в классе элемента управления статическую переменную-член класса `CCriticalSection`. Используйте функции члена `Lock` и `Unlock` этого объекта критического раздела везде, где ваш код обращается к общим данным.

Рассмотрим, например, класс элемента управления, который должен поддерживать строку, совместно используемую всеми экземплярами. Эта строка может быть сохранена в статической переменной-члене и защищена критической секцией. Объявление класса элемента управления будет содержать следующее:

```
class CSampleCtrl : public COleControl
{
...
    static CString _strShared;
    static CCriticalSection _critSect;
};
```

Реализация класса будет включать определения для этих переменных:

```
int CString CSampleCtrl::_strShared;
CCriticalSection CSampleCtrl::_critSect;
```

Доступ к `_strShared` статическому члену можно защитить с помощью критического раздела:

```
void CSampleCtrl::SomeMethod()
{
    _critSect.Lock();
if (_strShared.Empty())
    _strShared = "<text>";
    _critSect.Unlock();

...
}
```

## <a name="registering-an-apartment-model-aware-control"></a>Регистрация элемента управления с поддержкой модели подразделения

Элементы управления, поддерживающие потоковую модель потоков, должны указать эту возможность в реестре, добавив именованное значение "ThreadingModel" со значением "апартамент" в запись реестра идентификатора класса в разделе *ID класса*\\**InprocServer32** Key. Чтобы сделать этот ключ автоматически зарегистрированным для вашего элемента управления, передайте флаг *afxRegApartmentThreading* в шестом параметре в `AfxOleRegisterControlClass`:

```
BOOL CSampleCtrl::CSampleCtrlFactory::UpdateRegistry(BOOL bRegister)
{
    if (bRegister)
    return AfxOleRegisterControlClass(
    AfxGetInstanceHandle(),
    m_clsid,
    m_lpszProgID,
    IDS_SAMPLE,
    IDB_SAMPLE,
    afxRegApartmentThreading,
    _dwSampleOleMisc,
    _tlid,
    _wVerMajor,
    _wVerMinor);

else
    return AfxOleUnregisterClass(m_clsid,
    m_lpszProgID);

}
```

Если проект элемента управления был создан с помощью Контролвизард в C++ Visual версии 4,1 или более поздней, этот флаг уже будет присутствовать в коде. Для регистрации потоковой модели изменения не требуются.

Если проект был создан с помощью более ранней версии Контролвизард, существующий код будет иметь логическое значение в качестве шестого параметра. Если существующий параметр имеет значение TRUE, измените его на *afxRegInsertable | afxRegApartmentThreading*. Если существующий параметр имеет значение FALSE, измените его на *afxRegApartmentThreading*.

Если элемент управления не соответствует правилам потоковой модели потоков, в этом параметре не следует передавать *afxRegApartmentThreading* .

## <a name="see-also"></a>См. также раздел

[Технические примечания по номеру](../mfc/technical-notes-by-number.md)<br/>
[Технические примечания по категории](../mfc/technical-notes-by-category.md)
