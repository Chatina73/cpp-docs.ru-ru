---
title: 'Серверы автоматизации: Ошибки времени существования объекта'
ms.date: 11/04/2016
helpviewer_keywords:
- objects [MFC], lifetime
- lifetime, automation server
- Automation servers, object lifetime
- servers, lifetime of Automation
ms.assetid: 342baacf-4015-4a0e-be2f-321424f1cb43
ms.openlocfilehash: 74b4bf87b512d35c99942f4aa36174a8673079c5
ms.sourcegitcommit: fcb48824f9ca24b1f8bd37d647a4d592de1cc925
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/15/2019
ms.locfileid: "69509186"
---
# <a name="automation-servers-object-lifetime-issues"></a>Серверы автоматизации: Ошибки времени существования объекта

Когда клиент автоматизации создает или активирует OLE-элемент, сервер передает клиенту указатель на этот объект. Клиент устанавливает ссылку на объект с помощью вызова функции OLE [IUnknown:: AddRef](/windows/win32/api/unknwn/nf-unknwn-iunknown-addref). Эта ссылка действует до тех пор, пока клиент не вызовет метод [IUnknown:: Release](/windows/win32/api/unknwn/nf-unknwn-iunknown-release). (Клиентские приложения, написанные с помощью классов OLE библиотека Microsoft Foundation Class, не должны выполнять эти вызовы, так как платформа делает это.) Система OLE и сам сервер могут устанавливать ссылки на объект. Сервер не должен уничтожить объект при условии, что внешние ссылки на объект остаются в силе.

Платформа поддерживает внутреннее количество ссылок на любой объект сервера, производный от [от CCmdTarget](../mfc/reference/ccmdtarget-class.md). Этот счетчик обновляется, когда клиент автоматизации или другая сущность добавляет или освобождает ссылку на объект.

Когда счетчик ссылок станет равным 0, платформа вызывает виртуальную функцию [от CCmdTarget:: онфиналрелеасе](../mfc/reference/ccmdtarget-class.md#onfinalrelease). Реализация по умолчанию этой функции вызывает оператор **Delete** для удаления этого объекта.

Библиотека Microsoft Foundation Class предоставляет дополнительные средства для управления поведением приложения, когда внешние клиенты имеют ссылки на объекты приложения. Помимо поддержания числа ссылок на каждый объект, серверы поддерживают глобальное количество активных объектов. Глобальные функции [AfxOleLockApp](../mfc/reference/application-control.md#afxolelockapp) и [AfxOleUnlockApp](../mfc/reference/application-control.md#afxoleunlockapp) обновляют количество активных объектов в приложении. Если это значение счетчика не равно нулю, приложение не завершает работу, когда пользователь выбирает пункт меню «закрыть» или «выход» из меню «файл». Вместо этого главное окно приложения скрыто (но не уничтожается) до тех пор, пока не будут завершены все ожидающие запросы клиентов. Как правило `AfxOleLockApp` , `AfxOleUnlockApp` и вызываются в конструкторах и деструкторах соответственно классам, поддерживающим автоматизацию.

Иногда в некоторых случаях происходит принудительное завершение работы сервера, когда у клиента по-прежнему есть ссылка на объект. Например, ресурс, от которого зависит сервер, может стать недоступным, что приведет к возникновению ошибки на сервере. Пользователь также может закрыть серверный документ, содержащий объекты, на которые имеются ссылки в других приложениях.

В Windows SDK см. раздел `IUnknown::AddRef` и `IUnknown::Release`.

## <a name="see-also"></a>См. также

[Серверы автоматизации](../mfc/automation-servers.md)<br/>
[афксолеканекситапп](../mfc/reference/application-control.md#afxolecanexitapp)
