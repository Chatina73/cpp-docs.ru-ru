---
title: Набор записей. Параметризация набора записей (ODBC)
ms.date: 05/09/2019
helpviewer_keywords:
- parameterizing recordsets
- ODBC recordsets, parameterizing
- recordsets, parameterizing
- passing parameters, to queries at runtime
ms.assetid: 7d1dfeb6-5ee0-45e2-aacc-63bc52a465cd
ms.openlocfilehash: ec4198c283700daa2e02e2507b9874eaf02858e9
ms.sourcegitcommit: 857fa6b530224fa6c18675138043aba9aa0619fb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2020
ms.locfileid: "80212814"
---
# <a name="recordset-parameterizing-a-recordset-odbc"></a>Набор записей. Параметризация набора записей (ODBC)

Этот раздел относится к классам ODBC библиотеки MFC.

В некоторых случаях вам может потребоваться возможность осуществлять выбор записей во время выполнения на основе информации, которая была получена по результатам вычислений или введена конечным пользователем. В таких случаях можно использовать параметры набора записей.

В этом разделе рассматриваются следующие вопросы.

- [Цель параметризации набора записей](#_core_parameterized_recordsets).

- [Ситуации и причины, по которым может потребоваться параметризация набора записей](#_core_when_to_use_parameters).

- [Объявление элементов данных параметра в классе набора записей](#_core_parameterizing_your_recordset_class).

- [Передача данных параметра в объект набора записей во время выполнения](#_core_passing_parameter_values_at_run_time).

##  <a name="parameterized-recordsets"></a><a name="_core_parameterized_recordsets"></a> Параметризованные наборы записей

Параметризованные наборы записей поддерживают передачу параметров во время выполнения. Это дает два важных преимущества.

- Возможность повышения скорости выполнения.

- Возможность создавать запросы во время выполнения на основе сведений, которые не были доступны на этапе разработки и были получены по результатам вычислений или введены пользователем.

При вызове метода `Open` для выполнения запроса набор записей использует данные параметра для заполнения инструкции **SQL SELECT**. Параметризация поддерживается для любых наборов записей.

##  <a name="when-to-use-parameters"></a><a name="_core_when_to_use_parameters"></a> Ситуации, в которых следует использовать параметры

Как правило, параметры используются в следующих случаях.

- Передача аргументов времени выполнения в предопределенный запрос.

   Чтобы передать параметры в хранимую процедуру, необходимо указать полную настраиваемую инструкцию ODBC **CALL** с заполнителями параметров при вызове метода `Open`. Таким образом переопределяется заданная по умолчанию инструкция SQL для набора записей. Дополнительные сведения см. в разделе [CRecordset:: Open](../../mfc/reference/crecordset-class.md#open) в *справочнике по библиотеке классов* и [SQL: Настройка инструкции SQL набора записей (ODBC)](../../data/odbc/sql-customizing-your-recordsets-sql-statement-odbc.md) и [набора записей: объявление класса для предопределенного запроса (ODBC)](../../data/odbc/recordset-declaring-a-class-for-a-predefined-query-odbc.md).

- Эффективное выполнение множества повторных запросов с использованием различных сведений о параметрах.

   Например, каждый раз, когда конечный пользователь пытается найти информацию о конкретном учащемся в соответствующей базе данных, вы можете указывать имя или идентификатор учащегося в качестве введенного пользователем параметра. Затем при вызове функции-члена `Requery` для набора записей этот запрос будет извлекать только запись указанного учащегося.

   Строка фильтра для набора записей, хранящаяся в `m_strFilter`, может иметь следующий вид:

    ```cpp
    "StudentID = ?"
    ```

   Предположим, идентификатор учащегося указан в переменной `strInputID`. Если присвоить параметру значение `strInputID` (например, для идентификатора учащегося 100), значение переменной привязывается к заполнителю параметра, который представлен в строке фильтра знаком "?".

   Присвойте значение параметра следующим образом:

    ```cpp
    strInputID = "100";
    ...
    m_strParam = strInputID;
    ```

   Настраивать строку фильтра таким образом не рекомендуется:

    ```cpp
    m_strFilter = "StudentID = 100";   // 100 is incorrectly quoted
                                       // for some drivers
    ```

   Описание того, как правильно использовать кавычки для строк фильтрации, см. в разделе [набор записей: Фильтрация записей (ODBC)](../../data/odbc/recordset-filtering-records-odbc.md).

   Значение параметра будет изменяться каждый раз, когда вы будете отправлять запрос к набору записей для нового идентификатора учащегося.

   > [!TIP]
   > Использование параметров намного эффективнее применения обычного фильтра. При работе с параметризованным набором записей база данных обрабатывает инструкцию SQL **SELECT** всего один раз. Для отфильтрованного набора записей без параметров инструкция **SELECT** обрабатывается каждый раз при выполнении `Requery` с новым значением фильтра.

Дополнительные сведения о фильтрах см. в разделе [набор записей: Фильтрация записей (ODBC)](../../data/odbc/recordset-filtering-records-odbc.md).

##  <a name="parameterizing-your-recordset-class"></a><a name="_core_parameterizing_your_recordset_class"></a> Параметризация класса набора записей

> [!NOTE]
> Этот раздел относится к объектам, производным от `CRecordset`, в которых пакетная выборка строк не реализована. Если вы используете пакетную выборку строк, реализация параметров осуществляется схожим образом. Дополнительные сведения см. [в разделе набор записей: групповая выборка записей (ODBC)](../../data/odbc/recordset-fetching-records-in-bulk-odbc.md).

Прежде чем создавать класс набора записей, определите, какие параметры вам потребуются, какие типы данных они будут иметь, а также как они будут использоваться набором записей.

#### <a name="to-parameterize-a-recordset-class"></a>Параметризация класса набора записей

> [!NOTE]
> Мастер потребителя MFC ODBC недоступен в Visual Studio 2019 и более поздних версиях. Его функции по-прежнему можно реализовать вручную.

1. Чтобы создать нужный класс, запустите [мастер потребителя MFC ODBC](../../mfc/reference/adding-an-mfc-odbc-consumer.md) из диалогового окна **Добавить класс**.

1. Укажите элементы данных поля для столбцов набора записей.

1. После того как мастер запишет класс в файл вашего проекта, перейдите к H-файлу и вручную добавьте нужные элементы данных параметра в объявление класса. Это можно сделать, как показано в следующем примере, в котором демонстрируется получение ответа на запрос "Какие обучающиеся находятся на старшем курсе?"

    ```cpp
    class CStudentSet : public CRecordset
    {
    // Field/Param Data
        CString m_strFirstName;
        CString m_strLastName;
        CString m_strStudentID;
        CString m_strGradYear;

        CString m_strGradYrParam;
    };
    ```

   Элементы данных параметра следует добавлять после созданных мастером элементов данных поля. По соглашению к каждому определенному пользователем имени параметра следует добавлять слово "Param".

1. Измените определение функции-члена [DoFieldExchange](../../mfc/reference/crecordset-class.md#dofieldexchange) в CPP-файле. Для каждого элемента данных параметра, добавляемого в класс, добавьте вызов функции RFX. Сведения о написании функций RFX см. в разделе [Обмен полями записей: принципы работы RFX](../../data/odbc/record-field-exchange-how-rfx-works.md). Перед вызовами RFX в отношении параметров необходимо использовать один вызов:

    ```cpp
    pFX->SetFieldType( CFieldExchange::param );
    // RFX calls for parameter data members
    ```

1. В конструкторе класса набора записей увеличьте количество параметров, `m_nParams`.

   Дополнительные сведения см. [в статье Обмен полями записи. Работа с кодом мастера](../../data/odbc/record-field-exchange-working-with-the-wizard-code.md).

1. При написании кода, который создает объект набора записей этого класса, помещайте символ "?" (знак вопроса) в каждой позиции в строках инструкций SQL, в которых требуется заменять параметр.

   Во время выполнения заполнители "?" заполняются по порядку с использованием передаваемых вами значений параметра. Первый элемент данных параметра, заданный после вызова [SetFieldType](../../mfc/reference/cfieldexchange-class.md#setfieldtype), заменяет первый заполнитель "?" в строке SQL, второй элемент данных параметра заменяет второй заполнитель "?" и т. д.

> [!NOTE]
> Порядок следования параметров имеет значение, поскольку порядок вызовов RFX для параметров в функции `DoFieldExchange` должен соответствовать порядку расположения заполнителей параметра в строке SQL.

> [!TIP]
> В большинстве случаев работа осуществляется со строкой, которую вы задаете в элементе данных класса [m_strFilter](../../mfc/reference/crecordset-class.md#m_strfilter) (если таковая есть), однако некоторые драйверы ODBC допускают использование параметров в других предложениях SQL.

##  <a name="passing-parameter-values-at-run-time"></a><a name="_core_passing_parameter_values_at_run_time"></a> Передача значений параметра во время выполнения

Значения параметра необходимо указывать до вызова `Open` (для нового объекта набора записей) или `Requery` (для существующего объекта).

#### <a name="to-pass-parameter-values-to-a-recordset-object-at-run-time"></a>Передача значений параметра в объект набора записей во время выполнения

1. Создайте объект набора записей.

1. Подготовьте строку или строки, содержащие инструкцию SQL или ее части, например строку `m_strFilter`. Поместите заполнители "?" в те позиции, в которые будут подставляться данные параметра.

1. Во время выполнения присвойте значение параметра каждому элементу данных параметра для объекта.

1. Вызовите функцию-член `Open` (или `Requery` для существующего набора записей).

Предположим, вам необходимо указать строку фильтра для набора записей, используя сведения, полученные во время выполнения. Допустим, ранее вы создали набор записей класса `CStudentSet` с именем `rsStudents` и теперь хотите выполнить запрос к нему для получения определенной информации об учащемся.

```cpp
// Set up a filter string with
// parameter placeholders
rsStudents.m_strFilter = "GradYear <= ?";

// Obtain or calculate parameter values
// to pass--simply assigned here
CString strGradYear = GetCurrentAcademicYear( );

// Assign the values to parameter data members
rsStudents.m_strGradYrParam = strGradYear;

// Run the query
if( !rsStudents.Requery( ) )
    return FALSE;
```

Набор записей содержит записи учащихся, соответствующие условиям, которые задаются фильтром, создаваемым на основе параметров времени выполнения. В этом случае набор содержит записи для всех учащихся старшего курса.

> [!NOTE]
>  При необходимости вы можете присвоить элементу данных параметра значение Null, используя [SetParamNull](../../mfc/reference/crecordset-class.md#setparamnull). Также вы можете проверить, имеет ли элемент данных параметра значение Null, используя [IsFieldNull](../../mfc/reference/crecordset-class.md#isfieldnull).

## <a name="see-also"></a>См. также раздел

[Набор записей (ODBC)](../../data/odbc/recordset-odbc.md)<br/>
[Набор записей. Добавление, обновление и удаление записей (ODBC)](../../data/odbc/recordset-adding-updating-and-deleting-records-odbc.md)<br/>
[Набор записей. Порядок выборки записей в наборе (ODBC)](../../data/odbc/recordset-how-recordsets-select-records-odbc.md)
