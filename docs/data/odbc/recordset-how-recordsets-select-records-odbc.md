---
title: Набор записей. Порядок выборки записей в наборе (ODBC)
ms.date: 05/09/2019
helpviewer_keywords:
- recordsets, selecting records
- record selection, ODBC recordsets
- SQL statements, recordset
- records, selecting
- recordsets, constructing SQL statements
- ODBC recordsets, selecting records
ms.assetid: 343a6a91-aa4c-4ef7-b21f-2f2bfd0d3787
ms.openlocfilehash: 41542e3e11d304bd9ad8b81c0a1b9c6504e156a7
ms.sourcegitcommit: fc1de63a39f7fcbfe2234e3f372b5e1c6a286087
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/15/2019
ms.locfileid: "65707899"
---
# <a name="recordset-how-recordsets-select-records-odbc"></a>Набор записей. Порядок выборки записей в наборе (ODBC)

> [!NOTE] 
> Мастер потребителя MFC ODBC недоступен в Visual Studio 2019 и более поздних версиях. При этом вы по-прежнему можете создать потребитель вручную.

Этот раздел относится к классам ODBC библиотеки MFC.

В этом разделе рассматриваются следующие вопросы.

- [Ваша роль и доступные вам возможности при выборке записей](#_core_your_options_in_selecting_records)

- [Построение инструкции SQL и выборка записей набором](#_core_how_a_recordset_constructs_its_sql_statement)

- [Возможности по настройке выборки](#_core_customizing_the_selection)

Наборы записей выбирают записи из источника данных посредством драйвера ODBC, передавая ему инструкции SQL. Эти инструкции зависят от того, как разрабатывается и открывается класс набора записей.

##  <a name="_core_your_options_in_selecting_records"></a> Доступные вам возможности при выборке записей

В приведенной ниже таблице представлены доступные вам возможности при выборке записей.

### <a name="how-and-when-you-can-affect-a-recordset"></a>Как и когда вы можете влиять на набор записей

|Ситуация|Возможные действия|
|--------------|-------------|
|Объявление класса набора записей с помощью мастера **добавления класса**|Укажите таблицу, из которой будет производиться выборка.<br /><br /> Укажите включаемые столбцы.<br /><br /> См. статью [Добавление потребителя ODBC MFC](../../mfc/reference/adding-an-mfc-odbc-consumer.md).|
|Завершение реализации класса набора записей|Переопределите функции-члены, например расширенную функцию `OnSetOptions`, чтобы задать параметры для конкретного приложения или изменить значения по умолчанию. Укажите элементы данных параметров, если набор записей должен быть параметризованным.|
|Создание объекта набора записей (перед вызовом `Open`)|Укажите условие поиска (возможно, составное) для использования в предложении **WHERE**, которое фильтрует записи. См. статью [Набор записей. Фильтрация записей (ODBC)](../../data/odbc/recordset-filtering-records-odbc.md).<br /><br /> Укажите порядок сортировки для использования в предложении **ORDER BY**, которое сортирует записи. См. статью [Набор записей. Сортировка записей (ODBC)](../../data/odbc/recordset-sorting-records-odbc.md).<br /><br /> Укажите значения для параметров, добавленных в класс. См. статью [Набор записей. Параметризация набора записей (ODBC)](../../data/odbc/recordset-parameterizing-a-recordset-odbc.md).|

|Выполнение запроса набора записей путем вызова `Open`|Укажите пользовательскую строку SQL вместо строки SQL по умолчанию, заданной мастером. См. описание метода [CRecordset::Open](../../mfc/reference/crecordset-class.md#open) в *справочнике по библиотеке классов*, а также статью [SQL. Настройка инструкции SQL (ODBC) набора записей](../../data/odbc/sql-customizing-your-recordsets-sql-statement-odbc.md).|

|Вызов `Requery` для повторного запроса текущих значений из источника данных для набора записей|Укажите новые параметры, условие фильтрации или порядок сортировки. См. статью [Набор записей. Выполнение обновления набора записей (ODBC)](../../data/odbc/recordset-requerying-a-recordset-odbc.md).|

##  <a name="_core_how_a_recordset_constructs_its_sql_statement"></a> Построение инструкции SQL набором записей

Когда вы вызываете функцию-член [Open](../../mfc/reference/crecordset-class.md#open) объекта набора записей, `Open` создает инструкцию SQL, используя некоторые или все перечисленные ниже компоненты.

- Параметр *lpszSQL*, передаваемый в `Open`. Если его значение отлично от NULL, этот параметр определяет пользовательскую строку SQL или ее часть. Платформа анализирует строку. Если строка является инструкцией SQL **SELECT** или инструкцией ODBC **CALL**, платформа использует ее в качестве инструкции SQL набора записей. Если строка не начинается с "SELECT" или "{CALL", платформа использует предоставленную информацию для построения предложения SQL **FROM**.

- Строка, возвращаемая функцией [GetDefaultSQL](../../mfc/reference/crecordset-class.md#getdefaultsql). По умолчанию это имя таблицы, которое вы указали для набора записей в мастере, однако возвращаемое значение можно изменить. Платформа вызывает `GetDefaultSQL`: если строка не начинается с "SELECT" или "{CALL", она считается именем таблицы, которое используется для построения строки SQL.


- Элементы данных полей в наборе записей, которые должны быть привязаны к определенным столбцам таблицы. Платформа привязывает столбцы записей к адресам этих элементов, используя их как буферы. Платформа определяет, как связаны элементы данных полей со столбцами таблицы, с помощью вызовов функций [RFX](../../data/odbc/record-field-exchange-using-rfx.md) или Bulk RFX в функции-члене [DoFieldExchange](../../mfc/reference/crecordset-class.md#dofieldexchange) или [DoBulkFieldExchange](../../mfc/reference/crecordset-class.md#dofieldexchange) набора записей.

- [Фильтр](../../data/odbc/recordset-filtering-records-odbc.md) для набора записей (при его наличии), содержащийся в элементе данных [m_strFilter](../../mfc/reference/crecordset-class.md#m_strfilter). Платформа использует эту строку для построения предложения SQL **WHERE**.

- Порядок [сортировки](../../data/odbc/recordset-sorting-records-odbc.md) для набора записей (при его наличии), содержащийся в элементе данных [m_strSort](../../mfc/reference/crecordset-class.md#m_strsort). Платформа использует эту строку для построения предложения SQL **ORDER BY**.

   > [!TIP]
   > Чтобы использовать предложение SQL **GROUP BY** и, возможно, предложение **HAVING**, добавьте их в конце строки фильтра.

- Значения [элементов данных параметров](../../data/odbc/recordset-parameterizing-a-recordset-odbc.md), указанные для класса. Значения параметров задаются непосредственно перед вызовом `Open` или `Requery`. Платформа привязывает значения параметров к заполнителям "?" в строке SQL. Во время компиляции вы указываете строку с заполнителями. Во время выполнения платформа подставляет данные вместо заполнителей в соответствии с переданными значениями параметров.

Функция `Open` формирует инструкцию SQL **SELECT**, используя эти компоненты. Подробные сведения о том, как платформа использует их, см в разделе [Настройка выборки](#_core_customizing_the_selection).

После построения инструкции функция `Open` отправляет ее в диспетчер драйверов ODBC (и в библиотеку курсоров ODBC, если она имеется в памяти), который передает ее драйверу ODBC, связанному с конкретной СУБД. Драйвер связывается с СУБД, чтобы произвести выборку из источника данных, и получает первую запись. Платформа загружает запись в элементы данных полей в наборе записей.

Эти способы можно использовать в сочетании для открытия [таблиц](../../data/odbc/recordset-declaring-a-class-for-a-table-odbc.md) и для формирования запроса на основе [соединения](../../data/odbc/recordset-performing-a-join-odbc.md) нескольких таблиц. Произведя дополнительную настройку, можно вызывать [предварительно определенные запросы](../../data/odbc/recordset-declaring-a-class-for-a-predefined-query-odbc.md) (хранимые процедуры), выбирать столбцы таблицы, которые не были известны во время разработки, и [привязывать](../../data/odbc/recordset-dynamically-binding-data-columns-odbc.md) их к полям набора записей, а также выполнять большинство других задач доступа к данным. Задачи, которые невозможно выполнить путем настройки наборов записей, можно реализовать путем [вызова функций API ODBC](../../data/odbc/odbc-calling-odbc-api-functions-directly.md) или выполнения инструкций SQL напрямую с помощью [CDatabase::ExecuteSQL](../../mfc/reference/cdatabase-class.md#executesql).

##  <a name="_core_customizing_the_selection"></a> Настройка выборки

Помимо предоставления фильтра, порядка сортировки или параметров, можно выполнить указанные ниже действия по настройке выборки для набора записей.

- Передайте пользовательскую строку SQL в параметре *lpszSQL* при вызове функции [Open](../../mfc/reference/crecordset-class.md#open) для набора записей. Значение, переданное в параметре *lpsqSQL*, имеет приоритет над значением, возвращенным функцией-членом [GetDefaultSQL](../../mfc/reference/crecordset-class.md#getdefaultsql).

   Дополнительные сведения см. в статье [SQL: настройка инструкции SQL (ODBC) набора записей](../../data/odbc/sql-customizing-your-recordsets-sql-statement-odbc.md), в которой описывается, какие типы инструкций SQL (или частичных инструкций) можно передавать в `Open` и что платформа делает с ними.

    > [!NOTE]
    >  Если переданная пользовательская строка не начинается с "SELECT" или "{CALL", MFC предполагает, что она содержит имя таблицы. Это также относится к следующему пункту.

- Измените строку, которую мастер записывает в функции-члене `GetDefaultSQL` набора записей. Отредактируйте код функции, чтобы изменить возвращаемое значение. По умолчанию мастер создает функцию `GetDefaultSQL`, которая возвращает одно имя таблицы.

   Можно сделать так, чтобы функция `GetDefaultSQL` возвращала любые элементы, которые можно передавать в параметре *lpszSQL* в функцию `Open`. Если пользовательская строка SQL в параметре *lpszSQL* не передана, платформа использует строку, возвращенную функцией `GetDefaultSQL`. Функция `GetDefaultSQL` должна возвращать по крайней мере одно имя таблицы. Однако она также может возвращать несколько имен таблиц, полную инструкцию **SELECT**, инструкцию ODBC **CALL** и т. д. Список элементов, которые можно передать в параметре *lpszSQL* или которые может возвращать функция `GetDefaultSQL`, см в статье [SQL: настройка инструкции SQL (ODBC) набора записей](../../data/odbc/sql-customizing-your-recordsets-sql-statement-odbc.md).

   Если выполняется соединение двух или нескольких таблиц, перепишите функцию `GetDefaultSQL`, изменив список таблиц в предложении SQL **FROM**. Дополнительные сведения см. в разделе [Набор записей. Объединение (ODBC)](../../data/odbc/recordset-performing-a-join-odbc.md).


- Привяжите дополнительные элементы данных полей вручную, возможно, на основе сведений о схеме источника данных, полученных во время выполнения. Элементы данных полей добавляются в класс набора записей, вызовы функций [RFX](../../data/odbc/record-field-exchange-using-rfx.md) или Bulk RFX для них — в функцию-член [DoFieldExchange](../../mfc/reference/crecordset-class.md#dofieldexchange) или [DoBulkFieldExchange](../../mfc/reference/crecordset-class.md#dobulkfieldexchange), а инициализации элементов данных — в конструктор класса. Дополнительные сведения см. в разделе [Набор записей. Динамическая привязка столбцов данных (ODBC)](../../data/odbc/recordset-dynamically-binding-data-columns-odbc.md).

- Переопределите функции-члены набора записей, например `OnSetOptions`, чтобы задать параметры для конкретного приложения или изменить значения по умолчанию.

Если набор записей должен быть основан на сложной инструкции SQL, используйте эти способы настройки в определенном сочетании. Например, это может потребоваться, если используются предложения и ключевые слова SQL, которые не поддерживаются наборами записей напрямую, или объединяются несколько таблиц.

## <a name="see-also"></a>См. также

[Набор записей (ODBC)](../../data/odbc/recordset-odbc.md)<br/>
[Набор записей. Порядок обновления записей в наборе (ODBC)](../../data/odbc/recordset-how-recordsets-update-records-odbc.md)<br/>
[Основы ODBC](../../data/odbc/odbc-basics.md)<br/>
[SQL](../../data/odbc/sql.md)<br/>
[Набор записей. Блокирование записей (ODBC)](../../data/odbc/recordset-locking-records-odbc.md)