---
title: 'Обмен данными с полями записей: Принцип работы RFX'
ms.date: 11/04/2016
helpviewer_keywords:
- record editing [C++], using RFX
- RFX (ODBC) [C++], updating data in recordsets
- scrolling [C++]
- ODBC [C++], RFX
- data binding [C++], DFX
- scrolling [C++], RFX
- RFX (ODBC) [C++], binding fields and parameters
ms.assetid: e647cacd-62b0-4b80-9e20-b392deca5a88
ms.openlocfilehash: 0661e61bceeedc0dd049ef47f5a0a0b71a8d82ed
ms.sourcegitcommit: 857fa6b530224fa6c18675138043aba9aa0619fb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2020
ms.locfileid: "80213074"
---
# <a name="record-field-exchange-how-rfx-works"></a>Обмен данными с полями записей: Принцип работы RFX

В этом разделе объясняется процесс RFX. Это дополнительная тема, охватывающая следующие темы:

- [RFX и набор записей](#_core_rfx_and_the_recordset)

- [Процесс RFX](#_core_the_record_field_exchange_process)

> [!NOTE]
>  Этот раздел относится к классам, производным от `CRecordset`, в которых пакетное получение строк не реализовано. Если вы используете пакетное получение строк, реализуется пакетный обмен полями записей (Bulk RFX). Bulk RFX аналогичен RFX. Сведения о различиях см. в разделе [набор записей: незначительная выборка записей (ODBC)](../../data/odbc/recordset-fetching-records-in-bulk-odbc.md).

##  <a name="rfx-and-the-recordset"></a><a name="_core_rfx_and_the_recordset"></a>RFX и набор записей

Элементы данных поля объекта набора записей, взятые вместе, составляют буфер правки, в котором содержатся выбранные столбцы одной записи. Когда набор записей впервые открыт и собирается считать первую запись, RFX привязывает (связывает) Каждый выделенный столбец к адресу соответствующего элемента данных поля. Когда набор записей обновляет запись, функция RFX вызывает функции API ODBC для отправки инструкции SQL **Update** или **INSERT** в драйвер. RFX использует свои знания элементов данных поля, чтобы указать столбцы для записи.

Платформа создает резервную копию буфера редактирования на определенных этапах, чтобы при необходимости можно было восстановить его содержимое. RFX создает резервную копию буфера редактирования перед добавлением новой записи и перед редактированием существующей записи. В некоторых случаях он восстанавливает буфер редактирования, например, после `Update` вызове следующего `AddNew`. Буфер редактирования не восстанавливается, если вы отменяете вновь измененный буфер редактирования, например, перемещаясь на другую запись перед вызовом `Update`.

Помимо обмена данными между источником данных и элементами данных поля набора записей, RFX управляет параметрами привязки. При открытии набора записей все элементы данных параметров привязываются в порядке заполнители "?" в инструкции SQL, `CRecordset::Open` конструкции. Дополнительные сведения см. [в разделе набор записей: Параметризация набора записей (ODBC)](../../data/odbc/recordset-parameterizing-a-recordset-odbc.md).

Переопределение `DoFieldExchange` класса набора записей выполняет всю работу, перемещая данные в обоих направлениях. Как и при обмене данными в диалоговых окнах (DDX), RFX нуждается в сведениях о членах данных класса. Мастер предоставляет необходимые сведения, создавая для вас реализацию `DoFieldExchange`, зависящую от набора записей, на основе имен элементов данных полей и типов данных, указанных в мастере.

##  <a name="record-field-exchange-process"></a><a name="_core_the_record_field_exchange_process"></a>Процесс обмена полями записи

В этом разделе описывается последовательность событий RFX при открытии объекта набора записей, а также по мере добавления, обновления и удаления записей. Последовательность таблиц [операций RFX во время открытия набора записей](#_core_sequence_of_rfx_operations_during_recordset_open) и табличная [последовательность операций RFX во время прокрутки](#_core_sequence_of_rfx_operations_during_scrolling) этого раздела показывает процесс, выполняемый в RFX, обрабатывает `Move`ную команду в наборе записей, а также как RFX управляет обновлением. Во время этих процессов для выполнения множества различных операций вызывается метод [DoFieldExchange](../../mfc/reference/crecordset-class.md#dofieldexchange) . Запрошенная операция определяется элементом данных `m_nOperation` объекта [кфиелдексчанже](../../mfc/reference/cfieldexchange-class.md) . Может оказаться полезным прочитать [набор записей: как набор записей выбирает записи (ODBC)](../../data/odbc/recordset-how-recordsets-select-records-odbc.md) и [набор записей. как набор записей ОБНОВЛЯЕТ записи (ODBC)](../../data/odbc/recordset-how-recordsets-update-records-odbc.md) перед чтением этого материала.

###  <a name="rfx-initial-binding-of-columns-and-parameters"></a><a name="_mfc_rfx.3a_.initial_binding_of_columns_and_parameters"></a>RFX: Начальная привязка столбцов и параметров

При вызове функции [открытого](../../mfc/reference/crecordset-class.md#open) члена объекта Recordset в указанном порядке выполняются следующие действия RFX:

- Если набор записей содержит элементы данных параметров, платформа вызывает `DoFieldExchange`, чтобы привязать параметры к заполнителям параметров в строке инструкции SQL набора записей. Для каждого заполнителя, найденного в инструкции **SELECT** , используется зависимое от типа данных представление значения параметра. Это происходит после подготовки инструкции SQL, но до ее выполнения. Сведения о подготовке инструкции см. в описании функции `::SQLPrepare` в *справочнике программиста*по ODBC.

- Платформа вызывает `DoFieldExchange` второй раз, чтобы привязать значения выбранных столбцов к соответствующим элементам данных поля в наборе записей. При этом объект набора записей устанавливается в виде буфера редактирования, содержащего столбцы первой записи.

- Набор записей выполняет инструкцию SQL, и источник данных выбирает первую запись. Столбцы записи загружаются в элементы данных полей набора записей.

В следующей таблице показана последовательность операций RFX при открытии набора записей.

### <a name="sequence-of-rfx-operations-during-recordset-open"></a><a name="_core_sequence_of_rfx_operations_during_recordset_open"></a>Последовательность операций RFX при открытии набора записей

|Операция|Операция DoFieldExchange|Операция базы данных или SQL|
|--------------------|-------------------------------|-----------------------------|
|1. Откройте набор записей.|||
||2. Создайте инструкцию SQL.||
|||3. Отправьте SQL.|
||4. Связывание членов данных параметров.||
||5. Привязка элементов данных поля к столбцам.||
|||6. ODBC выполняет перемещение и заполняет данные.|
||7. Исправьте данные для C++.||

Наборы записей используют подготовленное выполнение ODBC, чтобы обеспечить быстрое перевыполнение запросов с помощью одной и той же инструкции SQL. Дополнительные сведения о подготовленном выполнении см. в *справочнике программиста* по пакету SDK для ODBC в библиотеке MSDN.

###  <a name="rfx-scrolling"></a><a name="_mfc_rfx.3a_.scrolling"></a>RFX: прокрутка

При прокрутке от одной записи к другой платформа вызывает `DoFieldExchange`, чтобы заменить значения, ранее сохраненные в элементах данных поля, значениями для новой записи.

В следующей таблице показана последовательность операций RFX при переходе пользователя из записи в запись.

### <a name="sequence-of-rfx-operations-during-scrolling"></a><a name="_core_sequence_of_rfx_operations_during_scrolling"></a>Последовательность операций RFX во время прокрутки

|Операция|Операция DoFieldExchange|Операция базы данных или SQL|
|--------------------|-------------------------------|-----------------------------|
|1. вызовите `MoveNext` или одну из других функций перемещения.|||
|||2. ODBC выполняет перемещение и заполняет данные.|
||3. Исправьте данные для C++.||

###  <a name="rfx-adding-new-records-and-editing-existing-records"></a><a name="_mfc_rfx.3a_.adding_new_records_and_editing_existing_records"></a>RFX: Добавление новых записей и изменение существующих записей

При добавлении новой записи набор записей действует как буфер редактирования для создания содержимого новой записи. Как и при добавлении записей, изменение записей предполагает изменение значений элементов данных полей набора записей. С точки зрения RFX последовательность выглядит следующим образом:

1. Вызов функции [AddNew](../../mfc/reference/crecordset-class.md#addnew) или [Edit](../../mfc/reference/crecordset-class.md#edit) члена набора записей приводит к тому, что RFX сохраняет текущий буфер редактирования, чтобы его можно было восстановить позже.

1. `AddNew` или `Edit` готовит поля в буфере редактирования, поэтому RFX может обнаруживать элементы данных измененных полей.

   Так как новая запись не имеет предыдущих значений для сравнения новых с, `AddNew` присваивает каждому элементу данных поля значение PSEUDO_NULL. Затем при вызове `Update`RFX сравнивает значение каждого элемента данных со значением PSEUDO_NULL. При наличии различий был задан элемент данных. (PSEUDO_NULL не совпадает со столбцом записи со значением true NULL и не является ни одним из таких же, что C++ и NULL.)

   В отличие от вызова `Update` для `AddNew`, `Update`ный вызов для `Edit` сравнивает обновленные значения с ранее сохраненными значениями вместо использования PSEUDO_NULL. Разница заключается в том, что `AddNew` не имеет ранее сохраненных значений для сравнения.

1. Вы напрямую задаете значения элементов данных поля, значения которых необходимо изменить или которые нужно заполнить для новой записи. Это может быть вызов `SetFieldNull`.

1. Вызов метода [Update](../../mfc/reference/crecordset-class.md#update) проверяет элементы данных измененных полей, как описано в шаге 2 (см. таблицу [операций RFX во время прокрутки](#_core_sequence_of_rfx_operations_during_scrolling)). Если ничего не изменилось, `Update` возвращает 0. Если какие-либо элементы данных полей изменились, `Update` готовит и выполняет инструкцию SQL **INSERT** , содержащую значения для всех обновленных полей в записи.

1. Для `AddNew``Update` завершается восстановлением ранее сохраненных значений записи, которая была текущей до вызова `AddNew`. Для `Edit`новые, измененные значения остаются на месте.

В следующей таблице показана последовательность операций RFX при добавлении новой записи или редактировании существующей записи.

### <a name="sequence-of-rfx-operations-during-addnew-and-edit"></a>Последовательность операций RFX во время выполнения AddNew и Edit

|Операция|Операция DoFieldExchange|Операция базы данных или SQL|
|--------------------|-------------------------------|-----------------------------|
|1. вызовите `AddNew` или `Edit`.|||
||2. Создайте резервную копию буфера редактирования.||
||3. для `AddNew`Пометьте элементы данных поля как "Clean" и NULL.||
|4. присвойте значения элементам данных полей набора записей.|||
|5. вызовите `Update`.|||
||6. Проверьте наличие измененных полей.||
||7. Создайте инструкцию SQL **INSERT** для `AddNew` или инструкции **Update** для `Edit`.||
|||8. Отправка SQL.|
||9. для `AddNew`Восстановите содержимое буфера редактирования в его резервную копию. Для `Edit`удалите резервную копию.||

### <a name="rfx-deleting-existing-records"></a>RFX: удаление существующих записей

При удалении записи RFX устанавливает для всех полей значение NULL в качестве напоминания о том, что запись удалена, и ее необходимо переместить. Никаких других сведений о последовательности RFX не требуется.

## <a name="see-also"></a>См. также раздел

[Обмен данными полей записей (RFX)](../../data/odbc/record-field-exchange-rfx.md)<br/>
[Потребление MFC ODBC](../../mfc/reference/adding-an-mfc-odbc-consumer.md)<br/>
[Макросы, глобальные функции и глобальные переменные](../../mfc/reference/mfc-macros-and-globals.md)<br/>
[Класс CFieldExchange](../../mfc/reference/cfieldexchange-class.md)<br/>
[CRecordset::D Офиелдексчанже](../../mfc/reference/crecordset-class.md#dofieldexchange)
