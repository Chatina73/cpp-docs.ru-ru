---
title: Набор записей. Объявление класса для предопределенного запроса (ODBC)
ms.date: 05/09/2019
helpviewer_keywords:
- ODBC recordsets, queries
- predefined queries and recordsets
- stored procedures, and recordsets
- recordsets, predefined queries
- recordsets, stored procedures
ms.assetid: d27c4df9-dad2-4484-ba72-92ab0c8ff928
ms.openlocfilehash: 6338de99bf9c3e19e6e15ffbe0bcf5caab066ed8
ms.sourcegitcommit: 8e285a766523e653aeeb34d412dc6f615ef7b17b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/21/2020
ms.locfileid: "80079839"
---
# <a name="recordset-declaring-a-class-for-a-predefined-query-odbc"></a>Набор записей. Объявление класса для предопределенного запроса (ODBC)

> [!NOTE]
> Мастер потребителя MFC ODBC недоступен в Visual Studio 2019 и более поздних версиях. При этом вы по-прежнему можете создать потребитель вручную.

Этот раздел относится к классам ODBC библиотеки MFC.

В этом разделе описывается создание класса набора записей класса для предопределенного запроса (иногда называется хранимой процедурой, как в Microsoft SQL Server).

> [!NOTE]
>  Этот раздел относится к объектам, производным от `CRecordset`, в которых пакетное получение строк не реализовано. Если реализовано пакетное получение строк, процесс очень похож. Сведения о различиях между наборами записей, которые реализуют групповую выборку строк, и тех, которые не поддерживаются, см. в разделе [набор записей: Неосновная выборка записей (ODBC)](../../data/odbc/recordset-fetching-records-in-bulk-odbc.md).

Некоторые системы управления базами данных (СУБД) позволяют создавать предопределенный запрос и вызывать его из программ, как функцию. У запроса есть имя, он может принимать параметры и возвращать записи. Процедура в этом разделе описывает, как вызвать предопределенный запрос, который возвращает записи (и, возможно, принимает параметры).

Классы баз данных не поддерживают обновление предопределенных запросов. Разница между предопределенным запросом моментальных снимков и предопределенным запросом динамического подмножества не в обновляемости, а в том, видимы ли изменения, внесенные другими пользователями (или другими наборами записей в программе) в вашем наборе записей.

> [!TIP]
>  Вам не нужен набор записей для вызова предопределенного запроса, который не возвращает записи. Подготовьте инструкцию SQL, как описано ниже, но выполните ее, вызвав функцию элемента `CDatabase`[ExecuteSQL](../../mfc/reference/cdatabase-class.md#executesql).

Вы можете создать один класс набора записей для управления вызовом предопределенного запроса, но вы должны проделать некоторую работу самостоятельно. Мастера не поддерживают создание класса специально для этой цели.

#### <a name="to-create-a-class-for-calling-a-predefined-query-stored-procedure"></a>Создание класса для вызова предопределенного запроса (хранимая процедура)

1. Используйте [мастер объекта-получателя MFC ODBC](../../mfc/reference/adding-an-mfc-odbc-consumer.md) из **Добавление класса**, чтобы создать класс набора записей для таблицы, содержащей большинство столбцов, возвращаемых запросом. Это дает вам преимущество.

1. Вручную добавьте элементы данных полей для всех столбцов всех таблиц, возвращаемых запросом, но не созданных мастером.

   Например, если запрос возвращает три столбца из двух дополнительных таблиц, добавьте к классу шесть элементов данных полей (соответствующих типов данных).

1. Вручную добавьте вызовы функции [RFX](../../data/odbc/record-field-exchange-rfx.md) в функцию элемента [DoFieldExchange](../../mfc/reference/crecordset-class.md#dofieldexchange) класса в соответствии с типом данных каждого добавленного элемента данных полей.

    ```cpp
    Immediately before these RFX calls, call <MSHelp:link keywords="_mfc_CFieldExchange.3a3a.SetFieldType" TABINDEX="0">SetFieldType</MSHelp:link>, as shown here:
    pFX->SetFieldType( CFieldExchange::outputColumn );
    ```

    > [!NOTE]
    >  Необходимо знать типы данных и порядок столбцов, возвращаемых в результирующем наборе. Порядок вызовов функций RFX в `DoFieldExchange` должен соответствовать порядку столбцов результирующего набора.

1. Вручную добавьте инициализации для новых элементов данных полей в конструкторе класса набора записей.

   Кроме того, необходимо увеличить значение инициализации для элемента данных [m_nFields](../../mfc/reference/crecordset-class.md#m_nfields). Мастер пишет инициализацию, но она охватывает только элементы данных полей, которые он добавил сам. Например:

    ```cpp
    m_nFields += 6;
    ```

   Некоторые типы данных не должны инициализироваться здесь, например `CLongBinary` или массивы байтов.

1. Если запрос принимает параметры, добавьте элемент данных параметра для каждого параметра, вызов функции RFX для каждого параметра и инициализацию для каждого параметра.

1. Необходимо увеличить `m_nParams` для каждого добавленного параметра, как вы делали это для `m_nFields` для добавленных полей на шаге 4 этой процедуры. Дополнительные сведения см. [в разделе набор записей: Параметризация набора записей (ODBC)](../../data/odbc/recordset-parameterizing-a-recordset-odbc.md).

1. Вручную напишите строку инструкции SQL по следующей форме:

    ```
    {CALL proc-name [(? [, ?]...)]}
    ```

   где **CALL** — это ключевое слово ODBC, **proc-name** — это имя запроса, известного в источнике данных, а элементы "?" — это местозаполнители для значений параметров, которые вы передаете в набор записей во время выполнения (если таковые имеются). В следующем примере подготавливается заполнитель для одного параметра:

    ```
    CString mySQL = "{CALL Delinquent_Accts (?)}";
    ```

1. В коде, который открывает набор записей, задайте значения элементов данных параметров набора записей, а затем вызовите функцию элемента `Open`, передав строку SQL для параметра *lpszSQL*. Либо замените строку, возвращаемую функцией элемента `GetDefaultSQL` в классе.

В следующих примерах показана процедура вызова предопределенного запроса с именем `Delinquent_Accts`, который принимает один параметр — номер региона продаж. Этот запрос возвращает три столбца: `Acct_No`, `L_Name`, `Phone`. Все столбцы взяты из таблицы Customers.

Следующий набор записей определяет элементы данных полей для столбцов, возвращаемых запросом, и параметр номера региона продаж, запрошенный в среде выполнения.

```cpp
class CDelinquents : public CRecordset
{
// Field/Param Data
    LONG m_lAcct_No;
    CString m_strL_Name;
    CString m_strPhone;
    LONG m_lDistParam;
    // ...
};
```

Это объявление класса написано мастером, а элемент `m_lDistParam` добавлен вручную. Другие элементы здесь не показаны.

В следующем примере показаны инициализации для элементов данных в конструкторе `CDelinquents`.

```cpp
CDelinquents::CDelinquents(CDatabase* pdb)
   : CRecordset(pdb)
{
    // Wizard-generated params:
    m_lAcct_No = 0;
    m_strL_Name = "";
    m_strPhone = "";
    m_nFields = 3;
    // User-defined params:
    m_nParams = 1;
    m_lDistParam = 0;
}
```

Обратите внимание на инициализации для [m_nFields](../../mfc/reference/crecordset-class.md#m_nfields) и [m_nParams](../../mfc/reference/crecordset-class.md#m_nparams). Мастер инициализирует `m_nFields`; вы инициализируете `m_nParams`.

В следующем примере показаны функции RFX в `CDelinquents::DoFieldExchange`:

```cpp
void CDelinquents::DoFieldExchange(CFieldExchange* pFX)
{
    pFX->SetFieldType(CFieldExchange::outputColumn);
    RFX_Long(pFX, "Acct_No", m_lAcct_No);
    RFX_Text(pFX, "L_Name", m_strL_Name);
    RFX_Text(pFX, "Phone", m_strPhone);
    pFX->SetFieldType(CFieldExchange::param);
    RFX_Long(pFX, "Dist_No", m_lDistParam);
}
```

Помимо вызовов RFX для трех возвращаемых столбцов, этот код также управляет привязкой параметра, который вы передаете в среде выполнения. Параметр подключается к столбцу `Dist_No` (номер региона).

В следующем примере показано, как настроить строку SQL и использовать ее, чтобы открыть набор записей.

```cpp
// Construct a CDelinquents recordset object
CDelinquents rsDel( NULL );
CString strSQL = "{CALL Delinquent_Accts (?)}"
// Specify a parameter value (obtained earlier from the user)
rsDel.m_lDistParam = lDistrict;
// Open the recordset and run the query
if( rsDel.Open( CRecordset::snapshot, strSQL ) )
    // Use the recordset ...
```

Этот код создает моментальный снимок, передает ему параметр, полученный ранее от пользователя, и вызывает предопределенный запрос. При выполнении запроса возвращаются записи для указанного региона продаж. Каждая запись содержит столбцы для номера счета, фамилии клиента и номера телефона клиента.

> [!TIP]
>  Возможно, вам потребуется обработать возвращаемое значение (выходной параметр) из хранимой процедуры. Дополнительные сведения и пример см. в разделе [CFieldExchange::SetFieldType](../../mfc/reference/cfieldexchange-class.md#setfieldtype).

## <a name="see-also"></a>См. также:

[Набор записей (ODBC)](../../data/odbc/recordset-odbc.md)<br/>
[Набор записей. Выполнение обновления наборов записей (ODBC)](../../data/odbc/recordset-requerying-a-recordset-odbc.md)<br/>
[Набор записей. Объявление класса таблицы (ODBC)](../../data/odbc/recordset-declaring-a-class-for-a-table-odbc.md)<br/>
[Набор записей. Объединение (ODBC)](../../data/odbc/recordset-performing-a-join-odbc.md)