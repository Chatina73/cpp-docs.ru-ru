---
title: Набор записей. Добавление, обновление и удаление записей (ODBC)
ms.date: 11/04/2016
helpviewer_keywords:
- records [C++], updating
- record editing [C++], in recordsets
- recordsets [C++], adding records
- records [C++], adding
- ODBC recordsets [C++], adding records
- recordsets [C++], editing records
- recordsets [C++], updating
- records [C++], deleting
- AddNew method
- ODBC recordsets [C++], deleting records
- data in recordsets [C++]
- record editing [C++]
- recordsets [C++], deleting records
- ODBC recordsets [C++], editing records
- records [C++], editing
ms.assetid: 760c8889-bec4-482b-a8f2-319792a6af98
ms.openlocfilehash: 14fc26709541135e80a2e0fe4de872cc75221874
ms.sourcegitcommit: 857fa6b530224fa6c18675138043aba9aa0619fb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2020
ms.locfileid: "80213009"
---
# <a name="recordset-adding-updating-and-deleting-records-odbc"></a>Набор записей. Добавление, обновление и удаление записей (ODBC)

Этот раздел относится к классам ODBC библиотеки MFC.

> [!NOTE]
>  Теперь можно более эффективно добавлять записи. Дополнительные сведения см. [в разделе набор записей. неполное Добавление записей (ODBC)](../../data/odbc/recordset-adding-records-in-bulk-odbc.md).

> [!NOTE]
>  Этот раздел относится к объектам, производным от `CRecordset`, в которых пакетное получение строк не реализовано. Если используется многострочная выборка строк, см. раздел [набор записей: групповая выборка записей (ODBC)](../../data/odbc/recordset-fetching-records-in-bulk-odbc.md).

Обновляемые моментальные снимки и динамические наборы данных позволяют добавлять, изменять (обновлять) и удалять записи. В этом разделе рассматриваются следующие вопросы.

- [Определение возможности обновления набора записей](#_core_determining_whether_your_recordset_is_updatable).

- [Добавление новой записи](#_core_adding_a_record_to_a_recordset).

- [Изменение существующей записи](#_core_editing_a_record_in_a_recordset).

- [Удаление записи](#_core_deleting_a_record_from_a_recordset).

Дополнительные сведения о том, как выполняются обновления и о том, как обновления отображаются для других пользователей, см. в разделе [набор записей: как наборы записей обновляют записи (ODBC)](../../data/odbc/recordset-how-recordsets-update-records-odbc.md). Как правило, при добавлении, изменении или удалении записи набор записей немедленно изменяет источник данных. Вместо этого можно Пакетные группы связанных обновлений в транзакции. Если транзакция выполняется, обновление не становится окончательным до фиксации транзакции. Это позволяет вернуть или отменить изменения. Дополнительные сведения о транзакциях см. в разделе [Transaction (ODBC)](../../data/odbc/transaction-odbc.md).

В следующей таблице перечислены параметры, доступные для наборов записей с разными характеристиками обновления.

### <a name="recordset-readupdate-options"></a>Параметры чтения и обновления набора записей

|Тип|Чтение|Изменить запись|Удалить запись|Добавить новое (Добавить)|
|----------|----------|-----------------|-------------------|------------------------|
|Только для чтения|Да|Нет|Нет|Нет|
|Только добавление|Да|Нет|Нет|Да|
|Полностью обновляемый|Да|Да|Да|Да|

##  <a name="determining-whether-your-recordset-is-updateable"></a><a name="_core_determining_whether_your_recordset_is_updatable"></a>Определение возможности обновления набора записей

Объект Recordset можно обновить, если источник данных является обновляемым, а набор записей открыт как обновляемый. Его возможность обновления также зависит от используемой инструкции SQL, возможностей драйвера ODBC и от того, находится ли библиотека курсоров ODBC в памяти. Невозможно обновить набор записей или источник данных, доступного только для чтения.

#### <a name="to-determine-whether-your-recordset-is-updatable"></a>Определение возможности обновления набора записей

1. Вызовите функцию члена [канупдате](../../mfc/reference/crecordset-class.md#canupdate) объекта Recordset.

   `CanUpdate` возвращает ненулевое значение, если набор записей является обновляемым.

По умолчанию наборы записей являются полностью обновляемыми (можно выполнять `AddNew`, `Edit`и `Delete` операции). Но можно также использовать параметр [аппендонли](../../mfc/reference/crecordset-class.md#open) , чтобы открыть обновляемые наборы записей. Набор записей, Открытый таким образом, допускает добавление новых записей с `AddNew`. Вы не можете изменять или удалять существующие записи. Можно проверить, открыт ли набор записей только для добавления путем вызова функции-члена [канаппенд](../../mfc/reference/crecordset-class.md#canappend) . `CanAppend` возвращает ненулевое значение, если набор записей является либо полностью обновляемым, либо открытым только для добавления.

В следующем коде показано, как можно использовать `CanUpdate` для объекта Recordset с именем `rsStudentSet`:

```cpp
if( !rsStudentSet.Open( ) )
    return FALSE;
if( !rsStudentSet.CanUpdate( ) )
{
    AfxMessageBox( "Unable to update the Student recordset." );
    return;
}
```

> [!CAUTION]
>  При подготовке к обновлению набора записей путем вызова `Update`Следите за тем, чтобы набор записей включал все столбцы, которые составляют первичный ключ таблицы (или все столбцы любого уникального индекса в таблице). В некоторых случаях платформа может использовать только столбцы, выбранные в наборе записей, чтобы указать, какую запись в таблице нужно обновить. При отсутствии всех необходимых столбцов в таблице могут быть обновлены несколько записей, что может повредить ссылочную целостность таблицы. В этом случае платформа создает исключения при вызове `Update`.

##  <a name="adding-a-record-to-a-recordset"></a><a name="_core_adding_a_record_to_a_recordset"></a>Добавление записи в набор записей

Можно добавить новые записи в набор записей, если его функция-член [канаппенд](../../mfc/reference/crecordset-class.md#canappend) возвращает ненулевое значение.

#### <a name="to-add-a-new-record-to-a-recordset"></a>Добавление новой записи в набор записей

1. Убедитесь, что набор записей дописывается.

1. Вызовите функцию члена [AddNew](../../mfc/reference/crecordset-class.md#addnew) объекта Recordset.

   `AddNew` готовит набор записей для работы в качестве буфера редактирования. Все элементы данных полей задаются специальным значением NULL и помечаются как неизмененные, поэтому при вызове [Update](../../mfc/reference/crecordset-class.md#update)в источник данных записываются только измененные (грязные) значения.

1. Задайте значения для элементов данных поля новой записи.

   Присвойте значения элементам данных поля. Те, которые не назначаются, не записываются в источник данных.

1. Вызовите функцию члена `Update` объекта Recordset.

   `Update` завершает Добавление, записывая новую запись в источник данных. Сведения о том, что происходит, если не удается вызвать `Update`, см. в разделе [набор записей: как наборы записей обновляют записи (ODBC)](../../data/odbc/recordset-how-recordsets-update-records-odbc.md).

Сведения о том, как происходит добавление записей и о том, когда добавленные записи отображаются в наборе записей, см. в разделе [набор записей: принципы работы AddNew, Edit и Delete (ODBC)](../../data/odbc/recordset-how-addnew-edit-and-delete-work-odbc.md).

В следующем примере показано, как добавить новую запись:

```cpp
if( !rsStudent.Open( ) )
    return FALSE;
if( !rsStudent.CanAppend( ) )
    return FALSE;                      // no field values were set
rsStudent.AddNew( );
rsStudent.m_strName = strName;
rsStudent.m_strCity = strCity;
rsStudent.m_strStreet = strStreet;
if( !rsStudent.Update( ) )
{
    AfxMessageBox( "Record not added; no field values were set." );
    return FALSE;
}
```

> [!TIP]
>  Чтобы отменить вызов `AddNew` или `Edit`, просто сделайте еще один вызов `AddNew` или `Edit` или вызовите `Move` с параметром *AFX_MOVE_REFRESH* . Элементы данных возвращаются к предыдущим значениям, но по-прежнему выполняются в `Edit` или `Add` режиме.

##  <a name="editing-a-record-in-a-recordset"></a><a name="_core_editing_a_record_in_a_recordset"></a>Изменение записи в наборе записей

Можно изменить существующие записи, если функция-член [канупдате](../../mfc/reference/crecordset-class.md#canupdate) набора записей возвращает ненулевое значение.

#### <a name="to-edit-an-existing-record-in-a-recordset"></a>Изменение существующей записи в наборе записей

1. Убедитесь, что набор записей является обновляемым.

1. Прокрутите до записи, которую необходимо обновить.

1. Вызовите функцию [изменения](../../mfc/reference/crecordset-class.md#edit) члена объекта Recordset.

   `Edit` готовит набор записей для работы в качестве буфера редактирования. Все элементы данных полей отмечены таким образом, чтобы набор записей мог впоследствии определить, были ли они изменены. Новые значения для элементов данных измененных полей записываются в источник данных при вызове [Update](../../mfc/reference/crecordset-class.md#update).

1. Задайте значения для элементов данных поля новой записи.

   Присвойте значения элементам данных поля. Не присваивать значения, остаются без изменений.

1. Вызовите функцию члена `Update` объекта Recordset.

   `Update` завершает изменение, записывая измененную запись в источник данных. Сведения о том, что происходит, если не удается вызвать `Update`, см. в разделе [набор записей: как наборы записей обновляют записи (ODBC)](../../data/odbc/recordset-how-recordsets-update-records-odbc.md).

После изменения записи измененная запись остается в текущей записи.

В следующем примере показана операция `Edit`. Предполагается, что пользователь переместился на запись, которую он хочет изменить.

```cpp
rsStudent.Edit( );
rsStudent.m_strStreet = strNewStreet;
rsStudent.m_strCity = strNewCity;
rsStudent.m_strState = strNewState;
rsStudent.m_strPostalCode = strNewPostalCode;
if( !rsStudent.Update( ) )
{
    AfxMessageBox( "Record not updated; no field values were set." );
    return FALSE;
}
```

> [!TIP]
> Чтобы отменить вызов `AddNew` или `Edit`, просто сделайте еще один вызов `AddNew` или `Edit` или вызовите `Move` с параметром *AFX_MOVE_REFRESH* . Элементы данных возвращаются к предыдущим значениям, но по-прежнему выполняются в `Edit` или `Add` режиме.

##  <a name="deleting-a-record-from-a-recordset"></a><a name="_core_deleting_a_record_from_a_recordset"></a>Удаление записи из набора записей

Вы можете удалить записи, если функция-член [канупдате](../../mfc/reference/crecordset-class.md#canupdate) набора записей возвращает ненулевое значение.

#### <a name="to-delete-a-record"></a>Удаление записи

1. Убедитесь, что набор записей является обновляемым.

1. Прокрутите до записи, которую необходимо обновить.

1. Вызовите функцию члена [удаления](../../mfc/reference/crecordset-class.md#delete) объекта Recordset.

   `Delete` немедленно помечает запись как удаленную как в наборе записей, так и в источнике данных.

   В отличие от `AddNew` и `Edit`, `Delete` не имеет соответствующего вызова `Update`.

1. Прокрутите до другой записи.

   > [!NOTE]
   >  При перемещении по набору записей удаленные записи могут не пропускаться. Дополнительные сведения см. в описании функции [удаления](../../mfc/reference/crecordset-class.md#isdeleted) элемента.

В следующем примере показана операция `Delete`. Предполагается, что пользователь переместился на запись, которую пользователь хочет удалить. После вызова `Delete` важно перейти к новой записи.

```
rsStudent.Delete( );
rsStudent.MoveNext( );
```

Дополнительные сведения о влиянии функций-членов `AddNew`, `Edit`и `Delete` см. в разделе [набор записей: как наборы записей обновляют записи (ODBC)](../../data/odbc/recordset-how-recordsets-update-records-odbc.md).

## <a name="see-also"></a>См. также раздел

[Набор записей (ODBC)](../../data/odbc/recordset-odbc.md)<br/>
[Набор записей. Блокировка (ODBC)](../../data/odbc/recordset-locking-records-odbc.md)
