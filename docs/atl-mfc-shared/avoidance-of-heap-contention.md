---
description: 'Дополнительные сведения о: избежание конфликтов кучи'
title: Избежание конфликтов кучи
ms.date: 11/04/2016
helpviewer_keywords:
- heap contention
ms.assetid: 797129d7-5f8c-4b0e-8974-bb93217e9ab5
ms.openlocfilehash: c58849bee46dd0d870d1067f17581429339fbc0e
ms.sourcegitcommit: d6af41e42699628c3e2e6063ec7b03931a49a098
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2020
ms.locfileid: "97142575"
---
# <a name="avoidance-of-heap-contention"></a>Избежание конфликтов кучи

Диспетчеры строк по умолчанию, предоставляемые MFC и ATL, являются простыми оболочками на основе глобальной кучи. Эта глобальная куча является полностью потокобезопасной, а это означает, что несколько потоков могут одновременно выделить и освободить память из него без повреждения кучи. Чтобы обеспечить безопасность потоков, куча должна сериализовать доступ к самой себе. Обычно это выполняется с помощью критического раздела или аналогичного механизма блокировки. Всякий раз, когда два потока пытаются одновременно получить доступ к куче, один поток блокируется до тех пор, пока не завершится запрос другого потока. Для многих приложений такая ситуация возникает редко, и влияние механизма блокировки кучи незначительно. Однако для приложений, которые часто обращаются к куче из нескольких потоков для блокировки кучи, приложение может выполняться медленнее, чем при работе с одним потоком (даже на компьютерах с несколькими процессорами).

Приложения, использующие [CStringT](../atl-mfc-shared/reference/cstringt-class.md) , особенно уязвимы для состязаний кучи, поскольку операции с `CStringT` объектами часто занимают перераспределение строкового буфера.

Один из способов уменьшить состязание за кучу между потоками заключается в том, чтобы каждый поток выделил строки из закрытой локальной кучи потока. Пока строки, выделенные с помощью распределителя определенного потока, используются только в этом потоке, распределитель не должен быть потокобезопасным.

## <a name="example"></a>Пример

В приведенном ниже примере показана потоковая процедура, которая выделяет собственную закрытую непотоковую кучу для использования строк в этом потоке:

[!code-cpp[NVC_ATLMFC_Utilities#182](../atl-mfc-shared/codesnippet/cpp/avoidance-of-heap-contention_1.cpp)]

## <a name="comments"></a>Комментарии

Несколько потоков могут выполняться с помощью этой же процедуры потока, но поскольку каждый поток имеет собственную кучу, между потоками отсутствует состязание. Кроме того, тот факт, что каждая куча не является потокобезопасной, приводит к измеряемому увеличению производительности, даже если выполняется только одна копия потока. Это результат кучи, который не использует ресурсоемкие операции с блокировкой для защиты от параллельного доступа.

Для более сложной процедуры потока может быть удобно сохранить указатель на Диспетчер строк потока в слоте локального хранилища потоков (TLS). Это позволяет другим функциям, вызываемым процедурой потока, обращаться к диспетчеру строк потока.

## <a name="see-also"></a>См. также раздел

[Управление памятью с помощью CStringT](../atl-mfc-shared/memory-management-with-cstringt.md)
