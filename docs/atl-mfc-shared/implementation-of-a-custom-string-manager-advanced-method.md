---
description: Дополнительные сведения см. в статье реализация пользовательского диспетчера строк (Расширенный метод).
title: Реализация пользовательского диспетчера строк (Расширенный метод)
ms.date: 11/04/2016
helpviewer_keywords:
- IAtlStringMgr class, using
ms.assetid: 64ab7da9-47c1-4c4a-9cd7-4cc37e7f3f57
ms.openlocfilehash: 042c0759076d14e2fd0cf8dd91e34c4f1d8bb534
ms.sourcegitcommit: d6af41e42699628c3e2e6063ec7b03931a49a098
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2020
ms.locfileid: "97166971"
---
# <a name="implementation-of-a-custom-string-manager-advanced-method"></a>Реализация пользовательского диспетчера строк (Расширенный метод)

В специализированных ситуациях может потребоваться реализовать настраиваемый диспетчер строк, который не просто изменяет, какая куча используется для выделения памяти. В этом случае необходимо вручную реализовать интерфейс [иатлстрингмгр](../atl-mfc-shared/reference/iatlstringmgr-class.md) в качестве пользовательского диспетчера строк.

Чтобы сделать это, важно сначала понять, как [CStringT](../atl-mfc-shared/reference/cstringt-class.md) использует этот интерфейс для управления его строковыми данными. Каждый экземпляр `CStringT` имеет указатель на структуру [кстрингдата](../atl-mfc-shared/reference/cstringdata-class.md) . Эта структура переменной длины содержит важную информацию о строке (например, длину), а также фактические символьные данные для строки. Каждый диспетчер пользовательских строк отвечает за выделение и освобождение этих структур по запросу `CStringT` .

`CStringData`Структура состоит из четырех полей:

- [пстрингмгр](../atl-mfc-shared/reference/cstringdata-class.md#pstringmgr) Это поле указывает на `IAtlStringMgr` интерфейс, используемый для управления этими строковыми данными. Когда `CStringT` необходимо перераспределить или освободить строковый буфер, он вызывает методы перераспределения или освобождения для этого интерфейса, передавая `CStringData` структуру в качестве параметра. При выделении `CStringData` структуры в диспетчере строк необходимо задать это поле, чтобы оно указывало на настраиваемый диспетчер строк.

- [ндаталенгс](../atl-mfc-shared/reference/cstringdata-class.md#ndatalength) Это поле содержит текущую логическую длину строки, которая хранится в буфере, за исключением завершающего значения NULL. `CStringT` обновляет это поле при изменении длины строки. При выделении `CStringData` структуры Диспетчер строк должен установить это поле в ноль. При перераспределении `CStringData` структуры диспетчер настраиваемых строк должен оставить это поле без изменений.

- [наллокленгс](../atl-mfc-shared/reference/cstringdata-class.md#nalloclength) Это поле содержит максимальное число символов (исключая завершающее значение null), которое может храниться в буфере строк без перераспределения. Всякий раз `CStringT` , когда необходимо увеличить логическую длину строки, сначала проверяет это поле, чтобы убедиться в наличии достаточного места в буфере. Если проверка завершается неудачно, `CStringT` обращается к диспетчеру пользовательских строк для перераспределения буфера. При выделении или перераспределении `CStringData` структуры необходимо присвоить этому полю хотя бы число символов, запрошенных в параметре *nChars* , в [иатлстрингмгр:: allocate](../atl-mfc-shared/reference/iatlstringmgr-class.md#allocate) или [иатлстрингмгр:: reallocating](../atl-mfc-shared/reference/iatlstringmgr-class.md#reallocate). Если в буфере больше места, чем запрошено, можно задать это значение, чтобы отразить фактический доступный объем пространства. Это позволяет `CStringT` расширить строку для заполнения всего выделенного пространства до того, как оно попытается выполнить обратный вызов к диспетчеру строк для перераспределения буфера.

- [нрефс](../atl-mfc-shared/reference/cstringdata-class.md#nrefs) Это поле содержит текущий счетчик ссылок буфера строк. Если значение равно единице, то один экземпляр `CStringT` использует буфер. Кроме того, экземпляру разрешено считывать и изменять содержимое буфера. Если значение больше одного, `CStringT` то буфер может использоваться несколькими экземплярами. Так как буфер символов является общим, `CStringT` экземпляры могут только считывать содержимое буфера. Чтобы изменить содержимое, `CStringT` сначала создает копию буфера. Если значение отрицательное, то буфер используется только одним экземпляром `CStringT` . В этом случае буфер считается заблокированным. Если `CStringT` экземпляр использует заблокированный буфер, другие экземпляры `CStringT` могут совместно использовать этот буфер. Вместо этого эти экземпляры создают копию буфера, прежде чем манипулировать содержимым. Кроме того, `CStringT` экземпляр, использующий заблокированный буфер, не пытается совместно использовать буфер любого другого `CStringT` назначенного ему экземпляра. В этом случае `CStringT` экземпляр копирует другую строку в заблокированный буфер.

   При выделении `CStringData` структуры необходимо установить это поле в соответствии с типом совместного доступа, разрешенным для буфера. Для большинства реализаций присвойте этому параметру значение One. Это обеспечивает обычное поведение при совместном использовании копирования при записи. Однако если диспетчер строк не поддерживает общий доступ к буферу строк, установите для этого поля состояние заблокировано. Это заставляет `CStringT` использовать этот буфер только для того экземпляра `CStringT` , который его выделил.

## <a name="see-also"></a>См. также раздел

[Управление памятью с помощью CStringT](../atl-mfc-shared/memory-management-with-cstringt.md)
