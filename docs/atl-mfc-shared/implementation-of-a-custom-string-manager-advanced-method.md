---
title: Реализация пользовательского диспетчера строк (расширенный метод)
ms.date: 11/04/2016
helpviewer_keywords:
- IAtlStringMgr class, using
ms.assetid: 64ab7da9-47c1-4c4a-9cd7-4cc37e7f3f57
ms.openlocfilehash: 3854ffe205aa8e6cb9cfb800b9aa1473094fffaf
ms.sourcegitcommit: 0ab61bc3d2b6cfbd52a16c6ab2b97a8ea1864f12
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62235503"
---
# <a name="implementation-of-a-custom-string-manager-advanced-method"></a>Реализация пользовательского диспетчера строк (расширенный метод)

В специализированных ситуациях может потребоваться реализовать Диспетчер настраиваемой строки, больше, чем просто изменить какие-либо кучи используется для выделения памяти. В этом случае необходимо вручную реализовать [IAtlStringMgr](../atl-mfc-shared/reference/iatlstringmgr-class.md) интерфейс, как руководителю настраиваемую строку.

Чтобы сделать это, важно понимать как [CStringT](../atl-mfc-shared/reference/cstringt-class.md) использует этот интерфейс для управления его строковых данных. Каждый экземпляр `CStringT` содержит указатель на [CStringData](../atl-mfc-shared/reference/cstringdata-class.md) структуры. Эта структура переменной длины содержит важные сведения о строке (например, длина), а также данные Фактический символ для строки. Каждый диспетчер Настраиваемая строка отвечает за выделение и освобождение этих структур по запросу `CStringT`.

`CStringData` Структура включает в себя четыре поля:

- [pStringMgr](../atl-mfc-shared/reference/cstringdata-class.md#pstringmgr) это поле указывает на `IAtlStringMgr` интерфейс, используемый для управления этими данными строки. Когда `CStringT` необходимо перераспределить или освободить буфер строки, он вызывает перераспределения или бесплатная методы этого интерфейса, передавая `CStringData` структуры в качестве параметра. При выделении `CStringData` структуры в своим руководителем по строке, необходимо установить это поле для указания настраиваемой строки руководителю.

- [nDataLength](../atl-mfc-shared/reference/cstringdata-class.md#ndatalength) это поле содержит логические текущую длину строки, которые хранятся в буфере, за исключением завершающего нуль-символа. `CStringT` Это поле обновляется при изменении длину строки. При выделении `CStringData` структуры, начальника строку необходимо задайте этому полю значение ноль. При перераспределении `CStringData` структуры, начальника пользовательскую строку, оставьте это поле без изменений.

- [nAllocLength](../atl-mfc-shared/reference/cstringdata-class.md#nalloclength) это поле содержит максимальное число символов (за исключением завершающего нуль-символа), которые могут храниться в этом буфере строки без ее перераспределения. Каждый раз, когда `CStringT` должна увеличиваться логических длину строки, он сначала проверяет это поле, чтобы убедиться, что имеется достаточно места в буфере. Если проверка завершается неудачно, `CStringT` вызывает пользовательскую строку руководителю в перераспределении буфера. При выделении или перераспределения `CStringData` структуры, необходимо установить это поле по крайней мере число символов, запрашиваемый в *nChars* параметр [IAtlStringMgr::Allocate](../atl-mfc-shared/reference/iatlstringmgr-class.md#allocate) или [IAtlStringMgr::Reallocate](../atl-mfc-shared/reference/iatlstringmgr-class.md#reallocate). Если в буфере, чем запрошено больше места, можно задать это значение в соответствии с фактический объем доступного пространства. Это позволяет `CStringT` расти строке, чтобы заполнять все выделенное место до того, как его обратный вызов диспетчера строк в перераспределении буфера.

- [nRefs](../atl-mfc-shared/reference/cstringdata-class.md#nrefs) это поле содержит текущий счетчик ссылок буфера строки. Если значение равно ее, после чего один экземпляр `CStringT` использует буфер. Кроме того экземпляр может читать и изменять содержимое буфера. Если значение больше, чем один, несколько экземпляров `CStringT` можно использовать буфер. Поскольку буфер символов является общим, `CStringT` экземпляров может только считывать содержимое буфера. Для изменения содержимого, `CStringT` сначала создается копия буфера. Если значение является отрицательным, только один экземпляр `CStringT` использует буфер. В этом случае считается буфера заблокирован. Когда `CStringT` экземпляр использует заблокированный буфер другие экземпляры `CStringT` могут совместно использовать буфер. Эти экземпляры создайте копию буфера перед управление содержимым. Кроме того `CStringT` совместное использование буфера любого другого экземпляра, используя заблокированный буфер не пытайтесь `CStringT` назначается экземпляр. В этом случае `CStringT` экземпляр копирует другая строка в заблокированный буфер.

   При выделении `CStringData` структуры, необходимо задать для этого поля зависит от типа совместного использования, для которых разрешено для буфера. Для большинства реализаций задайте это значение. Это позволяет обычным поведением копирования при записи управления доступом. Однако если ваш диспетчера строк не поддерживает совместное использование буфера строки, значение этого поля в заблокированном состоянии. Это заставляет `CStringT` на использование только этого буфера для экземпляра `CStringT` , которые выделены его.

## <a name="see-also"></a>См. также

[Управление памятью с помощью CStringT](../atl-mfc-shared/memory-management-with-cstringt.md)
