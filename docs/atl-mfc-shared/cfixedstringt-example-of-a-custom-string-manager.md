---
title: CFixedStringT. Пример пользовательского диспетчера строк
ms.date: 11/04/2016
helpviewer_keywords:
- CFixedStringT class, using a custom string manager
ms.assetid: 1cf11fd7-51b8-4b94-87af-02bc25f47dd6
ms.openlocfilehash: 2b6da5d4166b220ef63500d0154ab32dc72b40f4
ms.sourcegitcommit: dedd4c3cb28adec3793329018b9163ffddf890a4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/11/2019
ms.locfileid: "57740700"
---
# <a name="cfixedstringt-example-of-a-custom-string-manager"></a>CFixedStringT. Пример пользовательского диспетчера строк

Библиотека ATL реализует один пример диспетчера пользовательскую строку, используемый классом [CFixedStringT](../atl-mfc-shared/reference/cfixedstringt-class.md), который называется **CFixedStringMgr**. `CFixedStringT` является производным от [CStringT](../atl-mfc-shared/reference/cstringt-class.md) и реализует строку, которая выделяет его символьных данных как часть `CFixedStringT` самого объекта до тех пор, пока строка меньше, чем длина, заданная параметром `t_nChars` параметр шаблона `CFixedStringT`. В этом случае строка необязательно кучи, если длина строки выходит за размер буфера фиксированного. Так как `CFixedStringT` не всегда используйте кучу для выделения данных строки, он не может использовать `CAtlStringMgr` руководителем его строку. Он использует диспетчер Настраиваемая строка (`CFixedStringMgr`), реализуя [IAtlStringMgr](../atl-mfc-shared/reference/iatlstringmgr-class.md) интерфейс. Этот интерфейс подробно рассматривается в [реализации из пользовательского диспетчера строк (расширенный метод)](../atl-mfc-shared/implementation-of-a-custom-string-manager-advanced-method.md).

Конструктор `CFixedStringMgr` принимает три параметра:

- *pData:* Указатель к фиксированному `CStringData` структура для использования.

- *nChars:* Максимальное количество символов `CStringData` структура может содержать.

- *pMgr:* Указатель на `IAtlStringMgr` интерфейс «диспетчера резервного копирования строк».

Конструктор сохраняет значения *pData* и *pMgr* в их соответствующие переменные (`m_pData` и `m_pMgr`). Затем он задает длину буфера до нуля, доступных длину равной максимальный размер фиксированном буфере и счетчик ссылок в значение -1. Значения счетчика ссылок указывает, блокируется буфера и использовать этот экземпляр `CFixedStringMgr` как диспетчера строк.

Как заблокированные, помеченное буфера не другой `CStringT` экземпляров из хранение общие ссылки в буфер. Если другие `CStringT` экземпляров разрешено совместное использование буфера, возможно для буфера, содержащихся в `CFixedStringT` Чтобы удалить, пока другие строки используется буфер.

`CFixedStringMgr` — Это полная реализация `IAtlStringMgr` интерфейс. Реализация каждого метода рассматривается отдельно.

## <a name="implementation-of-cfixedstringmgrallocate"></a>Реализация CFixedStringMgr::Allocate

Реализация `CFixedStringMgr::Allocate` сначала проверяет, находится ли запрошенный размер строки меньше или равно размеру фиксированном буфере (хранящиеся в `m_pData` член). Если в фиксированном буфере слишком велик, `CFixedStringMgr` блокирует фиксированный буфер с нулевой длины. До тех пор, пока длина строки не превысит размер буфера фиксированного `CStringT` не потребуется освободить буфер.

Если запрошенный размер строки больше, чем фиксированном буфере `CFixedStringMgr` пересылает запрос диспетчера резервного копирования строк. Предполагается, что диспетчера резервного копирования строк выделить буфер из кучи. Тем не менее, перед возвратом этот буфер `CFixedStringMgr` блокирует буфер и заменяет указатель на указатель на диспетчер буфера строку `CFixedStringMgr` объекта. Таким образом, в которой выполняется попытка перераспределить или освободить буфер путем `CStringT` будет вызывать `CFixedStringMgr`.

## <a name="implementation-of-cfixedstringmgrreallocate"></a>Реализация CFixedStringMgr::ReAllocate

Реализация `CFixedStringMgr::ReAllocate` очень похожа на реализацию `Allocate`.

Если перебрасываются ли буфер — это фиксированный буфер и запрошенным размером буфера меньше, чем фиксированном буфере, выделение не выполняется. Тем не менее если буфер перебрасываются ли не фиксированном буфере, его необходимо буфер, выделенный с помощью диспетчера резервного копирования. В этом случае диспетчера резервного копирования позволяет освободить буфер.

Если буфер перебрасываются ли фиксированном буфере и новый размер буфера слишком велик для размещения в фиксированном буфере `CFixedStringMgr` выделяет новый буфер, с помощью диспетчера резервного копирования. Содержимое буфера фиксированного затем копируются в новый буфер.

## <a name="implementation-of-cfixedstringmgrfree"></a>Реализация CFixedStringMgr::Free

Реализация `CFixedStringMgr::Free` та же схема, как `Allocate` и `ReAllocate`. Если буфер при освобождении фиксированном буфере, метод устанавливает его в буфер, заблокированный нулевой длины. Если при освобождении буфер был выделен с помощью диспетчера резервного копирования, `CFixedStringMgr` использует резервного копирования диспетчер освободит его.

## <a name="implementation-of-cfixedstringmgrclone"></a>Реализация CFixedStringMgr::Clone

Реализация `CFixedStringMgr::Clone` всегда возвращает указатель на диспетчер резервного копирования, а не `CFixedStringMgr` сам. Это происходит потому, что каждый экземпляр `CFixedStringMgr` может быть связан только с одним экземпляром `CStringT`. Все другие экземпляры `CStringT` пытаетесь клонировать диспетчер должен получить резервного копирования диспетчер вместо этого. Это обусловлено диспетчера резервного копирования поддерживает общий доступ.

## <a name="implementation-of-cfixedstringmgrgetnilstring"></a>Реализация CFixedStringMgr::GetNilString

Реализация `CFixedStringMgr::GetNilString` возвращает фиксированном буфере. Из-за индивидуальной соответствие `CFixedStringMgr` и `CStringT`, в заданном экземпляре `CStringT` никогда не использует более чем один буфер за раз. Таким образом в то же время никогда не требуется нулевая строка и реальных строковый буфер.

Каждый раз, когда в фиксированном буфере не используется, `CFixedStringMgr` гарантирует, что он инициализирован с нулевой длины. Это позволяет использовать в качестве нулевая строка. Как бонус `nAllocLength` членом фиксированном буфере всегда имеет значение полного объема фиксированном буфере. Это означает, что `CStringT` может увеличиваться строка без вызова [IAtlStringMgr::Reallocate](../atl-mfc-shared/reference/iatlstringmgr-class.md#reallocate), даже для пустой строки.

## <a name="requirements"></a>Требования

**Заголовок:** cstringt.h

## <a name="see-also"></a>См. также

[Управление памятью с помощью CStringT](../atl-mfc-shared/memory-management-with-cstringt.md)
