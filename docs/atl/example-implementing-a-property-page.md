---
title: Реализация страницы свойств (ATL)
ms.date: 05/09/2019
helpviewer_keywords:
- property pages, implementing
ms.assetid: c30b67fe-ce08-4249-ae29-f3060fa8d61e
ms.openlocfilehash: 688cd337d0754fc49ede0f39fd774c9990f7c79f
ms.sourcegitcommit: 1f009ab0f2cc4a177f2d1353d5a38f164612bdb1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/27/2020
ms.locfileid: "87224361"
---
# <a name="example-implementing-a-property-page"></a>Пример. Реализация страницы свойств

::: moniker range="vs-2019"

Мастер страницы свойств в ATL недоступен в Visual Studio 2019 и более поздних версиях.

::: moniker-end

::: moniker range="<=vs-2017"

В этом примере показано, как создать страницу свойств, которая отображает (и позволяет изменять) свойства интерфейса [класса документов](../mfc/document-classes.md).

Пример основан на [примере ATLPages](../overview/visual-cpp-samples.md).

Для работы с этим примером вам необходимо сделать следующее:

- [Добавьте класс страницы свойств ATL](#vcconusing_the_atl_object_wizard), используя диалоговое окно "Добавление класса" и мастер страницы свойств ATL.

- [Измените ресурс диалогового окна](#vcconediting_the_dialog_resource), добавив новые элементы управления для нужных свойств интерфейса `Document`.

- [Добавьте обработчики сообщений](#vcconadding_message_handlers), чтобы информировать сайт страницы свойств об изменениях, внесенных пользователем.

- Добавьте несколько операторов `#import` и определение типа в разделе [Действия по обслуживанию](#vcconhousekeeping).

- [Переопределите IPropertyPageImpl::SetObjects](#vcconoverriding_ipropertypageimpl_setobjects), чтобы проверить объекты, передаваемые на страницу свойств.

- [Переопределите IPropertyPageImpl::Activate](#vcconoverriding_ipropertypageimpl_activate), чтобы инициализировать интерфейс страницы свойств.

- [Переопределите IPropertyPageImpl::Apply](#vcconoverride_ipropertypageimpl_apply), чтобы обновить последние значения свойств для объекта.

- [Отобразите страницу свойств](#vccontesting_the_property_page), создав простой вспомогательный объект.

- [Создайте макрос](#vcconcreating_a_macro), который будет проверять страницу свойств.

## <a name="adding-the-atl-property-page-class"></a><a name="vcconusing_the_atl_object_wizard"></a> Добавление класса страницы свойств ATL

Сначала создайте проект ATL для сервера DLL с именем `ATLPages7`. Теперь с помощью мастера [страницы свойств ATL](../atl/reference/atl-property-page-wizard.md) создайте страницу свойств. Дайте странице свойств **короткое имя** из **DocProperties**, затем перейдите на страницу **строк**, чтобы задать элементы, относящиеся к странице свойства, как показано в таблице ниже.

|Элемент|Значение|
|----------|-----------|
|Title|TextDocument|
|Строка документа|Свойства TextDocument VCUE|
|Helpfile|*\<blank>*|

Значения, заданные на этой странице мастера, будут возвращены в контейнер страницы свойств при вызове `IPropertyPage::GetPageInfo`. После этого происходящее со строками зависит от контейнера, но обычно они будут использоваться для идентификации вашей страницы для пользователя. Заголовок обычно отображается на вкладке над вашей страницей, а строка документа может отображаться в строке состояния или всплывающей подсказке (хотя стандартный фрейм свойств вообще не использует эту строку).

> [!NOTE]
> Заданные здесь строки сохраняются мастером в качестве строковых ресурсов в вашем проекте. Вы можете легко изменять эти строки, используя редактор ресурсов, если вам нужно изменить эти сведения после того, как был создан код для вашей страницы.

Нажмите кнопку **ОК**, чтобы мастер создал страницу свойств.

## <a name="editing-the-dialog-resource"></a><a name="vcconediting_the_dialog_resource"></a> Изменение ресурса диалогового окна

Теперь, когда создана страница, нужно добавить несколько элементов управления в ресурс диалогового окна, представляющего вашу страницу. Добавьте поле редактирования, статический текстовый элемент управления, флажок и настройте их идентификаторы, как показано ниже:

![Изменение ресурса диалогового окна](../atl/media/ppgresourcelabeled.gif "Изменение ресурса диалогового окна")

Эти элементы управления будут использоваться для отображения имени файла документа и его состояния "только для чтения".

> [!NOTE]
> Ресурс диалогового окна не содержит фрейм или кнопки команд, а также не имеет ожидаемых вкладок. Эти функции предоставляются фреймом страницы свойств, например, созданным с помощью вызова [OleCreatePropertyFrame](/windows/win32/api/olectl/nf-olectl-olecreatepropertyframe).

## <a name="adding-message-handlers"></a><a name="vcconadding_message_handlers"></a> Добавление обработчиков сообщений

После настройки элементов управления вы можете добавить обработчики сообщений, чтобы обновить "грязное" состояние страницы при изменении значения любого из элементов управления:

[!code-cpp[NVC_ATL_Windowing#73](../atl/codesnippet/cpp/example-implementing-a-property-page_1.h)]

Этот код реагирует на изменения, внесенные в элемент управления или флажок редактирования, вызывая [IPropertyPageImpl::SetDirty](../atl/reference/ipropertypageimpl-class.md#setdirty), который сообщает сайту о том, что страница изменилась. Обычно сайт реагирует включением или отключением кнопки **Применить** во фрейме страницы свойств.

> [!NOTE]
> На ваших страницах свойств может потребоваться точно отслеживать, какие свойства были изменены пользователем, чтобы избежать обновления неизмененных свойств. В этом примере код реализуется путем отслеживания исходных значений свойств и сравнения их с текущими значениями из пользовательского интерфейса, когда следует применить изменения.

## <a name="housekeeping"></a><a name="vcconhousekeeping"></a> Действия по обслуживанию

Теперь добавьте пару операторов `#import` в файл DocProperties.h, чтобы компилятору было известно об интерфейсе `Document`:

[!code-cpp[NVC_ATL_Windowing#74](../atl/codesnippet/cpp/example-implementing-a-property-page_2.h)]

Также необходимо будет ссылаться на `IPropertyPageImpl` базовый класс, добавить в **`typedef`** класс следующее `CDocProperties` :

[!code-cpp[NVC_ATL_Windowing#75](../atl/codesnippet/cpp/example-implementing-a-property-page_3.h)]

## <a name="overriding-ipropertypageimplsetobjects"></a><a name="vcconoverriding_ipropertypageimpl_setobjects"></a> Переопределение IPropertyPageImpl::SetObjects

Первый метод `IPropertyPageImpl`, который вам нужно переопределить, это [SetObjects](../atl/reference/ipropertypageimpl-class.md#setobjects). Добавьте сюда код, чтобы убедиться, что передан только один объект и что он поддерживает ожидаемый интерфейс `Document`:

[!code-cpp[NVC_ATL_Windowing#76](../atl/codesnippet/cpp/example-implementing-a-property-page_4.h)]

> [!NOTE]
> Имеет смысл поддерживать только один объект для этой страницы, потому что вы позволите пользователю устанавливать имя файла объекта. В любом расположении может существовать только один файл.

## <a name="overriding-ipropertypageimplactivate"></a><a name="vcconoverriding_ipropertypageimpl_activate"></a> Переопределение IPropertyPageImpl::Activate

Следующим шагом является инициализация страницы свойств с помощью значений свойств базового объекта при первом создании страницы.

В этом случае вы должны добавить следующие члены в класс, так как вы также будете использовать начальные значения свойств для сравнения, когда пользователи страницы применяют свои изменения:

[!code-cpp[NVC_ATL_Windowing#77](../atl/codesnippet/cpp/example-implementing-a-property-page_5.h)]

Реализация базового класса метода [Activate](../atl/reference/ipropertypageimpl-class.md#activate) отвечает за создание диалогового окна и его элементов управления, поэтому вы можете переопределить этот метод и добавить собственную инициализацию после вызова базового класса:

[!code-cpp[NVC_ATL_Windowing#78](../atl/codesnippet/cpp/example-implementing-a-property-page_6.h)]

Этот код использует методы COM интерфейса `Document`, чтобы получить требуемые свойства. Затем он использует программы-оболочки API Win32, предоставленные [CDialogImpl](../atl/reference/cdialogimpl-class.md) и его базовыми классами, для отображения значений свойств для пользователя.

## <a name="overriding-ipropertypageimplapply"></a><a name="vcconoverride_ipropertypageimpl_apply"></a> Переопределение IPropertyPageImpl::Apply

Когда пользователи хотят применить свои изменения к объектам, сайт страницы свойств вызовет метод [Apply](../atl/reference/ipropertypageimpl-class.md#apply). Теперь следует создать обратный код в `Activate`, в котором `Activate` принимает значения из объекта и отправляет их в элементы управления на странице свойств, а `Apply` получает значения из элементов управления на странице свойств и отправляет их в объект.

[!code-cpp[NVC_ATL_Windowing#79](../atl/codesnippet/cpp/example-implementing-a-property-page_7.h)]

> [!NOTE]
> Проверка [m_bDirty](../atl/reference/ipropertypageimpl-class.md#m_bdirty) в начале этой реализации является начальной проверкой, позволяющей избежать ненужного обновления объектов, если `Apply` вызывается несколько раз. Проверяются также значения каждого свойства, чтобы гарантировать, что только изменения приведут к вызову метода `Document`.

> [!NOTE]
> `Document` предоставляет `FullName` в виде свойства "только для чтения". Для обновления имени файла документа на основе изменений, внесенных в страницу свойств, необходимо использовать метод `Save`, чтобы сохранить файл с другим именем. Таким образом, код на странице свойств не должен только получать или настраивать свойства.

## <a name="displaying-the-property-page"></a><a name="vccontesting_the_property_page"></a> Отображение страницы свойств

Чтобы отобразить эту страницу, вам нужно создать простой вспомогательный объект. Вспомогательный объект предоставляет метод, который упрощает API `OleCreatePropertyFrame` для отображения одной страницы, подключенной к одному объекту. Этот объект будет спроектирован так, чтобы его можно было использовать из Visual Basic.

Используйте [диалоговое окно "Добавление класса"](../ide/add-class-dialog-box.md) и [мастер простых объектов ATL](../atl/reference/atl-simple-object-wizard.md), чтобы создать класс, используя `Helper` в качестве его короткого имени. После создания добавьте метод, как показано в таблице ниже.

|Элемент|Значение|
|----------|-----------|
|Имя метода|`ShowPage`|
|Параметры|`[in] BSTR bstrCaption, [in] BSTR bstrID, [in] IUnknown* pUnk`|

Параметр *bstrCaption* является заголовком, отображаемым в качестве заголовка диалогового окна. Параметр *bstrID* является строкой, которая отображает CLSID либо ProgID страницы свойств. Параметр *pUnk* будет указателем `IUnknown` объекта, свойства которого будут настроены на странице свойств.

Реализуйте метод, как показано ниже:

[!code-cpp[NVC_ATL_Windowing#80](../atl/codesnippet/cpp/example-implementing-a-property-page_8.cpp)]

## <a name="creating-a-macro"></a><a name="vcconcreating_a_macro"></a> Создание макроса

Создав проект, вы можете протестировать страницу свойств и вспомогательный объект с помощью простого макроса, который можно создать и запустить в среде разработки Visual Studio. Этот макрос создаст вспомогательный объект, затем вызовет его метод `ShowPage`, используя ProgID страницы свойств **DocProperties** и указатель `IUnknown` документа, активного в данный момент в редакторе Visual Studio. Ниже показан код, необходимый для этого макроса:

```vb
Imports EnvDTE
Imports System.Diagnostics

Public Module AtlPages

Public Sub Test()
    Dim Helper
    Helper = CreateObject("ATLPages7.Helper.1")

    On Error Resume Next
    Helper.ShowPage( ActiveDocument.Name, "ATLPages7Lib.DocumentProperties.1", DTE.ActiveDocument )
End Sub

End Module
```

При запуске этого макроса будет показана страница свойств, отображающая имя файла и состояние "только для чтения" текущего активного текстового документа. Доступное только для чтения состояние документа влияет только на возможность записи в документ в среде разработки и не влияет на атрибут "только для чтения" файла на диске.

::: moniker-end

## <a name="see-also"></a>См. также статью

[Страницы свойств](../atl/atl-com-property-pages.md)<br/>
[Примеры кода на Visual C++](../overview/visual-cpp-samples.md)
