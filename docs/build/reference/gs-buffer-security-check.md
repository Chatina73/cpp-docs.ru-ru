---
title: Параметр /GS (проверка безопасности буфера)
ms.date: 11/04/2016
f1_keywords:
- VC.Project.VCCLWCECompilerTool.BufferSecurityCheck
- VC.Project.VCCLCompilerTool.BufferSecurityCheck
- /GS
helpviewer_keywords:
- buffers [C++], buffer overruns
- buffer overruns, compiler /GS switch
- GS compiler option [C++]
- /GS compiler option [C++]
- security check compiler option [C++]
- -GS compiler option [C++]
- buffers [C++], avoiding overruns
ms.assetid: 8d8a5ea1-cd5e-42e1-bc36-66e1cd7e731e
ms.openlocfilehash: 6681ff09b846011af1b500f88a535c208d0bc1c1
ms.sourcegitcommit: bff17488ac5538b8eaac57156a4d6f06b37d6b7f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2019
ms.locfileid: "57417611"
---
# <a name="gs-buffer-security-check"></a>Параметр /GS (проверка безопасности буфера)

Обнаруживаются некоторые переполнения буфера, при которых перезаписывается обратный адрес функции, адрес обработчика исключения или определенные типы параметров. Вызов переполнения буфера — это метод, используемый хакерами для использования кода, в котором не используется принудительное ограничение размера буфера.

## <a name="syntax"></a>Синтаксис

```
/GS[-]
```

## <a name="remarks"></a>Примечания

**/ GS** по умолчанию. Если ожидается, что приложения без проблем безопасности, используйте **/GS-**. Дополнительные сведения о подавлении обнаружения переполнения буфера, см. в разделе [safebuffers](../../cpp/safebuffers.md).

## <a name="security-checks"></a>Проверки безопасности

Для функций, которые компилятор распознает как распространяются проблемы переполнения буфера компилятор выделяет место в стеке перед адреса возврата. При входе в функцию выделенное пространство загружается с *cookie безопасности* , формируется один раз при загрузке модуля. На выходе из функции, а также при очистке кадра в 64-разрядных операционных системах вспомогательная функция вызывается для убедитесь, что значение файла cookie, который остается неизменным. Другое значение указывает, что мог произойти перезапись стека. Если значение обнаруживается, процесс завершается.

## <a name="gs-buffers"></a>Буферы GS

Проверка безопасности на переполнение буфера выполняется на *буферы*. Буфер GS может быть один из следующих:

- Массив, размер которых превышает 4 байта, состоит из более чем двух элементов и имеет тип элемента, который не является типом указателя.

- Структура данных, размер которых превышает 8 байт и не содержит указателей.

- Буфер, выделенный с помощью [_alloca](../../c-runtime-library/reference/alloca.md) функции.

- Любой класс или структуру, содержащую буфер GS.

Например следующие инструкции объявляют буферы GS.

```cpp
char buffer[20];
int buffer[20];
struct { int a; int b; int c; int d; } myStruct;
struct { int a; char buf[20]; };
```

Тем не менее следующие инструкции не объявляйте буферы GS. Первые два объявления содержать элементы типа указателя. Третий и четвертый операторы объявления массивов, размер которых слишком мал. Пятая инструкция объявляет структуру, размер которого x86 платформы не более 8 байт.

```cpp
char *pBuf[20];
void *pv[20];
char buf[4];
int buf[2];
struct { int a; int b; };
```

## <a name="initialize-the-security-cookie"></a>Инициализируйте элемент Cookie безопасности

**/GS** параметр компилятора требуется инициализировать элемент cookie безопасности перед запуском любая функция, которая использует файл cookie. Файл cookie безопасности должны инициализироваться сразу на запись в файл EXE или DLL. Это выполняется автоматически при использовании точки входа по умолчанию VCRuntime: mainCRTStartup, wmainCRTStartup, случае wWinMainCRTStartup, или _DllMainCRTStartup. При использовании точки входа альтернативный объект безопасности cookie необходимо инициализировать вручную путем вызова [__security_init_cookie](../../c-runtime-library/reference/security-init-cookie.md).

## <a name="what-is-protected"></a>Что защищается

**/GS** параметр компилятора защищает следующие элементы:

- Обратный адрес вызова функции.

- Адрес обработчика исключений для функции.

- Параметры уязвимой функции.

На всех платформах **/GS** пытается обнаружить переполнение буфера обратный адрес. Переполнение буфера чаще на платформах, например x86 и x64, который использовать соглашения о вызовах, в которых хранятся обратный адрес вызова функции в стеке.

На x86 Если функция использует обработчик исключений, что компилятор вводит файл cookie безопасности для защиты адреса обработчика исключений. Куки-файл проверяется при очистке кадра.

**/ GS** защищает *уязвимых параметров* , которые передаются в функцию. Уязвимые параметр является указателем, справочник по C++, C-структуру (тип C++ POD), содержащую указатель, а также буферы.

Уязвимых параметров выделяется перед файл cookie и локальные переменные. Переполнение буфера может перезаписать эти параметры. И код в функцию, которая использует эти параметры может вызвать атаку, прежде чем возвращаемого значения и выполняет проверку безопасности. Чтобы свести к минимуму эту опасность, компилятор создает копию уязвимых параметров в прологе функции и помещает их ниже области хранения буферов.

Компилятор не выполняет копии уязвимых параметров в следующих ситуациях:

- Функции, которые не содержат буфер GS.

- Оптимизация ([параметры /O](../../build/reference/o-options-optimize-code.md)) не включены.

- Функции, которые имеют список аргументов переменных (...).

- Функции, помеченные атрибутом [с атрибутом naked](../../cpp/naked-cpp.md).

- Функции, которые содержит встроенный код ассемблера в первой инструкции.

- Параметр используется только теми способами, которые меньшую вероятность оказаться могут быть использованы в случае переполнения буфера.

## <a name="what-is-not-protected"></a>Что не защищена

**/GS** параметр компилятора не защищает от всех атак на систему безопасности, переполнение буфера. Например если буфер и таблица в объекте, переполнение буфера может повредить vtable.

Даже если вы используете **/GS**, всегда пытаться писать безопасный код, не имеющий переполнений буфера.

### <a name="to-set-this-compiler-option-in-visual-studio"></a>Установка параметра компилятора в Visual Studio

1. В **обозревателе решений**, щелкните правой кнопкой мыши проект и нажмите кнопку **свойства**.

   Дополнительные сведения см. в разделе [Работа со свойствами проекта](../../ide/working-with-project-properties.md).

1. В **страницы свойств** диалоговом окне щелкните **C/C++** папки.

1. Нажмите кнопку **создание кода** страницу свойств.

1. Изменить **проверка безопасности буфера** свойство.

### <a name="to-set-this-compiler-option-programmatically"></a>Установка данного параметра компилятора программным способом

- См. раздел <xref:Microsoft.VisualStudio.VCProjectEngine.VCCLCompilerTool.BufferSecurityCheck%2A>.

## <a name="example"></a>Пример

В этом примере происходит переполнение буфера. Это приводит к сбою во время выполнения приложения.

```C
// compile with: /c /W1
#include <cstring>
#include <stdlib.h>
#pragma warning(disable : 4996)   // for strcpy use

// Vulnerable function
void vulnerable(const char *str) {
   char buffer[10];
   strcpy(buffer, str); // overrun buffer !!!

   // use a secure CRT function to help prevent buffer overruns
   // truncate string to fit a 10 byte buffer
   // strncpy_s(buffer, _countof(buffer), str, _TRUNCATE);
}

int main() {
   // declare buffer that is bigger than expected
   char large_buffer[] = "This string is longer than 10 characters!!";
   vulnerable(large_buffer);
}
```

## <a name="see-also"></a>См. также

[Параметры компилятора](../../build/reference/compiler-options.md)<br/>
[Настройка параметров компилятора](../../build/reference/setting-compiler-options.md)
