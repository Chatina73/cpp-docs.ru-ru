---
title: Обработка ошибок и предупреждений
description: Дополнительные сведения см. в статье обработка и уведомление об ошибках при загрузке с задержкой DLL.
ms.date: 01/19/2021
helpviewer_keywords:
- error handling, and notification
ms.openlocfilehash: efff7ba9956bee8fe6ccf1df96a3f4b49852ce43
ms.sourcegitcommit: c20734f18d3d49bb38b1628c68b53b54b3eeeb03
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "99522564"
---
# <a name="error-handling-and-notification"></a>Обработка ошибок и предупреждений

Если программа использует библиотеки DLL с отложенной загрузкой, она должна обеспечивать устойчивую обработку ошибок, так как сбои, происходящие во время работы программы, приводят к необработанным исключениям. Обработка сбоев состоит из двух частей: восстановление с помощью обработчика и создание отчетов с помощью исключения.

Дополнительные сведения о обработке и уведомлении об ошибках при отложенной загрузке DLL см. [в разделе Знакомство с вспомогательной функцией](understanding-the-helper-function.md).

Дополнительные сведения о функциях-ловушках см. в разделе [определения структуры и константы](understanding-the-helper-function.md#structure-and-constant-definitions).

## <a name="recovery-through-a-hook"></a>Восстановление с помощью обработчика

Возможно, вам потребуется восстановить код при сбое или предоставить альтернативную библиотеку или подпрограмму. Можно создать обработчик для вспомогательной функции, которая может предоставить альтернативный код или устранить ситуацию. Подпрограммы-ловушки должны возвращать подходящее значение, чтобы обработка может быть продолжена ( `HINSTANCE` или `FARPROC` ). Или может возвращать значение 0, чтобы указать, что должно быть создано исключение. Он также может создать собственное исключение или `longjmp` выйти из обработчика. Существуют обработчики уведомлений и обработчики сбоев. Одну и ту же подпрограммы можно использовать для обоих типов.

## <a name="notification-hooks"></a><a name="notification-hooks"></a> Обработчики уведомлений

Обработчики уведомлений о задержках загрузки вызываются непосредственно перед выполнением следующих действий в вспомогательной подпрограммы:

- Сохраненный обработчик для библиотеки проверяется на наличие уже загруженного.

- `LoadLibrary` вызывается для попыток загрузки библиотеки DLL.

- `GetProcAddress` метод вызывается, чтобы попытаться получить адрес процедуры.

- Вернитесь к преобразовательу отложенных импортов нагрузки.

Обработчик уведомлений включен:

- Путем предоставления нового определения указателя `__pfnDliNotifyHook2` , который инициализируется для указания собственной функции, получающей уведомления.

   \-или-

- Установив указатель `__pfnDliNotifyHook2` на функцию-ловушку перед вызовами DLL, которые программа загружает с задержкой.

Если уведомление имеет значение `dliStartProcessing` , функция-обработчик может вернуть:

- `NULL`

   Вспомогательный модуль по умолчанию обрабатывает загрузку библиотеки DLL. Этот метод полезен только в информационных целях.

- Указатель на функцию

   Обойти обработку отложенной загрузки по умолчанию. Он позволяет указать собственный обработчик нагрузки.

Если уведомление имеет значение `dliNotePreLoadLibrary` , функция-обработчик может вернуть:

- 0, если требуется только информационное уведомление.

- `HMODULE`Для загруженной библиотеки DLL, если она загрузила саму библиотеку DLL.

Если уведомление имеет значение `dliNotePreGetProcAddress` , функция-обработчик может вернуть:

- 0, если требуется только информационное уведомление.

- Адрес импортированной функции, если функция-обработчик получает сам адрес.

Если уведомление равно `dliNoteEndProcessing` , возвращаемое значение функции-обработчика игнорируется.

Если этот указатель инициализирован (не равен нулю), вспомогательная функция отложенной загрузки вызывает функцию в определенных точках уведомления во время выполнения. Указатель функции имеет следующее определение:

```C
// The "notify hook" gets called for every call to the
// delay load helper.  This allows a user to hook every call and
// skip the delay load helper entirely.
//
// dliNotify == {
//  dliStartProcessing |
//  dliNotePreLoadLibrary  |
//  dliNotePreGetProc |
//  dliNoteEndProcessing}
//  on this call.
//
ExternC
PfnDliHook   __pfnDliNotifyHook2;

// This is the failure hook, dliNotify = {dliFailLoadLib|dliFailGetProc}
ExternC
PfnDliHook   __pfnDliFailureHook2;
```

Уведомления передают `DelayLoadInfo` структуру функции-обработчику вместе со значением уведомления. Эти данные идентичны данным, используемым вспомогательной подсистемой с отложенной загрузкой. Значением уведомления будет одно из значений, определенных в [определениях структуры и констант](understanding-the-helper-function.md#structure-and-constant-definitions).

## <a name="failure-hooks"></a><a name="failure-hooks"></a> Перехватчики ошибки

Ловушка сбоя включена так же, как [обработчик уведомлений](#notification-hooks). Подпрограммы-ловушки должны возвращать подходящее значение, чтобы обработка могла продолжаться ( `HINSTANCE` или `FARPROC` ), или 0, чтобы указать, что должно быть создано исключение.

Переменная указателя, ссылающаяся на определяемую пользователем функцию, имеет следующие вид:

```C
// This is the failure hook, dliNotify = {dliFailLoadLib|dliFailGetProc}
ExternC
PfnDliHook   __pfnDliFailureHook2;
```

**`DelayLoadInfo`** Структура содержит все данные, необходимые для подробной отчетности об ошибке, включая значение из `GetLastError` .

Если уведомление имеет значение **`dliFailLoadLib`** , функция-обработчик может вернуть:

- 0, если не удается справиться с ошибкой.

- Значение `HMODULE` , если обработчик сбоев устранил проблему и загрузил саму библиотеку.

Если уведомление имеет значение **`dliFailGetProc`** , функция-обработчик может вернуть:

- 0, если не удается справиться с ошибкой.

- Допустимый адрес процедуры (адрес функции импорта), если обработчик сбоев успешно получает адрес.

## <a name="report-by-using-an-exception"></a>Отчет с помощью исключения

Если все, что требуется для обработки ошибки, — прерывание процедуры, обработчик не требуется, пока пользовательский код может справиться с этим исключением.

## <a name="delay-load-exception-codes"></a><a name="delay-load-exception-codes"></a> Коды исключений задержки загрузки

Структурированные коды исключений могут возникать при сбоях во время отложенной загрузки. Значения исключений задаются с помощью `VcppException` макроса:

```C
//
// Exception information
//
#define FACILITY_VISUALCPP  ((LONG)0x6d)
#define VcppException(sev,err)  ((sev) | (FACILITY_VISUALCPP<<16) | err)
```

В случае `LoadLibrary` сбоя `VcppException(ERROR_SEVERITY_ERROR, ERROR_MOD_NOT_FOUND)` выдается Стандартный. В случае `GetProcAddress` сбоя возникает ошибка `VcppException(ERROR_SEVERITY_ERROR, ERROR_PROC_NOT_FOUND)` . Исключение передает указатель на `DelayLoadInfo` структуру. Он находится в `LPDWORD` значении, извлеченном `GetExceptionInformation` из [`EXCEPTION_RECORD`](/windows/win32/api/winnt/ns-winnt-exception_record) структуры в `ExceptionInformation[0]` поле.

Если в поле заданы неверные биты `grAttrs` , `ERROR_INVALID_PARAMETER` возникает исключение. Это исключение для всех целей и назначений, неустранимое.

Дополнительные сведения см. в разделе [определения структуры и константы](understanding-the-helper-function.md#structure-and-constant-definitions).

## <a name="see-also"></a>См. также

[Поддержка компоновщика для библиотек DLL с отложенной загрузкой](linker-support-for-delay-loaded-dlls.md)
