---
title: /kernel (создание двоичного файла режима ядра)
description: Параметр/kernel компилятора Microsoft C/C++ создает и связывает проекты для выполнения в режиме ядра.
ms.date: 09/28/2020
f1_keywords:
- /kernel
- /kernel-
ms.assetid: 6d7fdff0-c3d1-4b78-9367-4da588ce8b05
ms.openlocfilehash: 8a8c02a6f102a52afbc52c154ce215ede3f38f74
ms.sourcegitcommit: a1676bf6caae05ecd698f26ed80c08828722b237
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/29/2020
ms.locfileid: "91509347"
---
# <a name="kernel-create-kernel-mode-binary"></a>/kernel (создание двоичного файла режима ядра)

Создает двоичный файл, который может быть выполнен в ядре Windows. Код в текущем проекте компилируется и связывается с помощью упрощенного набора функций языка C++, характерных для кода, выполняемого в режиме ядра.

## <a name="syntax"></a>Синтаксис

> **`/kernel`**

## <a name="remarks"></a>Remarks

Указание **`/kernel`** параметра дает возможность компилятору и компоновщику определить, какие функции языка допустимы в режиме ядра, и убедиться, что у вас достаточно выразительные электроэнергию, чтобы избежать нестабильности среды выполнения, уникальной для режима ядра C++. Это делается путем запрета использования функций языка C++, которые нарушают работу в режиме ядра. Компилятор создает предупреждения для функций языка C++, которые потенциально нарушают работу, но не могут быть отключены.

**`/kernel`** Параметр применяется к этапам компилятора и компоновщика сборки и устанавливается на уровне проекта. Передайте **`/kernel`** параметр, чтобы указать компилятору, что результирующий двоичный файл после компоновки должен быть загружен в ядро Windows. Компилятор будет ограничивать спектр возможностей языка C++ до подмножества, совместимого с ядром.

В следующей таблице приводится список изменений в поведении компилятора **`/kernel`** , если указан параметр.

| Тип поведения | **`/kernel`** неполадок |
|--|--|
| Обработка исключений С++ | Отключена. Все экземпляры **`throw`** **`try`** ключевых слов и выдают ошибку компилятора (за исключением спецификации исключения `throw()` ). Ни один из **`/EH`** параметров не совместим с **`/kernel`** , за исключением **`/EH-`** . |
| RTTI | Отключена. Все экземпляры **`dynamic_cast`** **`typeid`** ключевых слов и выдают ошибку компилятора, если только **`dynamic_cast`** не используется статически. |
| `new` и `delete` | Необходимо явно определить `new()` `delete()` оператор или. Компилятор и среда выполнения не предоставляют определение по умолчанию. |

При использовании параметра разрешены пользовательские соглашения о вызовах, [`/GS`](gs-buffer-security-check.md) параметр сборки и все оптимизации **`/kernel`** . На встраивание в основном не влияет **`/kernel`** та же семантика, что и компилятор. Если необходимо убедиться в том, что **`__forceinline`** квалификатор встраивания учитывается, необходимо убедиться в том, что предупреждение [C4714](../../error-messages/compiler-warnings/compiler-warning-level-4-c4714.md) включено, чтобы вы узнали, когда определенная **`__forceinline`** функция не встроена.

`#pragma`Для управления этим параметром нет эквивалентов.

Когда компилятор передается **`/kernel`** параметром, он предварительно определяет макрос препроцессора с именем `_KERNEL_MODE` и имеет значение **1**. Этот макрос можно использовать для условной компиляции кода в зависимости от того, находится ли среда выполнения в пользовательском режиме или режиме ядра. Например, следующий код указывает, что `MyNonPagedClass` класс должен находиться в сегменте памяти, не являющемся страничным, когда он компилируется для выполнения в режиме ядра.

```cpp
#ifdef _KERNEL_MODE
#define NONPAGESECTION __declspec(code_seg("$kerneltext$"))
#else
#define NONPAGESECTION
#endif

class NONPAGESECTION MyNonPagedClass
{
   // ...
};
```

Некоторые из приведенных ниже сочетаний целевой архитектуры и **`/arch`** параметр выдают ошибку при использовании с **`/kernel`** :

- **`/arch:SSE`**, **`/arch:SSE2`** , **`/arch:AVX`** , **`/arch:AVX2`** и **`/arch:AVX512`** не поддерживаются на платформе x86. **`/arch:IA32`** Поддерживается только **`/kernel`** для на платформе x86.

- **`/arch:AVX`**, **`/arch:AVX2`** и **`/arch:AVX512`** не поддерживаются **`/kernel`** в версии x64.

Сборка с помощью **`/kernel`** также передается в **`/kernel`** Компоновщик. Ниже показано, как параметр влияет на поведение компоновщика.

- Инкрементная компоновка отключена. Если добавить **`/incremental`** в командную строку, компоновщик выдаст эту неустранимую ошибку:

   **Неустранимая ошибка LNK1295: "/INCREMENTAL" несовместим с спецификацией "/KERNEL"; Ссылка без "/INCREMENTAL"**

- Компоновщик проверяет каждый объектный файл (или любой включенный элемент архива из статических библиотек), чтобы определить, может ли он быть скомпилирован с помощью **`/kernel`** параметра, но не был. Если какие-либо экземпляры соответствуют этому критерию, компоновщик все равно успешно ссылается, но может выдать предупреждение, как показано в следующей таблице.

   | Команда | **`/kernel`** расширением | не- **`/kernel`** obj, MASM obj или cvtres OBJ | Сочетание **`/kernel`** и не **`/kernel`** OBJ-файлы |
   |--|--|--|--|
   | **`link /kernel`** | Да | Да | Да, с предупреждением LNK4257 |
   | **`link`** | Да | Да | Да |

   **Объект компоновки LNK4257 не компилируется с/KERNEL; образ не может быть запущен**

**`/kernel`** Параметр и **`/driver`** параметр работают независимо друг от друга. Они не влияют друг на друга.

### <a name="to-set-the-kernel-compiler-option-in-visual-studio"></a>Установка параметра компилятора/kernel в Visual Studio

1. Откройте диалоговое окно **Страницы свойств** проекта. Подробнее см. в статье [Настройка компилятора C++ и свойств сборки в Visual Studio](../working-with-project-properties.md).

1. Выберите страницу свойств **Свойства конфигурации**  >  **C/C++**  >  **Командная строка** .

1. В поле **Дополнительные параметры** добавьте *`/kernel`* . Нажмите кнопку **ОК** или **Применить** , чтобы сохранить изменения.

## <a name="see-also"></a>См. также раздел

[Параметры компилятора КОМПИЛЯТОРОМ MSVC](compiler-options.md)\
[Синтаксис командной строки компилятора КОМПИЛЯТОРОМ MSVC](compiler-command-line-syntax.md)
