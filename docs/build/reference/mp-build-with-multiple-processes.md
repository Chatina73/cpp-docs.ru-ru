---
description: Дополнительные сведения:/MP (сборка с несколькими процессами)
title: /MP (Построить с несколькими процессами)
ms.date: 04/08/2019
f1_keywords:
- VC.Project.VCCLCompilerTool.MultiProcessorCompilation
helpviewer_keywords:
- -MP compiler option (C++)
- /MP compiler option (C++)
- MP compiler option (C++)
- cl.exe compiler, multi-process build
ms.openlocfilehash: d5d4441be505dfc1251b099aa95a6ce1544289ad
ms.sourcegitcommit: d6af41e42699628c3e2e6063ec7b03931a49a098
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/11/2020
ms.locfileid: "97137791"
---
# <a name="mp-build-with-multiple-processes"></a>/MP (Построить с несколькими процессами)

Параметр **/MP** позволяет сократить общее время на компиляцию исходных файлов в командной строке. **/MP** предписывает компилятору создавать одну или несколько собственных копий, каждую в отдельном процессе. Затем эти копии одновременно компилируют исходные файлы. Следовательно, общее время на создание исходных файлов значительно сокращается.

## <a name="syntax"></a>Синтаксис

> **/MP**[*processMax*]

## <a name="arguments"></a>Аргументы

*processMax*<br/>
Максимальное количество процессов, которые может создать компилятор (необязательно).

Аргумент *processMax* должен находиться в диапазоне от 1 до 65536. В противном случае компилятор выдает предупреждение **D9014**, игнорирует аргумент *processMax* и предполагает, что максимальное число процессов равно 1.

Если опустить аргумент *processMax* , компилятор получает количество [эффективных процессоров](#effective_processors) на компьютере из операционной системы и создает процесс для каждого процессора.

## <a name="remarks"></a>Комментарии

Параметр компилятора **/MP** может значительно сократить время построения при компиляции большого числа файлов. Чтобы улучшить время сборки, компилятор создает до *processMax* копий самого себя, а затем использует эти копии для одновременной компиляции исходных файлов. Параметр **/MP** применим к компиляциям, но не используется для связывания или создания кода во время компоновки. По умолчанию параметр **/MP** отключен.

Улучшение в построении зависит от числа процессоров на компьютере, количества компилируемых файлов и доступности системных ресурсов, таких как емкость ввода-вывода. Поэкспериментируйте с параметром **/MP** , чтобы определить оптимальные настройки для построения конкретного проекта. Советы в разделе [Рекомендации](#guidelines)помогут вам принять правильное решение.

## <a name="incompatible-options-and-language-features"></a>Несовместимые параметры и языковые компоненты

Параметр **/MP** не совместим с некоторыми параметрами компилятора и языковыми компонентами. При использовании несовместимого параметра компилятора с параметром **/MP** компилятор выдает предупреждение **D9030** и игнорирует параметр **/MP** . Если используется несовместимый язык, компилятор выдает ошибку [C2813](../../error-messages/compiler-errors-2/compiler-error-c2813.md) , а затем завершает или возобновляет работу в зависимости от текущего параметра уровня предупреждений компилятора.

> [!NOTE]
> Большинство параметров являются несовместимыми, так как если бы они были разрешены, параллельно выполняющиеся компиляторы одновременно записывали бы свои выходные данные в консоль или в конкретный файл. В результате произошло бы смешивание и искажение выходных данных. В некоторых случаях сочетание параметров может снизить производительность.

В следующей таблице перечислены параметры компилятора и языковые компоненты, несовместимые с параметром **/MP** .

|Параметр или языковой компонент|Описание|
|--------------------------------|-----------------|
|Директива препроцессора[#import](../../preprocessor/hash-import-directive-cpp.md)|Преобразует типы библиотеки типов в классы C++, а затем записывает эти классы в файл заголовка.|
|[/E](e-preprocess-to-stdout.md), [/EP](ep-preprocess-to-stdout-without-hash-line-directives.md)|Копирует выходные данные препроцессора в стандартный поток вывода (**stdout**).|
|[/GM](gm-enable-minimal-rebuild.md)|Не рекомендуется. Включает инкрементную перестройку.|
|[/showIncludes](showincludes-list-include-files.md)|Записывает список включаемых файлов в стандартную ошибку (**stderr**).|
|[/Yc](yc-create-precompiled-header-file.md)|Создает файл предкомпилированного заголовка.|

## <a name="diagnostic-messages"></a>Диагностические сообщения

При указании параметра или языкового компонента, несовместимого с параметром **/MP** , вы получите соответствующее диагностическое сообщение. В следующей таблице перечислены возможные сообщения и поведение компилятора:

|Диагностическое сообщение|Описание|Поведение компилятора|
|------------------------|-----------------|-----------------------|
|**C2813**|Директива **#import** не совместима с параметром **/MP** .|Компиляция заканчивается, если для параметра [Порог предупреждений компилятора](compiler-option-warning-level.md) не указано иное.|
|**D9014**|Для аргумента *processMax* указано недопустимое значение.|Компилятор игнорирует недопустимое значение и принимает значение равным 1.|
|**D9030**|Указанный параметр не совместим с **/MP**.|Компилятор игнорирует параметр **/MP** .|

## <a name="guidelines"></a><a name="guidelines"></a> Рекомендации

### <a name="measure-performance"></a>Измерение производительности

Для измерения производительности используется общее время построения. Его можно измерить с помощью обычных часов или программного обеспечения, которое вычисляет разницу между началом и завершением построения. Если компьютер оснащен несколькими процессорами, физические часы могут дать более точные результаты, чем измерение времени с помощью программного обеспечения.

### <a name="effective-processors"></a><a name="effective_processors"></a> Effective Processors

Компьютер может иметь один или несколько виртуальных процессоров, которые также называются *эффективными процессорами* для каждого из его физических процессоров. Каждый физический процессор может состоять из одного или нескольких ядер, а при использовании технологии Hyper-Threading каждое ядро определяется операционной системой как два отдельных виртуальных процессора.

Например, компьютер имеет один эффективный процессор, если он оснащен одним физическим процессором с одним ядром и отключенной технологией Hyper-Threading. Другой вариант: компьютер имеет восемь эффективных процессоров, если он оснащен двумя физическими процессорами, каждый из которых имеет два ядра, и для всех ядер включена технология Hyper-Threading. То есть (8 эффективных процессоров) = (2 физических процессора) x (2 ядра на физический процессор) x (2 эффективных процессора на ядро в зависимости от технологии Hyper-Threading).

Если опустить аргумент *processMax* в параметре **/MP** , компилятор получает количество эффективных процессоров от операционной системы, а затем создает один процесс для каждого эффективного процессора. Тем не менее, компилятор не может гарантировать, что отдельно взятый процесс будет выполняться на конкретном процессоре; это решение принимает операционная система.

### <a name="number-of-processes"></a>Число процессов

Компилятор вычисляет число процессов, которые будут использоваться для компиляции исходных файлов. При этом выбирается меньшее значение из количества исходных файлов, указанных в командной строке, и числа процессов, явно или неявно указанных в параметре **/MP** . Можно явно задать максимальное количество процессов, если указать аргумент *processMax* параметра **/MP** . Или можно использовать значение по умолчанию, равное количеству эффективных процессоров на компьютере, если опустить аргумент *processMax* .

Например, можно ввести следующее в командной строке:

`cl /MP7 a.cpp b.cpp c.cpp d.cpp e.cpp`

В этом случае компилятор использует пять процессов, поскольку это меньшее значение из числа исходных файлов (пять) и максимального количества процессов (семь). Теперь предположим, что компьютер имеет два эффективных процессора и вы ввели следующую команду в командной строке:

`cl /MP a.cpp b.cpp c.cpp`

В этом случае операционная система сообщает о двух процессорах, поэтому компилятор использует два процесса в своих вычислениях. В результате компилятор произведет построение с использованием двух процессов, поскольку это меньшее число из двух процессов и трех исходных файлов.

### <a name="source-files-and-build-order"></a>Исходные файлы и порядок построения

Исходные файлы могут компилироваться не в том порядке, в котором они появляются в командной строке. Хотя компилятор создает набор процессов, содержащий копии компилятора, операционная система все равно планирует время выполнения каждого процесса. Следовательно, вы не можете гарантировать, что исходные файлы будут компилироваться в определенном порядке.

Исходный файл компилируется, когда доступен процесс для его компиляции. Если число файлов превышает число процессов, первый набор файлов компилируется свободными процессами. Оставшиеся файлы обрабатываются тогда, когда процесс завершает обработку предыдущих файлов и доступен для работы на одном из остальных файлов.

Не указывайте один и тот же исходный файл в командной строке несколько раз. Это может произойти, например, если инструмент автоматически создает файл [makefile](contents-of-a-makefile.md) , основанный на данных о зависимостях в проекте. Если параметр **/MP** не указан, компилятор последовательно обрабатывает список файлов и повторно компилирует каждое вхождение файла. Тем не менее, если указать параметр **/MP** , разные компиляторы могут одновременно скомпилировать один и тот же файл. Таким образом, разные компиляторы попытаются одновременно выполнить запись в один и тот же выходной файл. Один из компиляторов получит монопольный доступ на запись в выходной файл и успешно выполнит ее, а работа остальных компиляторов завершится из-за ошибки доступа к файлу.

### <a name="using-type-libraries-import"></a>Использование библиотек типов (#import)

Компилятор не поддерживает использование директивы [#import](../../preprocessor/hash-import-directive-cpp.md) с параметром **/MP** . Если возможно, выполните следующие действия, чтобы устранить проблему.

- Переместите все директивы `#import` из различных исходных файлов в один или несколько файлов, затем скомпилируйте эти файлы без параметра **/MP** . Результатом является набор файлов заголовка.

- В оставшихся исходных файлах вставьте директивы [#include](../../preprocessor/hash-include-directive-c-cpp.md) , определяющие созданные заголовки, и скомпилируйте эти исходные файлы с помощью параметра **/MP** .

### <a name="visual-studio-project-settings"></a>Параметры проекта Visual Studio

#### <a name="the-msbuildexe-tool"></a>Инструмент MSBUILD.exe

Visual Studio использует средство [MSBuild.exe](/visualstudio/msbuild/msbuild-reference) для создания решений и проектов. Параметр командной строки **/maxcpucount:**_Number_ (или **/m:**_Number_) средства MSBuild.exe может одновременно создавать несколько проектов. С помощью параметра компилятора **/MP** можно одновременно построить несколько блоков компиляции. Если это требуется для вашего приложения, сократите время построения решения с помощью одного или обоих параметров **/MP** и **/maxcpucount**.

Время построения решения отчасти зависит от числа процессов, выполняющих построение. Аргумент *Number* параметра [/maxcpucount](/visualstudio/msbuild/msbuild-command-line-reference) MSBuild указывает максимальное число проектов, которые должны быть построены одновременно. Аналогичным образом, аргумент *processMax* параметра компилятора **/MP** указывает максимальное количество единиц компиляции, которые должны быть построены одновременно. Если параметр **/maxcpucount** указывает *P* Projects, а параметр **/MP** задает процессы *C* , то максимальное количество процессов *P* x *C* будет выполняться одновременно.

Ниже приведены рекомендации по принятии решения об использовании технологии MSBuild или **/MP** .

- Если в каждом проекте имеется много проектов с несколькими файлами, используйте средство MSBuild.

- При наличии нескольких проектов, каждый из которых содержит большое количество файлов, используйте параметр **/MP** .

- Если количество проектов и файлов для каждого проекта сбалансировано, используйте и MSBuild, и **/MP**. Изначально параметр **/maxcpucount** задается равным числу проектов для построения, а параметр **/MP** — числу процессоров на компьютере. Измерьте производительность и произведите настройку, чтобы добиться наилучших результатов. Повторите цикл, пока не будет достигнуто оптимальное общее время построения.

## <a name="see-also"></a>См. также раздел

[Директива #import](../../preprocessor/hash-import-directive-cpp.md)<br/>
[Справочник по командной строке](/visualstudio/msbuild/msbuild-command-line-reference)<br/>
[/Zf (ускоренное создание PDB-файла)](zf.md)<br/>
