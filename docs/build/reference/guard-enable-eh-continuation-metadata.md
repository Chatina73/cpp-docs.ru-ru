---
title: '/Guard: ехконт (включить метаданные продолжения EH)'
description: 'Справочное руководство по параметру компилятора Microsoft C++/Guard: ехконт.'
ms.date: 06/03/2020
f1_keywords:
- /guard:ehcont
- VC.Project.VCCLCompilerTool.GuardEHContMetadata
helpviewer_keywords:
- /guard:ehcont
- /guard:ehcont compiler option
ms.openlocfilehash: e8775b331440e932efb16148ee15acf1c740cd6e
ms.sourcegitcommit: 7e011c68ca7547469544fac87001a33a37e1792e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/04/2020
ms.locfileid: "84421362"
---
# <a name="guardehcont-enable-eh-continuation-metadata"></a>/Guard: ехконт (включить метаданные продолжения EH)

Включает создание метаданных продолжения EH (ЕХКОНТ) компилятором.

## <a name="syntax"></a>Синтаксис

> **`/guard:ehcont`**[**`-`**]

## <a name="remarks"></a>Комментарии

**`/guard:ehcont`** Параметр предписывает компилятору создавать отсортированный список относительных виртуальных адресов (RVA) всех допустимых целевых объектов продолжения обработки исключений для двоичного файла. Он используется во время выполнения для `NtContinue` `SetThreadContext` проверки указателя инструкций. По умолчанию параметр отключен **`/guard:ehcont`** и должен быть явно включен. Чтобы явно отключить этот параметр, используйте **`/guard:ehcont-`** .

Этот **`/guard:ehcont`** параметр доступен в Visual Studio 2019 версии 16,7 и более поздних версиях. Эта функция поддерживается для 64-разрядных процессов в 64-разрядной ОС.

[Технология управления потоком (центральноевропейское время)](https://software.intel.com/sites/default/files/managed/4d/2a/control-flow-enforcement-technology-preview.pdf) — это функция безопасности на основе оборудования, которая защищает от атак на основе технологии, основанных на программировании (верхнем). Он поддерживает "теневой стек" для каждого стека вызовов, чтобы обеспечить целостность потока управления.

Если доступны теневые стеки для предотвращения атак верхнем, злоумышленники переходят на использование других методов эксплойтов. Одним из способов, которым они могут воспользоваться, является повреждение значения указателя инструкции в структуре [контекста](/windows/win32/api/winnt/ns-winnt-context) . Эта структура передается в системные вызовы, которые перенаправляют выполнение потока, например `NtContinue` , [`RtlRestoreContext`](/windows/win32/api/winnt/nf-winnt-rtlrestorecontext) и [`SetThreadContext`](/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadcontext) . `CONTEXT`Структура хранится в памяти. Повреждение указателя инструкций, который он содержит, может привести к тому, что системные вызовы передают выполнение в адрес, контролируемый злоумышленником. В настоящее время `NTContinue` может вызываться с любой точкой продолжения. Поэтому важно проверить указатель инструкции, когда включены теневые стеки.

`RtlRestoreContext`и `NtContinue` используются во время очистки исключений обработки структурированных исключений (SEH) для освобождения целевого фрейма, содержащего `__except` блок. Указатель инструкции `__except` блока не должен находиться в теневом стеке, так как он не может пройти проверку указателя на инструкцию. **`/guard:ehcont`** Параметр компилятора создает таблицу продолжения EH. Он содержит отсортированный список RVA всех допустимых целевых объектов продолжения обработки исключений в двоичном файле. `NtContinue`сначала проверяет теневой стек для определяемого пользователем указателя инструкций, и если указатель инструкции не найден, он продолжает проверять таблицу продолжения EH из двоичного файла, содержащего указатель инструкции. Если содержащий двоичный код, который не был скомпилирован с таблицей, может продолжаться для совместимости с устаревшими двоичными файлами `NtContinue` . Важно различать устаревшие двоичные файлы, не имеющие ЕХКОНТ данных, и двоичные файлы, содержащие данные ЕХКОНТ, но не имеющие записей в таблице. Первый разрешает все адреса в двоичном файле как допустимые целевые объекты продолжения. В последнем случае не разрешается использовать адрес в двоичном файле как допустимый целевой объект продолжения.

**`/guard:ehcont`** Параметр должен быть передан как компилятору, так и компоновщику для создания целевого RVA продолжения EH для двоичного файла. Если двоичный файл создается с помощью одиночной команды `cl` , компилятор передает параметр в компоновщик. Компилятор также передает [**`/guard:cf`**](guard-enable-control-flow-guard.md) параметр компоновщику. Если компиляция и компоновка выполняется отдельно, эти параметры должны быть установлены как для компилятора, так и для команд компоновщика.

Можно связать код, скомпилированный с помощью, **`/guard:ehcont`** к библиотекам и объектным файлам, скомпилированным без него. Компоновщик возвращает неустранимую ошибку в любом из следующих сценариев:

- Раздел кода имеет «локальную очистку». Дополнительные сведения см. в разделе аварийное завершение в [операторе try-finally](../../cpp/try-finally-statement.md#abnormal-termination).

- Раздел EH (XData) содержит указатели на раздел кода и не для SEH.

- Указатели предназначены для SEH, но объектный файл не был скомпилирован с помощью компоновки на уровне функций ([/Gy](gy-enable-function-level-linking.md)) для создания COMDAT.

Компоновщик возвращает неустранимую ошибку, так как не может создавать метаданные в этих сценариях. Это означает, что создание исключения, скорее всего, приведет к сбою во время выполнения.

Для сведений о разделе SEH, обнаруженных в COMDAT, но не скомпилированных с помощью **`/guard:ehcont`** , компоновщик выдает предупреждение **LNK4291**. В этом случае компоновщик создает правильную, но консервативную метаданные для раздела. Чтобы проигнорировать это предупреждение, используйте [/Ignore (не учитывать конкретные предупреждения)](ignore-ignore-specific-warnings.md).

Если компоновщику не удается создать метаданные, выдается одна из следующих ошибок:

- **`LNK2046`**`: module contains _local_unwind but was not compiled with /guard:ehcont`

- **`LNK2047`**`: module contains C++ EH or complex EH metadata but was not compiled with /guard:ehcont.`

Чтобы проверить, содержит ли двоичный файл данные ЕХКОНТ, при дампе конфигурации загрузки двоичного файла найдите следующие элементы:

```cmd
e:\>link /dump /loadconfig CETTest.exe
...
            10417500 Guard Flags
...
                       EH Continuation table present      // EHCONT guard flag present
...
    0000000180018640 Guard EH continuation table
                  37 Guard EH continuation count          // May be 0 if no exception handling is used in the binary. Still counts has having EHCONT data.
...
    Guard EH Continuation Table                           // List of RVAs

          Address
          --------
           0000000180002CF5
           0000000180002F03
           0000000180002F0A
...
```

### <a name="to-set-this-compiler-option-in-the-visual-studio-development-environment"></a>Установка данного параметра компилятора в среде разработки Visual Studio

1. Откройте диалоговое окно **Страницы свойств** проекта. Подробнее см. в статье [Настройка компилятора C++ и свойства сборки в Visual Studio](../working-with-project-properties.md).

1. Выберите страницу свойств **Свойства "**  >  Создание кода**C/C++**"  >  **Code Generation** .

1. Выберите свойство **Включить метаданные продолжения EH** .

1. В элементе управления "раскрывающийся список **" выберите Да (/Guard: ехконт)** , чтобы включить метаданные продолжения EH, или **нет (/Guard: ехконт-)** , чтобы отключить его.

## <a name="see-also"></a>См. также раздел

[/Guard (Включение защиты потока управления)](guard-enable-control-flow-guard.md)\
[Параметры компилятора КОМПИЛЯТОРОМ MSVC](compiler-options.md)\
[Синтаксис командной строки компилятора КОМПИЛЯТОРОМ MSVC](compiler-command-line-syntax.md)
