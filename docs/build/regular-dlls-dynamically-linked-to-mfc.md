---
title: Регулярные MFC DLL, динамически компонуемые с MFC
ms.date: 11/04/2016
helpviewer_keywords:
- regular MFC DLLs [C++], dynamically linked to MFC
- AFX_MANAGE_STATE macro
- DLLs [C++], regular
- shared DLL versions [C++]
- dynamically linked DLLs [C++]
ms.assetid: b4f7ab92-8723-42a5-890e-214f4e29dcd0
ms.openlocfilehash: 3bfed5f75dab4c501708950fdb99f53c40ec142c
ms.sourcegitcommit: 0ab61bc3d2b6cfbd52a16c6ab2b97a8ea1864f12
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62315005"
---
# <a name="regular-mfc-dlls-dynamically-linked-to-mfc"></a>Регулярные MFC DLL, динамически компонуемые с MFC

Обычный, библиотеки DLL MFC, динамически компонуемые с MFC представляет собой библиотеку DLL, который внутренне использует MFC, а экспортированные функции в библиотеке DLL могут быть вызваны исполняемые файлы MFC или не являющихся MFC. Как описывается в его имени, такого рода DLL создается с помощью версии библиотеки MFC (также называется общей версии MFC). Обычно функции экспортируются из библиотеки DLL MFC, с использованием стандартного интерфейса C обычного.

Необходимо добавить `AFX_MANAGE_STATE` макрос в начале все экспортированные функции в обычных библиотеках DLL MFC, который динамически связан с MFC, чтобы задать текущее состояние модуля одну библиотеку DLL. Это делается, добавив следующую строку кода в начале функции, экспортированные из библиотеки DLL:

```
AFX_MANAGE_STATE(AfxGetStaticModuleState( ))
```

Обычной MFC DLL, динамически компонуемые с MFC обладает следующими функциями:

- Это новый тип библиотеки DLL, представленное в Visual C++ 4.0.

- Исполняемый файл клиента могут быть написаны на любом языке, поддерживающем использование библиотек DLL (C, C++, Pascal, Visual Basic и т. д.); его не нужно быть в приложении MFC.

- В отличие от статически скомпонованной регулярных DLL MFC этот тип из библиотеки DLL, динамически компонуемые с MFC DLL (также называется общей библиотеки DLL MFC).

- Библиотека импорта MFC, связать с этим типом DLL — совпадает с используемым для библиотеки DLL расширения MFC или приложений с использованием библиотеки DLL MFC: .Lib MFCxx (D).

Обычной MFC DLL, динамически компонуемые с MFC предъявляются следующие требования:

- Эти библиотеки DLL компилируются с **_AFXDLL** определен, так же, как исполняемый файл, динамически компонуемые с MFC библиотеки DLL. Но **макрос _USRDLL** также определяется, как и в обычной MFC DLL, статически компонуемые с MFC.

- Необходимо создать экземпляр этого типа библиотеки DLL `CWinApp`-производного класса.

- Этот тип DLL использует `DllMain` предоставляемая MFC. Поместите все DLL-специфичная код инициализации `InitInstance` члена функции и завершение кода в `ExitInstance` как обычного приложения MFC.

Так как такого рода DLL использует версию библиотеки MFC, необходимо явно задать текущее состояние модуля одну библиотеку DLL. Чтобы сделать это, используйте [AFX_MANAGE_STATE](../mfc/reference/extension-dll-macros.md#afx_manage_state) макрос в начале каждой функции, экспортированные из библиотеки DLL.

Обычные библиотеки DLL MFC должен иметь `CWinApp`-производный класс и один объект этого класса, как в приложении MFC. Тем не менее `CWinApp` объект библиотеки DLL не имеет цикла обработки сообщений, как `CWinApp` приложения.

Обратите внимание, что `CWinApp::Run` механизм не применяется к библиотеке DLL, так как приложение, которому принадлежит основной конвейер сообщений. Если библиотеки DLL вызывает немодальное диалоговое окно или фрейм окна свои собственные, приложения цикла обработки сообщений необходимо вызвать подпрограмму массового экспорта библиотеки DLL, которая вызывает `CWinApp::PreTranslateMessage`.

Поместите все инициализации библиотеки DLL в `CWinApp::InitInstance` функция-член как обычного приложения MFC. `CWinApp::ExitInstance` Функцию-член вашей `CWinApp` производном классе вызывается из предоставляемой MFC `DllMain` функцию перед выгрузкой библиотеки DLL.

Необходимо распространить общих DLL-файлов MFCx0.dll и Msvcr*0.dll (или подобных файлов) с приложением.

Библиотека DLL, динамически компонуемые с MFC не может одновременно статически с MFC. Приложения связываются с обычные библиотеки DLL MFC динамически компонуемые с MFC его так же, как и любой другой DLL.

Символы обычно экспортируются из библиотеки DLL MFC, с использованием стандартного интерфейса C обычного. Объявление функции, экспортированные из обычной библиотеки DLL MFC выглядит примерно следующим образом:

```
extern "C" __declspec(dllexport) MyExportedFunction( );
```

Всех операций выделения памяти в обычной библиотеки DLL MFC должны оставаться в пределах DLL. библиотеки DLL не следует передавать или получать из вызывающего исполняемого файла из следующих:

- Указатели на объекты MFC

- Указатели на память, выделенную с MFC

Если вам нужно выполнять какие-либо из перечисленных выше, или необходимо передать объекты, производные от вызывающего исполняемого файла и библиотеки DLL, необходимо построить библиотеки DLL расширения MFC.

Можно безопасно передавать указатели памяти, выделенной с помощью библиотек времени выполнения C между приложением и библиотеки DLL только в том случае, если следует создать копию данных. Не должен удалить или изменить эти указатели или их использовать без создания копии памяти.

При создании обычной библиотеки DLL MFC, динамически скомпонованную с MFC, необходимо использовать макрос [AFX_MANAGE_STATE](../mfc/reference/extension-dll-macros.md#afx_manage_state) для переключения состояния модуля MFC правильно. Это делается, добавив следующую строку кода в начале функции, экспортированные из библиотеки DLL:

```
AFX_MANAGE_STATE(AfxGetStaticModuleState( ))
```

**AFX_MANAGE_STATE** макрос не следует в обычных библиотеках DLL MFC, статической компоновке с MFC, или в библиотеках DLL расширений MFC. Дополнительные сведения см. в разделе [управление данными о состояния модулей MFC](../mfc/managing-the-state-data-of-mfc-modules.md).

Пример для написания, сборки и использовать обычную библиотеку DLL MFC, см. в образце [DLLScreenCap](https://github.com/Microsoft/VCSamples/tree/master/VC2010Samples/MFC/advanced/DllScreenCap). Дополнительные сведения о регулярных DLL MFC, динамически связываются с MFC см. в разделе «Преобразование DLLScreenCap для динамически ссылку с MFC DLL» в абстрактный пример.

## <a name="what-do-you-want-to-do"></a>Выберите действие

- [Инициализация обычных библиотек DLL MFC](run-time-library-behavior.md#initializing-regular-dlls)

## <a name="what-do-you-want-to-know-more-about"></a>Дополнительные сведения

- [Состояния модулей обычной библиотеки DLL MFC, динамически компонуемые с MFC](module-states-of-a-regular-dll-dynamically-linked-to-mfc.md)

- [Управление данными состояния модулей MFC](../mfc/managing-the-state-data-of-mfc-modules.md)

- [Использование библиотек DLL расширений MFC для баз данных, OLE и сокетов в обычных DLL-библиотеках MFC](using-database-ole-and-sockets-extension-dlls-in-regular-dlls.md)

- [Использование MFC как часть библиотеки DLL](../mfc/tn011-using-mfc-as-part-of-a-dll.md)

## <a name="see-also"></a>См. также

[Типы библиотек DLL](kinds-of-dlls.md)
