---
title: Часто задаваемые вопросы о библиотеке DLL MFC
ms.date: 05/06/2019
helpviewer_keywords:
- troubleshooting [C++], DLLs
- DLLs [C++], frequently asked questions
- FAQs [C++], DLLs
ms.assetid: 09dd068e-fc33-414e-82f7-289c70680256
ms.openlocfilehash: 9108aaf3fcface847b0391455a2aecd4d45658c4
ms.sourcegitcommit: 7ecd91d8ce18088a956917cdaf3a3565bd128510
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2020
ms.locfileid: "79422826"
---
# <a name="dll-frequently-asked-questions"></a>Вопросы и ответы по библиотекам DLL

Ниже приведены некоторые часто задаваемые вопросы о библиотеках DLL.

- [Может ли библиотека MFC создавать несколько потоков?](#mfc_multithreaded_1)

- [Может ли многопоточные приложения обращаться к библиотеке DLL MFC в разных потоках?](#mfc_multithreaded_2)

- [Существуют ли классы или функции MFC, которые не могут использоваться в библиотеке DLL MFC?](#mfc_prohibited_classes)

- [Какие методы оптимизации следует использовать для повышения производительности клиентского приложения при загрузке?](#mfc_optimization)

- [В обычной библиотеке DLL MFC возникает утечка памяти, но мой код выглядит нормально. Как можно найти утечку памяти?](#memory_leak)

## <a name="mfc_multithreaded_1"></a>Может ли библиотека MFC создавать несколько потоков?

За исключением инициализации, Библиотека DLL MFC может безопасно создавать несколько потоков, если в ней используются функции локального хранилища (TLS) потока Win32, такие как **TlsAlloc** , для выделения локального хранилища потока. Однако если библиотека DLL MFC использует **__declspec (thread)** для выделения локального хранилища потока, клиентское приложение должно быть неявно СВЯЗАНО с библиотекой DLL. Если клиентское приложение явно ссылается на библиотеку DLL, вызов **LoadLibrary** не ЗАГРУЗИТ библиотеку DLL. Дополнительные сведения о локальных переменных потока в библиотеках DLL см. в разделе [Thread](../cpp/thread.md).

Библиотека DLL MFC, которая создает новый поток MFC во время запуска, перестает отвечать на запросы при загрузке приложением. Это включает в себя каждый раз при создании потока путем вызова `AfxBeginThread` или `CWinThread::CreateThread` внутри:

- `InitInstance` объекта, производного от `CWinApp`, в обычной библиотеке DLL MFC.

- Заданная функция `DllMain` или **равдллмаин** в обычной библиотеке DLL MFC.

- Заданная функция `DllMain` или **равдллмаин** в библиотеке DLL расширения MFC.

## <a name="mfc_multithreaded_2"></a>Может ли многопоточные приложения обращаться к библиотеке DLL MFC в разных потоках?

Многопоточные приложения могут получать доступ к обычным библиотекам DLL MFC, которые динамически связываются с библиотеками DLL расширения MFC и MFC из разных потоков. Приложение может получить доступ к обычным библиотекам DLL MFC, которые статически связываются с MFC из нескольких потоков, созданных в приложении.

## <a name="mfc_prohibited_classes"></a>Существуют ли классы или функции MFC, которые не могут использоваться в библиотеке DLL MFC?

Библиотеки DLL расширения используют класс, производный от `CWinApp`клиентского приложения. Они не должны иметь собственный класс, производный от `CWinApp`.

Обычные библиотеки DLL MFC должны иметь класс, производный от `CWinApp`, и один объект этого класса приложения, как и приложение MFC. В отличие от объекта `CWinApp` приложения, объект `CWinApp` библиотеки DLL не имеет основного конвейера сообщений.

Обратите внимание, что поскольку механизм `CWinApp::Run` не применяется к библиотеке DLL, приложение владеет основным конвейером сообщений. Если библиотека DLL открывает немодальные диалоговые окна или имеет собственное окно фрейма, то основной конвейер сообщений приложения должен вызвать подпрограммы, экспортированные библиотекой DLL, которая, в свою очередь, вызывает функцию-член `CWinApp::PreTranslateMessage` объекта приложения DLL.

## <a name="mfc_optimization"></a>Какие методы оптимизации следует использовать для повышения производительности клиентских приложений&#39;при загрузке?

Если библиотека DLL является обычной библиотекой DLL MFC, которая статически связана с MFC, то изменение ее на обычную библиотеку DLL MFC, которая динамически связана с MFC, сокращает размер файла.

Если в библиотеке DLL содержится большое количество экспортированных функций, используйте DEF-файл для экспорта функций (вместо использования **__declspec (dllexport)** ) и используйте для каждой из экспортируемых функций [атрибут неименованных](exporting-functions-from-a-dll-by-ordinal-rather-than-by-name.md) файлов. def. Атрибут «неименование» приводит к сохранению только порядкового значения, а не имени функции в таблице экспорта библиотеки DLL, что сокращает размер файла.

Библиотеки DLL, которые неявно связаны с приложением, загружаются при загрузке приложения. Чтобы повысить производительность при загрузке, попробуйте разделить библиотеку DLL на разные библиотеки DLL. Помещайте все функции, необходимые вызывающему приложению сразу же после загрузки в одну библиотеку DLL, и вызывающее приложение неявно связывается с этой библиотекой DLL. Помещайте другие функции, которые вызывающее приложение не требуется сразу же в другой библиотеке DLL, и приложение явно связывается с этой библиотекой DLL. Дополнительные сведения см. в разделе [Связывание исполняемого файла с библиотекой DLL](linking-an-executable-to-a-dll.md#determining-which-linking-method-to-use).

## <a name="memory_leak"></a>В&#39;обычной библиотеке DLL MFC возникает утечка памяти, но мой код прекрасно смотрится. Как можно найти утечку памяти?

Одной из возможных причин утечки памяти является то, что MFC создает временные объекты, используемые внутри функций обработчика сообщений. В приложениях MFC эти временные объекты автоматически очищаются в функции `CWinApp::OnIdle()`, которая вызывается в между сообщениями обработки. Однако в библиотеках динамической компоновки MFC функция `OnIdle()` не вызывается автоматически. В результате временные объекты не очищаются автоматически. Чтобы очистить временные объекты, Библиотека DLL должна периодически вызывать `OnIdle(1)`.

## <a name="see-also"></a>См. также раздел

[Создание библиотек DLL C/C++ в Visual Studio](dlls-in-visual-cpp.md)
