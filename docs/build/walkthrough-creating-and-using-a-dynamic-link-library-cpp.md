---
title: Пошаговое руководство. Создание и использование собственной библиотеки динамической компоновки (C++)
description: Сведения о создании библиотеки динамической компоновки Windows (DLL) в Visual Studio с использованием C++.
ms.custom: conceptual
ms.date: 08/19/2019
helpviewer_keywords:
- libraries [C++], DLLs
- DLLs [C++], walkthroughs
ms.assetid: 3ae94848-44e7-4955-bbad-7d40f493e941
ms.openlocfilehash: 9dffec9d7d974ceb3bf1ca4546a303fab47ee0be
ms.sourcegitcommit: 9d4ffb8e6e0d70520a1e1a77805785878d445b8a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2019
ms.locfileid: "69630684"
---
# <a name="walkthrough-create-and-use-your-own-dynamic-link-library-c"></a>Пошаговое руководство. Создание и использование собственной библиотеки динамической компоновки (C++)

В этом пошаговом руководстве показано, как с помощью интегрированной среды разработки (IDE) Visual Studio создать собственную библиотеку динамической компоновки (DLL), написанную на C++, а затем использовать ее из другого приложения C++. Библиотеки DLL (также называемые общими библиотеками в операционных системах на основе UNIX) являются одним из наиболее полезных компонентов Windows. Их можно использовать для обмена кодом и ресурсами, чтобы уменьшить размер своих приложений, а также упростить их обслуживание и расширение. В этом пошаговом руководстве вы создадите библиотеку DLL, которая реализует некоторые математические функции, а затем создадите консольное приложение, использующее функции из этой библиотеки. Попутно вы познакомитесь с некоторыми методами программирования и соглашениями, используемыми в библиотеках DLL для Windows.

В этом пошаговом руководстве рассматриваются следующие задачи:

- Создание проекта библиотеки DLL в Visual Studio.

- Добавление экспортированных функций и переменных в библиотеку DLL.

- Создание проекта "Консольное приложение" в Visual Studio.

- Использование в консольном приложении функций и переменных, импортированных из библиотеки DLL.

- Запуск готового приложения.

Как и статически компонуемая библиотека, библиотека DLL _экспортирует_ переменные, функции и ресурсы по имени, а ваше приложение _импортирует_ эти имена для использования этих объектов. В отличие от статически компонуемой библиотеки, Windows соединяет импорт в вашем приложении с экспортом в библиотеку DLL во время загрузки или выполнения, а не во время компоновки. Для выполнения этих подключений Windows требуются дополнительные сведения, которые не являются частью стандартной модели компиляции C++. Чтобы предоставить эти дополнительные сведения, компилятор MSVC реализует некоторые специальные расширения Майкрософт для C++. Мы рассмотрим эти расширения далее.

В этом пошаговом руководстве создаются два решения Visual Studio. Первое решение создает библиотеку DLL, а второе — клиентское приложение. В библиотеке DLL применяется соглашение о вызовах C, поэтому ее можно вызывать из приложений, созданных с использованием других языков, при условии, что платформа и соглашения о вызовах и компоновке совпадают. Клиентское приложение использует _неявную компоновку_, в рамках которой Windows связывает приложение с библиотекой DLL во время загрузки. Эта компоновка позволяет приложению вызывать функции, предоставляемые библиотекой DLL, точно так же, как функции в библиотеке статической компоновки.

В этом пошаговом руководстве не рассматриваются некоторые общие ситуации. В нем не рассматривается использование библиотеки DLL для C++ другими языками. Здесь также не показано, как создать библиотеку DLL только для ресурсов, а также как использовать явную компоновку для загрузки библиотек DLL во время выполнения, а не во время загрузки. Если вы уверены, вы можете использовать Visual Studio для решения этих задач. Ссылки на дополнительные сведения о DLL см. в статье [Создание библиотек DLL на C/C++ в Visual Studio](dlls-in-visual-cpp.md). Дополнительные сведения о явной и неявной компоновке см. в разделе [Связывание исполняемого файла с библиотекой DLL](linking-an-executable-to-a-dll.md#determining-which-linking-method-to-use). Дополнительные сведения о создании библиотек DLL C++ для использования с языками, в которых применяются соглашения о компоновках языка C, см. в статье [Экспорт функций на языке C++ для использования в исполняемых модулях, исходный код которых написан на языке C](exporting-cpp-functions-for-use-in-c-language-executables.md). Дополнительные сведения о том, как создавать библиотеки DLL для использования с языками .NET, см. в статье [Вызов функций библиотек DLL из приложений Visual Basic](calling-dll-functions-from-visual-basic-applications.md).

## <a name="prerequisites"></a>Предварительные требования

- Компьютер под управлением Microsoft Windows 7 или более поздних версий. Для обеспечения оптимальной среды разработки рекомендуется использовать Windows 10.

- Копия Visual Studio. Сведения о скачивании и установке Visual Studio см. в [этой статье](/visualstudio/install/install-visual-studio). Когда вы запускаете установщик, убедитесь, что установлена рабочая нагрузка **Разработка классических приложений на C++** . Не беспокойтесь, если вы не установили эту рабочую нагрузку при установке Visual Studio. Вы можете снова запустить установщик и установить ее сейчас.

   ![Разработка классических приложений на C++](media/desktop-development-with-cpp.png "Desktop development with C++")

- Базовые значения об использовании интегрированной среды разработки Visual Studio. Если вы уже использовали классические приложения для Windows, вы, вероятно, справитесь. Общие сведения см. в [обзоре возможностей интегрированной среды разработки Visual Studio](/visualstudio/ide/visual-studio-ide).

- Основные навыки владения языком C++. Не волнуйтесь, мы не будем делать ничего сложного.

## <a name="create-the-dll-project"></a>Создание проекта библиотеки DLL

Этот набор задач позволяет создать проект для библиотеки DLL, добавить код и выполнить его сборку. Для начала запустите IDE Visual Studio и выполните вход, если это необходимо. Инструкции немного отличаются в зависимости от используемой версии Visual Studio. Убедитесь, что в элементе управления в верхнем левом углу этой страницы выбрана правильная версия.

::: moniker range="=vs-2019"

### <a name="to-create-a-dll-project-in-visual-studio-2019"></a>Создание проекта библиотеки DLL в Visual Studio 2019

1. В строке меню выберите **Файл** > **Создать** > **Проект**, чтобы открыть диалоговое окно **Создание проекта**.

   ![Создание проекта библиотеки DLL](media/create-new-dll-project-2019.png "Создание проекта MathLibrary")

1. В верхней части диалогового окна для параметра **Язык** установите значение **C++** , для параметра **Платформа** — значение **Windows**, а для параметра **Тип проекта** — значение **Библиотека**. 

1. В отфильтрованном списке типов проектов щелкните **Библиотека динамической компоновки (DLL)** , а затем нажмите кнопку **Далее**. На следующей странице введите `MathLibrary` в поле **Имя**, чтобы указать название проекта, и при необходимости укажите расположение проекта.

1. Нажмите кнопку **Создать**, чтобы создать проект.

::: moniker-end

::: moniker range="vs-2017"

### <a name="to-create-a-dll-project-in-visual-studio-2017"></a>Создание проекта библиотеки DLL в Visual Studio 2017

1. В строке меню выберите **Файл**  > **Создать** > **Проект**, чтобы открыть диалоговое окно **Новый проект**.

1. На левой панели диалогового окна **Новый проект** разверните узел **Установленные** и **Visual C++** , если нужно, а затем выберите **Классическое приложение Windows**. На центральной панели выберите **Мастер классических приложений Windows**. В текстовом поле **Имя** введите `MathLibrary` и укажите имя нового проекта.

   ![Указание имени проекта MathLibrary](media/mathlibrary-new-project-name-153.png "Name the MathLibrary project")

1. Нажмите кнопку **​​ОК**, чтобы закрыть диалоговое окно **Новый проект**, и запустите мастер **Проект классического приложения Windows**.

1. В мастере **Проект классического приложения Windows** в разделе **Тип приложения** щелкните **Библиотека динамической компоновки (DLL)** .

   ![Создание библиотеки DLL в мастере "Проект классического приложения Windows"](media/mathlibrary-desktop-project-wizard-dll.png "Create DLL in Windows Desktop Project Wizard")

1. Нажмите кнопку **ОК**, чтобы создать проект.

> [!NOTE]
> Для устранения проблемы в Visual Studio 2017 версии 15.3 требуются дополнительные действия. Следуйте этим инструкциям, чтобы узнать, нужно ли вам внести это изменение.
>
>1. В **обозревателе решений** выберите проект **MathLibrary** в разделе **решения MathLibrary**, если он еще не выбран.
>
>1. В строке меню щелкните **Проект** > **Свойства**.
>
>1. В левой области диалогового окна **Страницы свойств** щелкните **Препроцессор** в разделе **Свойства конфигурации** > **C/C++** . Проверьте содержимое свойства **Определения препроцессора**.<br/><br/>![Проверка свойства "Определения препроцессора"](media/mathlibrary-153bug-preprocessor-definitions-check.png "Check the Preprocessor Definitions property")<br/><br/>Если в списке **Определения препроцессора** отображается **MATHLIBRARY_EXPORTS**, вам не нужно ничего менять. Если вместо этого вы видите **MATHLIBRARY_EXPORTS**, выполните следующие шаги.
>
>1. В верхней части диалогового окна **Страницы свойств** в раскрывающемся списке **Конфигурация** выберите пункт **Все конфигурации**.
>
>1. На панели свойств щелкните раскрывающийся элемент управления рядом с полем ввода параметра **Определения препроцессора**, а затем щелкните **Правка**.<br/><br/>![Правка свойства "Определения препроцессора"](media/mathlibrary-153bug-preprocessor-definitions-property.png "Edit the Preprocessor Definitions property")
>
>1. В верхней области диалогового окна **Определения препроцессора** добавьте новый символ `MATHLIBRARY_EXPORTS`.<br/><br/>![Добавление символа MATHLIBRARY_EXPORTS](media/mathlibrary-153bug-preprocessor-definitions-dialog.png "Add the MATHLIBRARY_EXPORTS symbol")
>
>1. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно **Определения препроцессора**, а затем нажмите кнопку **ОК**, чтобы сохранить изменения в свойствах проекта.

::: moniker-end

::: moniker range="=vs-2015"

### <a name="to-create-a-dll-project-in-older-versions-of-visual-studio"></a>Создание проекта библиотеки DLL в более ранних версиях Visual Studio

1. В строке меню выберите **Файл** > **Создать** > **Проект**.

1. В левой области диалогового окна **Новый проект** разверните узлы **Установленные** > **Шаблоны** и выберите **Visual C++** , а затем в центральной области щелкните **Консольное приложение Win32**. В текстовом поле **Имя** введите `MathLibrary`, чтобы указать имя нового проекта.

   ![Указание имени проекта MathLibrary](media/mathlibrary-project-name.png "Name the MathLibrary project")

1. Нажмите кнопку **​​ОК**, чтобы закрыть диалоговое окно **Новый проект**, и запустите **мастер приложений Win32**.

   ![Обзор мастера приложений Win32](media/mathlibrary-project-wizard-1.png "Win32 Application Wizard Overview")

1. Нажмите кнопку **Далее**. На странице **Параметры приложения** в поле **Тип приложения** выберите пункт **DLL**.

   ![Создание библиотеки DLL в мастере приложений Win32](media/mathlibrary-project-wizard-2.png "Create DLL in Win32 Application Wizard")

1. Нажмите кнопку **Готово** , чтобы создать проект.

Когда мастер завершит создание решения, вы сможете увидеть созданный проект вместе с исходными файлами в окне **обозревателя решений** в Visual Studio.

![Созданное решение в Visual Studio](media/mathlibrary-solution-explorer-153.png "Generated solution in Visual Studio")

Пока эта библиотека DLL ничего не делает. Затем вы создадите файл заголовка для объявления функций, экспортируемых вашей библиотекой DLL, а затем добавите определения функций в библиотеку DLL, чтобы сделать ее более полезной.

::: moniker-end

### <a name="to-add-a-header-file-to-the-dll"></a>Добавление файла заголовка в библиотеку DLL

1. Чтобы создать файл заголовка для функций, последовательно щелкните **Проект** > **Добавить новый элемент**.

1. В диалоговом окне **Добавление нового элемента** в левой области щелкните **Visual C++** . В центральной области выберите **Заголовочный файл (.h)** . Укажите `MathLibrary.h` в качестве имени для файла заголовка.

   ![Добавление файла заголовка в диалоговом окне "Добавление нового элемента"](media/mathlibrary-add-new-item-header-file.png "Add header file in Add New Item dialog")

1. Нажмите кнопку **​​Добавить**, чтобы создать пустой файл заголовка, который отображается в новом окне редактора.

   ![Пустой файл MathLibrary.h в редакторе](media/edit-empty-mathlibrary-header.png "Empty MathLibrary.h file in editor")

1. Замените все содержимое этого файла заголовка следующим кодом:

   ```cpp
   // MathLibrary.h - Contains declarations of math functions
   #pragma once

   #ifdef MATHLIBRARY_EXPORTS
   #define MATHLIBRARY_API __declspec(dllexport)
   #else
   #define MATHLIBRARY_API __declspec(dllimport)
   #endif

   // The Fibonacci recurrence relation describes a sequence F
   // where F(n) is { n = 0, a
   //               { n = 1, b
   //               { n > 1, F(n-2) + F(n-1)
   // for some initial integral values a and b.
   // If the sequence is initialized F(0) = 1, F(1) = 1,
   // then this relation produces the well-known Fibonacci
   // sequence: 1, 1, 2, 3, 5, 8, 13, 21, 34, ...

   // Initialize a Fibonacci relation sequence
   // such that F(0) = a, F(1) = b.
   // This function must be called before any other function.
   extern "C" MATHLIBRARY_API void fibonacci_init(
       const unsigned long long a, const unsigned long long b);

   // Produce the next value in the sequence.
   // Returns true on success and updates current value and index;
   // false on overflow, leaves current value and index unchanged.
   extern "C" MATHLIBRARY_API bool fibonacci_next();

   // Get the current value in the sequence.
   extern "C" MATHLIBRARY_API unsigned long long fibonacci_current();

   // Get the position of the current value in the sequence.
   extern "C" MATHLIBRARY_API unsigned fibonacci_index();
   ```

Этот файл заголовка объявляет некоторые функции для создания обобщенной последовательности Фибоначчи, исходя из двух начальных значений. Вызов `fibonacci_init(1, 1)` создает знакомую последовательность чисел Фибоначчи.

Обратите внимание на операторы препроцессора в верхней части файла. По умолчанию шаблон нового проекта для библиотеки DLL добавляет **\<em>PROJECTNAME\</em>_EXPORTS** к определенным макросам препроцессора для проекта библиотеки DLL. В этом примере Visual Studio определяет **MATHLIBRARY_EXPORTS** при сборке проекта библиотеки DLL MathLibrary. 

::: moniker range="=vs-2017"

(Мастер в Visual Studio 2017 версии 15.3 не переводит это определение символа в верхний регистр. Если вы назовете свой проект MathLibrary, то определенным символом будет MathLibrary_EXPORTS вместо MATHLIBRARY_EXPORTS. Вот почему выше приведены дополнительные шаги, позволяющие добавить этот символ.)

::: moniker-end

Когда макрос **MATHLIBRARY_EXPORTS** определен, макрос **MATHLIBRARY_API** устанавливает модификатор `__declspec(dllexport)` в объявлениях функций. Этот модификатор предписывает компилятору и компоновщику экспортировать функцию или переменную из библиотеки DLL, чтобы ее могли использовать другие приложения. Если **MATHLIBRARY_EXPORTS** не определен, например, когда файл заголовка включен клиентским приложением, **MATHLIBRARY_API** применяет модификатор `__declspec(dllimport)` к объявлениям. Этот модификатор оптимизирует импорт функции или переменной в приложении. Дополнительные сведения см. в статье [dllexport, dllimport](../cpp/dllexport-dllimport.md).

### <a name="to-add-an-implementation-to-the-dll"></a>Добавление реализации в библиотеку DLL

::: moniker range="vs-2019"

1. В **обозревателе решений** щелкните правой кнопкой мыши узел **Исходные файлы** и добавьте новый CPP-файл с именем `MathLibrary.cpp` так же, как вы добавили новый файл заголовка на предыдущем шаге.

::: moniker-end

1. В окне редактора выберите вкладку **MathLibrary.cpp**, если она уже открыта. Если нет, то в **обозревателе решений** откройте файл **MathLibrary.cpp** в папке **Исходные файлы** проекта **MathLibrary**.

1. В редакторе замените содержимое файла MathLibrary.cpp следующим кодом:

   ```cpp
   // MathLibrary.cpp : Defines the exported functions for the DLL.
   #include "pch.h" // use stdafx.h in Visual Studio 2017 and earlier
   #include <utility>
   #include <limits.h>
   #include "MathLibrary.h"

   // DLL internal state variables:
   static unsigned long long previous_;  // Previous value, if any
   static unsigned long long current_;   // Current sequence value
   static unsigned index_;               // Current seq. position

   // Initialize a Fibonacci relation sequence
   // such that F(0) = a, F(1) = b.
   // This function must be called before any other function.
   void fibonacci_init(
       const unsigned long long a,
       const unsigned long long b)
   {
       index_ = 0;
       current_ = a;
       previous_ = b; // see special case when initialized
   }

   // Produce the next value in the sequence.
   // Returns true on success, false on overflow.
   bool fibonacci_next()
   {
       // check to see if we'd overflow result or position
       if ((ULLONG_MAX - previous_ < current_) ||
           (UINT_MAX == index_))
       {
           return false;
       }

       // Special case when index == 0, just return b value
       if (index_ > 0)
       {
           // otherwise, calculate next sequence value
           previous_ += current_;
       }
       std::swap(current_, previous_);
       ++index_;
       return true;
   }

   // Get the current value in the sequence.
   unsigned long long fibonacci_current()
   {
       return current_;
   }

   // Get the current index position in the sequence.
   unsigned fibonacci_index()
   {
       return index_;
   }
   ```

Чтобы убедиться, что все работает, скомпилируйте библиотеку динамической компоновки. Чтобы выполнить компиляцию, последовательно выберите **Сборка** > **Собрать решение**. Результат должен выглядеть примерно так. Обратите внимание, что исполняемый файл DLL и связанные с ним выходные данные компилятора помещаются в папку, которая называется Отладка непосредственно под папкой решения. При создании сборки выпуска выходные данные будут помещены в папку с именем *Release*:

```Output
1>------ Build started: Project: MathLibrary, Configuration: Debug Win32 ------
1>MathLibrary.cpp
1>dllmain.cpp
1>Generating Code...
1>   Creating library C:\Users\username\Source\Repos\MathLibrary\Debug\MathLibrary.lib and object C:\Users\username\Source\Repos\MathLibrary\Debug\MathLibrary.exp
1>MathLibrary.vcxproj -> C:\Users\username\Source\Repos\MathLibrary\Debug\MathLibrary.dll
1>MathLibrary.vcxproj -> C:\Users\username\Source\Repos\MathLibrary\Debug\MathLibrary.pdb (Partial PDB)
========== Build: 1 succeeded, 0 failed, 0 up-to-date, 0 skipped ==========
```

Поздравляем, вы создали библиотеку DLL с помощью Visual Studio! Далее вы создадите клиентское приложение, которое использует функции, экспортируемые из библиотеки DLL.

## <a name="create-a-client-app-that-uses-the-dll"></a>Создание клиентского приложения, которое использует библиотеку DLL

Когда вы создаете библиотеку DLL, вы должны подумать о том, как ее использовать. Чтобы скомпилировать код, который вызывает функции, экспортируемые библиотекой DLL, объявления должны быть включены в исходный код клиента. Во время компоновки, когда эти вызовы функций библиотеки DLL разрешены, у компоновщика должна быть *библиотека импорта*, специальный файл библиотеки, содержащий информацию для Windows о том, как найти функции, а не фактический код. Во время выполнения библиотека DLL должна быть доступна клиенту в месте, которое может найти операционная система.

Чтобы использовать библиотеку DLL, будь то собственная или сторонняя библиотека, ваш проект клиентского приложения должен найти заголовки, которые объявляют экспорт DLL, библиотеки импорта для компоновщика и саму библиотеку DLL. Одним из способов является копирование всех этих файлов в ваш клиентский проект. Для сторонних библиотек DLL, которые вряд ли изменятся во время разработки вашего клиента, этот метод может быть лучшим способом их использования. Однако, когда вы также создаете библиотеку DLL, лучше избегать дублирования. Если вы делаете копию файлов библиотеки DLL, которые находятся в стадии разработки, вы можете случайно изменить файл заголовка только в одной копии или использовать устаревшую библиотеку. Чтобы избежать этой проблемы, мы рекомендуем вам установить путь включения в своем клиентском проекте, чтобы добавить файлы заголовков библиотеки DLL из проекта DLL. Кроме того, укажите путь к библиотеке в своем клиентском проекте, чтобы добавить библиотеки импорта DLL из проекта DLL. Наконец, скопируйте встроенную библиотеку DLL из проекта DLL в выходной каталог своей сборки. Этот шаг позволяет вашему клиентскому приложению использовать тот же код библиотеки DLL, который вы создали.

::: moniker range="vs-2019"

### <a name="to-create-a-client-app-in-visual-studio-2019"></a>Создание клиентского приложения в Visual Studio 2019

1. В строке меню выберите **Файл** > **Создать** > **Проект**, чтобы открыть диалоговое окно **Создание проекта**.

1. В верхней части диалогового окна для параметра **Язык** выберите значение **C++** , для параметра **Платформа** — значение **Windows**, а для параметра **Тип проекта** — значение **Консоль**. 

1. В отфильтрованном списке типов проектов щелкните **Консольное приложение**, а затем нажмите кнопку **Далее**. На следующей странице введите `MathClient` в поле **Имя**, чтобы указать название проекта, и при необходимости укажите расположение проекта.

   ![Именование клиентского проекта](media/mathclient-project-name-2019.png "Name the client project")

1. Нажмите кнопку **Создать**, чтобы создать клиентский проект.

::: moniker-end

::: moniker range="vs-2017"

### <a name="to-create-a-client-app-in-visual-studio-2017"></a>Создание клиентского приложения в Visual Studio 2017

1. Чтобы создать приложение C++, которое использует созданную вами библиотеку DLL, в строке меню выберите **Файл** > **Создать** > **Проект**.

1. В левой области диалогового окна **Новый проект** выберите **Классическое приложение Windows** в разделе **Установленные**  >  **Visual C++** . На центральной панели выберите **Мастер классических приложений Windows**. В поле ввода **Имя** укажите имя для проекта `MathClient`.

   ![Именование клиентского проекта](media/mathclient-new-project-name-153.png "Name the client project")

1. Нажмите кнопку **ОК**, чтобы запустить мастер **Проект классического приложения Windows**. В мастере нажмите кнопку **ОК**, чтобы создать проект клиентского приложения.

::: moniker-end

::: moniker range="vs-2015"

### <a name="to-create-a-client-app-in-older-versions-of-visual-studio-2017"></a>Создание клиентского приложения в более ранних версиях Visual Studio 2017

1. Чтобы создать приложение C++, которое использует созданную вами библиотеку DLL, в строке меню выберите **Файл** > **Создать** > **Проект**.

1. В левой области диалогового окна **Новый проект** щелкните **Win32** в разделе **Установленные** > **Шаблоны** > **Visual C++** . В центральной области выберите **Консольное приложение Win32**. В поле ввода **Имя** укажите имя для проекта `MathClient`.

   ![Именование клиентского проекта](media/mathclient-project-name.png "Name the client project")

1. Нажмите кнопку **​​ОК**, чтобы закрыть диалоговое окно **Новый проект**, и запустите **мастер приложений Win32**. На странице **Обзор** диалогового окна **Мастер приложений Win32** нажмите кнопку **Далее** .

1. На странице **Параметры приложения** в поле **Тип приложения** выберите пункт **Консольное приложение**, если он еще не выбран.

1. Нажмите кнопку **Готово** , чтобы создать проект.

::: moniker-end

После завершения работы мастера создается минимальный проект консольного приложения. Имя главного исходного файла будет совпадать с ранее введенным именем проекта. В этом примере используется имя **MathClient.cpp**. Вы можете создать проект, но он еще не использует вашу библиотеку DLL.

Затем, чтобы вызвать функции MathLibrary в исходном коде, ваш проект должен содержать файл MathLibrary.h. Этот файл заголовка можно скопировать в проект клиентского приложения, а затем добавить его в проект как существующий элемент. Этот метод подходит для сторонних библиотек. Однако, если вы работаете над кодом для вашей библиотеки DLL одновременно с вашим клиентом, это может привести к изменениям в одном файле заголовка без их отображения в другом. Чтобы избежать этой проблемы, можно изменить путь **Дополнительные каталоги включаемых файлов** в проекте, чтобы добавить путь к исходному заголовку.

### <a name="to-add-the-dll-header-to-your-include-path"></a>Добавление заголовка библиотеки DLL в путь включения

1. Щелкните правой кнопкой мыши узел **MathClient** в **обозревателе решений**, чтобы открыть диалоговое окно **Страницы свойств**.

1. В раскрывающемся списке **Конфигурация** выберите пункт **Все конфигурации**, если он еще не выбран.

1. В левой области выберите пункт **Общие** в узле **Свойства конфигурации** > **C/C++** .

1. На панели свойств щелкните раскрывающийся элемент управления рядом с полем ввода параметра **Дополнительные каталоги включаемых файлов**, а затем щелкните **Правка**.

   ![Редактирование свойства "Дополнительные каталоги включаемых файлов"](media/mathclient-additional-include-directories-property.png "Edit the Additional Include Directories property")

1. Дважды щелкните в верхней панели диалогового окна **Дополнительные каталоги включаемых файлов**, чтобы включить элемент управления "Поле ввода".

1. В элементе управления "Поле ввода" укажите путь к расположению файла заголовка **MathLibrary.h**. Щелкните стрелку вниз и выберите  **\<изменить >** . Можно щелкнуть значок папки, а затем кнопку с многоточием ( **...** ), чтобы перейти к нужной папке.
 
   В этом случае можно также ввести относительный путь из папки, содержащей cpp-файлы в клиентском проекте, в папку, содержащую h-файл в проекте DLL. Если ваш клиентский проект находится в отдельном решении в той же папке, что и решение DLL, относительный путь должен выглядеть следующим образом:

   `..\MathLibrary\MathLibrary`

   Если библиотеки DLL и клиентские проекты находятся в одном решении или решения находятся в разных папках, необходимо соответствующим образом настроить относительный путь или найти папку с помощью метода, описанного выше.

   ![Добавление расположения заголовка в свойстве "Дополнительные каталоги включаемых файлов"](media/mathclient-additional-include-directories.png "Add the header location to the Additional Include Directories property")

1. После ввода пути к файлу заголовка в диалоговом окне **Дополнительные каталоги включаемых** файлов нажмите кнопку **ОК** , чтобы вернуться к диалоговому окну **страницы свойств** , а затем нажмите кнопку **ОК** , чтобы сохранить изменения.

Теперь можно добавить файл **MathLibrary.h** и использовать функции, которые он объявляет, в вашем клиентском приложении. Замените содержимое файла **MathClient.cpp**, используя следующий код:

```cpp
// MathClient.cpp : Client app for MathLibrary DLL.
// #include "pch.h" Uncomment for Visual Studio 2017 and earlier
#include <iostream>
#include "MathLibrary.h"

int main()
{
    // Initialize a Fibonacci relation sequence.
    fibonacci_init(1, 1);
    // Write out the sequence values until overflow.
    do {
        std::cout << fibonacci_index() << ": "
            << fibonacci_current() << std::endl;
    } while (fibonacci_next());
    // Report count of values written before overflow.
    std::cout << fibonacci_index() + 1 <<
        " Fibonacci sequence values fit in an " <<
        "unsigned 64-bit integer." << std::endl;
}
```

Этот код можно скомпилировать, но не скомпоновать, потому что компоновщик пока не может найти библиотеку импорта, необходимую для сборки приложения. Компоновщик должен найти файл MathLibrary.lib для успешной компоновки. Добавьте файл MathLibrary.lib в сборку, настроив свойство **Дополнительные зависимости**. Вы можете скопировать файл библиотеки в проект клиентского приложения, но если и библиотека, и клиентское приложение находятся в стадии разработки, это может привести к изменениям в одной копии, которые не будут отображаться в другой. Чтобы избежать этой проблемы, вы можете изменить путь **Дополнительные каталоги библиотек** в проекте, включив в него путь к исходной библиотеке при компоновке.

### <a name="to-add-the-dll-import-library-to-your-project"></a>Добавление библиотеки импорта DLL в проект

1. Щелкните правой кнопкой мыши узел **MathClient** в **обозревателе решений**, чтобы открыть диалоговое окно **Страницы свойств**.

1. В раскрывающемся списке **Конфигурация** выберите пункт **Все конфигурации**, если он еще не выбран. Этот параметр гарантирует, что путь будет установлен как для отладочной сборки, так и для сборки выпуска.

1. В левой области выберите **Ввод** в разделе **Свойства конфигурации** > **Компоновщик**. На панели свойств щелкните раскрывающийся элемент управления рядом с полем ввода параметра **Дополнительные зависимости**, а затем щелкните **Правка**.

   ![Изменение свойства "Дополнительные зависимости"](media/mathclient-additional-dependencies-property.png "Edit the Additional Dependencies property")

1. В диалоговом окне **Дополнительные зависимости** добавьте `MathLibrary.lib` в список в верхнем элементе управления "Поле ввода".

   ![Добавление зависимости библиотеки](media/mathclient-additional-dependencies.png "Add the library dependency")

1. Нажмите кнопку **OK**, чтобы вернуться в диалоговое окно **Страницы свойств**.

1. В левой области выберите **Общие** в разделе **Свойства конфигурации** > **Компоновщик**. На панели свойств щелкните раскрывающийся элемент управления рядом с полем ввода параметра **Дополнительные каталоги библиотек**, а затем щелкните **Правка**.

   ![Редактирование свойства "Дополнительные каталоги библиотек"](media/mathclient-additional-library-directories-property.png "Edit the Additional Library Directories property")

1. Дважды щелкните в верхней панели диалогового окна **Дополнительные каталоги библиотек**, чтобы включить элемент управления "Поле ввода". В элементе управления "Поле ввода" укажите путь к расположению файла **MathLibrary.lib**. Он находится в папке, которая `Debug` называется непосредственно в папке решения. При создании сборки выпуска выходные данные будут помещены в папку с именем `Release`. Можно использовать следующий макрос, чтобы компоновщик мог найти библиотеку DLL независимо от типа создаваемой сборки:

   **Visual Studio 2019:**

   `..\MathLibrary\$(IntDir)`

   **Visual Studio 2017 и более ранние версии:**

   `..\..\MathLibrary\$(IntDir)`

   ![Добавление каталога библиотеки](media/mathclient-additional-library-directories.png "Add the library directory")

1. Как только вы ввели путь к файлу библиотеки, в диалоговом окне **Дополнительные каталоги библиотек** нажмите кнопку **ОК**, чтобы вернуться в диалоговое окно **Страницы свойств**.

Ваше клиентское приложение теперь можно компилировать и компоновать, но в нем по-прежнему нет всего необходимого для запуска. Когда операционная система загружает ваше приложение, оно ищет библиотеку DLL MathLibrary. Если она не может найти библиотеку DLL в определенных системных каталогах, в пути среды или локальном каталоге приложения, загрузка завершается сбоем. Чтобы избежать этой проблемы, можно скопировать библиотеку DLL в каталог, в котором находится исполняемый файл клиента, в процессе сборки. Чтобы скопировать библиотеку DLL, вы можете добавить **событие после сборки** в ваш проект, чтобы добавить команду, которая копирует библиотеку DLL в выходной каталог вашей сборки. Указанная здесь команда копирует библиотеку DLL только в том случае, если она отсутствует или изменилась, и использует макросы для копирования в правильные расположения сборки отладки или сборки выпуска в вашей конфигурации и из них.

### <a name="to-copy-the-dll-in-a-post-build-event"></a>Копирование библиотеки DLL в событие после сборки

1. Щелкните правой кнопкой мыши узел **MathClient** в **обозревателе решений**, чтобы открыть диалоговое окно **Страницы свойств**.

1. В раскрывающемся списке "Конфигурация" выберите пункт **Все конфигурации**, если он еще не выбран.

1. В области слева щелкните **Событие после сборки** в разделе **Свойства конфигурации** > **События сборки**.

1. В области свойств щелкните элемент управления "Поле ввода" в поле **Командная строка**, а затем введите следующую команду:

   **Visual Studio 2019:**

   `xcopy /y /d "..\MathLibrary\$(IntDir)MathLibrary.dll" "$(OutDir)"`

    **Visual Studio 2017 и более ранние версии:**

   `xcopy /y /d "..\..\MathLibrary\$(IntDir)MathLibrary.dll" "$(OutDir)"`

   ![Добавление команды после сборки](media/mathclient-post-build-command-line.png "Add the post-build command")

1. Нажмите кнопку **OK**, чтобы сохранить изменения в свойствах проекта.

Теперь в вашем клиентском приложении есть все, что нужно для сборки и запуска. Соберите приложение, щелкнув команду **Сборка** > **Собрать решение** в меню. Окно **вывода** в Visual Studio должно иметь нечто вроде следующего примера в зависимости от используемой версии Visual Studio:

```Output
1>------ Build started: Project: MathClient, Configuration: Debug Win32 ------
1>pch.cpp
1>MathClient.cpp
1>MathClient.vcxproj -> C:\Users\username\Source\Repos\MathClient\Debug\MathClient.exe
1>MathClient.vcxproj -> C:\Users\username\Source\Repos\MathClient\Debug\MathClient.pdb (Partial PDB)
1>1 File(s) copied
========== Build: 1 succeeded, 0 failed, 0 up-to-date, 0 skipped ==========
```

Поздравляем, вы создали приложение, которое вызывает функции в вашей библиотеке DLL. Теперь запустите свое приложение, чтобы увидеть, как оно работает. В строке меню щелкните **Отладка** > **Начать без отладки**. В Visual Studio открывается командное окно для запуска программы. Последняя часть выходных данных должна выглядеть так:

![Запуск клиентского приложения без отладки](media/mathclient-run-without-debugging.png "Start the client app without debugging")

Для закрытия командного окна нажмите любую клавишу.

Теперь, когда вы создали библиотеку DLL и клиентское приложение, вы можете экспериментировать. Попробуйте задать точки останова в коде клиентского приложения и запустите приложение в отладчике. Посмотрите, что происходит, когда вы входите в вызов библиотеки. Добавьте другие функции в библиотеку или напишите другое клиентское приложение, которое использует вашу библиотеку DLL.

При развертывании приложения необходимо также развернуть используемые им библиотеки DLL. Самый простой способ сделать библиотеки DLL, которые вы создаете или добавляете из сторонних источников, доступными для вашего приложения — поместить их в тот же каталог, что и ваше приложение. Это также называется *развертыванием локальных приложений*. Дополнительные сведения о развертывании см. в разделе [Deployment in Visual C++](../windows/deployment-in-visual-cpp.md).

## <a name="see-also"></a>См. также

[Вызов функций библиотек DLL из приложений Visual Basic](calling-dll-functions-from-visual-basic-applications.md)
