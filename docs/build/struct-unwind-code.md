---
title: Структура UNWIND_CODE
ms.date: 11/04/2016
ms.assetid: 104955d8-7e33-4c5a-b0c6-3254648f0af3
ms.openlocfilehash: 1ba3cc76c521e158ba448ac2e4e1beda9b3da35a
ms.sourcegitcommit: 6052185696adca270bc9bdbec45a626dd89cdcdd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/31/2018
ms.locfileid: "50643239"
---
# <a name="struct-unwindcode"></a>Структура UNWIND_CODE

В массиве кодов очистки используется для записи последовательности операций в прологе, влияющих на неизменяемые регистры и RSP. Каждый элемент кода имеет следующий формат:

|||
|-|-|
|UBYTE|Смещение в прологе|
|UBYTE: 4|Код операции очистки|
|UBYTE: 4|Сведения об операции|

Массив сортируется по убыванию смещения в прологе.

## <a name="offset-in-prolog"></a>Смещение в прологе

Смещение от начала пролога конец инструкции, выполняющий эту операцию, плюс 1 (то есть смещение начала следующей инструкции).

## <a name="unwind-operation-code"></a>Код операции очистки

Примечание: Некоторые коды операций требуется смещение без знака со значением в локальном стеке. Это смещение относится с самого начала (адрес младшего) выделения основных стека. Если поле регистра кадра стека в UNWIND_INFO равно нулю, это смещение относится от RSP. Если поле регистра кадра не равно нулю, это смещение от где RSP находился при регистра FP. Это соответствует значению FP минус смещение регистра FP (16 \* масштабированное смещение регистра кадра стека в UNWIND_INFO). Если используется регистра FP, затем любой код очистки со смещением должен использоваться только после установления FP reg в прологе.

Для всех кодов операций, за исключением `UWOP_SAVE_XMM128` и `UWOP_SAVE_XMM128_FAR`, смещение всегда будет кратен 8, так как все стека интересующие значения хранятся в 8 байт (сам стек всегда является 16-байтовым). Для кодов операций с коротким смещением (менее 512 КБ) завершающий USHORT в узлах кода содержит смещение, разделенное на 8. Для кодов операций длинным смещением (512K < = смещение < 4 ГБ), окончательный двумя узлами USHORT для этого кода содержат смещение (в формате с прямым порядком байтов).

Для кодов операций `UWOP_SAVE_XMM128` и `UWOP_SAVE_XMM128_FAR`, смещение всегда будет кратен 16, так как все операции XMM 128-разрядный должно находиться на 16-байтовый выровненную память. Таким образом, используется коэффициент масштабирования 16 для `UWOP_SAVE_XMM128`, использовать смещение до 1 МБ.

Код операции очистки является одним из следующих:

`UWOP_PUSH_NONVOL` (0) 1 узел

Отправьте регистр защищенным целочисленным, уменьшение RSP по 8. Сведения об операции — номер регистра. Обратите внимание, что из-за ограничения, накладываемые на эпилога, `UWOP_PUSH_NONVOL` кодов очистки должен быть первым в прологе и соответственно, последними в массиве кодов очистки. Этот относительный порядок применяется для всех других кодов очистки, за исключением `UWOP_PUSH_MACHFRAME`.

`UWOP_ALLOC_LARGE` (1) 2 или 3 узлов

Выделите большого объема в стеке. Существует две формы. Сведения об операции равен 0, то размер выделенной памяти, разделенный на 8 записывается в следующую ячейку, позволяя выделение до 512 K - 8. Если сведений об операции значение 1, то немасштабированным размер выделения записывается в следующие две ячейки в формате с прямым порядком байтов, что позволяет выделять до 4 ГБ - 8.

`UWOP_ALLOC_SMALL` (2) 1 узел

Выделите небольшого объема в стеке. Размер выделения — это поле сведений об операции \* 8 + 8, что позволяет выделять от 8 до 128 байт.

Код очистки для выделения памяти в стеке следует всегда использовать наиболее короткую кодировку:

|**Размер выделения**|**Код очистки**|
|-|-|
|от 8 до 128 байт|`UWOP_ALLOC_SMALL`|
|136 до 512 КБ — 8 байт|`UWOP_ALLOC_LARGE`, сведений об операции = 0|
|512 КБ до 4 ГБ — 8 байт|`UWOP_ALLOC_LARGE`, сведений об операции = 1|

`UWOP_SET_FPREG` (3) 1 узел

Установите регистр указателя кадра, задав для некоторых смещение текущего RSP регистра. Смещение равно поле регистра кадра смещения (масштабирования) в UNWIND_INFO \* 16, что позволяет смещения от 0 до 240. Использование смещения позволяет установить указатель кадра, который указывает на середину фиксированного выделения стека, помогая плотность кода, позволяя несколько обращений к использовать форм коротких инструкций. Обратите внимание, что поле сведений об операции зарезервирован и не должны использоваться.

`UWOP_SAVE_NONVOL` (4) 2 узлов

Сохраните энергонезависимый регистр целых чисел в стеке, используя функцию MOV вместо Push-уведомления. Это в основном используется для отведения сохранения, сохранения защищенный регистр в стек в позицию, которая ранее была выделена. Сведения об операции — номер регистра. Смещение стека масштабируется по 8 записывается в следующей ячейке кода завершающей операции, как описано ранее в примечании.

`UWOP_SAVE_NONVOL_FAR` (5) 3 узлов

Сохраните энергонезависимый регистр целых чисел в стеке с длинным смещением, используя функцию MOV вместо Push-уведомления. Это в основном используется для отведения сохранения, сохранения защищенный регистр в стек в позицию, которая ранее была выделена. Сведения об операции — номер регистра. Смещение немасштабированным стека записывается в следующих двух кода завершающей операции, как описано ранее в примечании.

`UWOP_SAVE_XMM128` (8) 2 узлов

Сохраните все 128 байт энергонезависимого регистра XMM в стеке. Сведения об операции — номер регистра. Смещение стека масштабируется на 16 записывается в следующую ячейку.

`UWOP_SAVE_XMM128_FAR` (9) 3 узлов

Сохраните все 128 байт энергонезависимого регистра XMM в стеке с длинным смещением. Сведения об операции — номер регистра. Смещение немасштабированным стека записывается в следующие две ячейки.

`UWOP_PUSH_MACHFRAME` (10) 1 узел

Передача машинного кадра.  Используется для записи воздействия аппаратного прерывания или исключения. Существует две формы. Сведения об операции равен 0, следующие был отправлен в стек:

|||
|-|-|
|RSP + 32|SS|
|RSP + 24|Старый RSP|
|RSP + 16|EFLAGS|
|RSP + 8|CS|
|RSP|ЗАРЕЗЕРВИРОВАННОГО IP-АДРЕСА|

Если сведения об операции равна 1, то вместо этого был отправлен следующее:

|||
|-|-|
|RSP + 40|SS|
|RSP + 32|Старый RSP|
|RSP + 24|EFLAGS|
|RSP + 16|CS|
|RSP + 8|ЗАРЕЗЕРВИРОВАННОГО IP-АДРЕСА|
|RSP|Код ошибки|

Этот код очистки всегда будет отображаться в фиктивном прологе, который никогда не выполняется, но вместо этого отображается перед реальной точкой входа подпрограммы прерывания и существует только для предоставления место для имитации передачи машинного кадра. `UWOP_PUSH_MACHFRAME` Записывает эту имитацию, что означает, что компьютер концептуально выполнил следующее:

1. Обратного адреса RIP с вершины стека в *Temp*

1. Передача SS

1. Старый RSP Push-уведомлений

1. Push-EFLAGS

1. Передача CS

1. Push- *Temp*

1. Передача кода ошибки (если сведений об операции значение 1)

Simulated `UWOP_PUSH_MACHFRAME` операции уменьшает RSP на 40 (сведений об операции значение 0) или 48 (сведений об операции значение 1).

## <a name="operation-info"></a>Сведения об операции

Значение этих 4 бита зависит от кода операции. Для кодирования регистра общего назначения (целое число), используется следующее сопоставление.

|||
|-|-|
|0|RAX|
|1|RCX|
|2|RDX|
|3|RBX|
|4|RSP|
|5|RBP|
|6|RSI|
|7|RDI|
|8 – 15|R8 для R15|

## <a name="see-also"></a>См. также

[Данные раскрутки для обработки исключений и поддержки отладчика](../build/unwind-data-for-exception-handling-debugger-support.md)
