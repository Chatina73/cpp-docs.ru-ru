---
title: Использование стека x64
ms.date: 12/17/2018
ms.assetid: 383f0072-0438-489f-8829-cca89582408c
ms.openlocfilehash: 3318a3512f83e242496454ffa2dc4aa8d26e1fc3
ms.sourcegitcommit: ff3cbe4235b6c316edcc7677f79f70c3e784ad76
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/19/2018
ms.locfileid: "53627323"
---
# <a name="x64-stack-usage"></a>Использование стека x64

Всю память за пределами текущего адреса RSP считаются временными: Операционная система или отладчик, могут быть перезаписаны эта память во время сеанса отладки пользователя, или обработчик прерываний. Таким образом RSP должны всегда устанавливаться перед попыткой чтения и записи значений на кадр стека.

В этом разделе описывается порядок выделения пространства стека для локальных переменных и **alloca** внутренние.

## <a name="stack-allocation"></a>Выделение памяти в стеке

В прологе функции отвечает за выделение памяти в стеке для локальных переменных, сохраняемые регистры, параметров стека и регистра.

Область параметров всегда находится в нижней части стека (даже если `alloca` используется), чтобы всегда будет иметь смежные по обратному адресу, при вызове функции. Содержит по крайней мере четыре записи, но всегда требуется достаточно места для хранения всех параметров для любой функции, который может быть вызван. Обратите внимание, что всегда распределения пространства для параметров, даже если самих параметров, они никогда не размещаются в стеке. Вызываемый объект гарантируется, что места, выделенного для всех параметров. Домашние адреса являются обязательными для аргументов регистра, поэтому непрерывную область доступен в случае, если необходимо получить адрес списка аргументов (va_list) или отдельного аргумента вызываемой функции. В этой области также предоставляет удобное место для сохранения аргументами регистра во время выполнения преобразователя и как средство отладки (например, он упрощает аргументы для поиска во время отладки, если они хранятся в свои домашние адреса кода пролога). Даже если эта функция имеет менее 4 параметры, четыре ячейки стека, фактически принадлежат вызываемой функции и может использоваться для других целей, помимо хранения значений регистра параметров вызываемой функцией.  Поэтому вызывающая сторона не может сохранять данные в этой области стека во время вызова функции.

Если пространство выделяется динамически (`alloca`) в функции, то защищенный регистр должен использоваться как указатель кадра для пометки основание фиксированной части стека и что нужно сохранить и инициализированы в прологе регистра. Обратите внимание, что при `alloca` — используется, вызовы же вызываемый объект из одного вызывающего объекта могут иметь различные домашние адреса для параметров регистра.

Стек всегда используется 16-байтовое значение aligned, за исключением пролога (например, после возвращаемого адреса) и других случаев, как показано в [типы функций](#function-types) для конкретных классов или функций кадра.

Далее приведен пример макета стека, где функция A вызывает неконечных функцию в прологе функции б A уже выделена память для всех регистра и стека параметров, необходимых В нижней части стека. Вызов передает обратный адрес и B пролога выделяет место для ее локальных переменных, неизменяемые регистры и места, необходимого для вызова функции. Если используется B `alloca`, пространство, выделенное между локальных переменных или защищенного регистра областью для хранения и параметра области стека.

![Пример преобразования AMD](../build/media/vcamd_conv_ex_5.png "пример преобразования AMD")

Когда функция B вызывает другую функцию, обратный адрес помещается непосредственно под домашний адрес для RCX.

## <a name="dynamic-parameter-stack-area-construction"></a>Создание динамического параметра области стека

Если используется указатель кадра, динамическое создание параметра области стека предусмотрен параметр. Это не делается в настоящее время x64 компилятора.

## <a name="function-types"></a>Типы функций

По сути, существует два типа функций. Функции, требующей кадр стека называется *кадров функция*. Вызывается функция, которая не требует кадр стека *конечные функция*.

Функция кадра является функция, которая выделяет пространство стека, вызывает другие функции, сохраняет неизменяемые регистры или использует обработку исключений. Оно также требует записи в таблице функции. Функция кадра требует пролога и эпилога. Функция кадра могут динамически выделять место в стеке и использовать указатель фрейма. Функция кадра имеет все возможности вызова стандартных при их наличии.

Если функция кадра не вызывает другую функцию, то он не требуется для выравнивания стека (на который ссылается раздел [выделение памяти в стеке](#stack-allocation)).

Конечная функция — это приложения, не требует записи в таблице функции. Он не может вносить изменения в защищенные регистры, включая RSP, это означает, что не может вызывать любые функции или выделить пространство стека. Его можно выравнивать стек во время своего выполнения.

## <a name="malloc-alignment"></a>Выравнивание malloc

[malloc](../c-runtime-library/reference/malloc.md) гарантируется получение результатов, выровнено для хранения любого объекта, который обладает базовым выравниванием, а мог бы поместиться в памяти, выделенной памяти. Объект *базовым выравниванием* — это выравнивание, которое меньше или равно наибольшему выравниванию, которое поддерживается реализацией без задания выравнивания. (В Visual C++ это основное выравнивание, необходимое для `double`, или 8 байт. В коде для 64-разрядных платформ это ограничение составляет 16 байтов.) Например выделение 4 байт будет выровнено по границе, которая поддерживает любой четырехбайтовый или меньший объект.

Visual C++ допускает типы, имеющие *расширенное выравнивание*, который также называются *сверх-выровненные* типов. Например, типы SSE [__m128](../cpp/m128.md) и `__m256`и типы, объявленные с помощью `__declspec(align( n ))` где `n` больше 8, имеют расширенное выравнивание. Выравнивание памяти на границе, которая подходит для объекта, который требует расширенного выравнивания, не гарантированного `malloc`. Чтобы выделить память для избыточно выровненных типов, используйте [_aligned_malloc](../c-runtime-library/reference/aligned-malloc.md) и соответствующие функции.

## <a name="alloca"></a>alloca

[_alloca](../c-runtime-library/reference/alloca.md) должен быть 16-байтовое выравнивание и использование указателя кадра.

Стека, который выделяется должен включать пространство после него для параметров функций, вызываемых позднее, как описано в [выделение памяти в стеке](#stack-allocation).

## <a name="see-also"></a>См. также

[x64 программные соглашения](../build/x64-software-conventions.md)<br/>
[align](../cpp/align-cpp.md)<br/>
[__declspec](../cpp/declspec.md)