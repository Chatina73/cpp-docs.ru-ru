---
title: Использование стека для 64-разрядных систем
ms.date: 12/17/2018
ms.assetid: 383f0072-0438-489f-8829-cca89582408c
ms.openlocfilehash: b598c33fbdd56630ca3e5ef0da551f38a73baa26
ms.sourcegitcommit: c123cc76bb2b6c5cde6f4c425ece420ac733bf70
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81335533"
---
# <a name="x64-stack-usage"></a>Использование стека для 64-разрядных систем

Вся память за пределами текущего адреса RSP считается нестабильной: ОС или отладчик может перезаписать эту память во время сеанса отладки пользователя или обработчика прерывания. Таким образом, RSP всегда должен быть установлен перед попыткой прочитать или написать значения в кадр стека.

В этом разделе обсуждается распределение пространства стека для локальных переменных и **alloca** внутренне.

## <a name="stack-allocation"></a>Выделение памяти в стеке

Пролог функции отвечает за выделение пространства стека для локальных переменных, сохраненных регистров, параметров стека и параметров регистра.

Область параметра всегда находится в нижней `alloca` части стека (даже если она используется), так что она всегда будет рядом с обратным адресом во время любого вызова функции. Он содержит по крайней мере четыре записи, но всегда достаточно места, чтобы держать все параметры, необходимые любой функции, которые могут быть вызваны. Обратите внимание, что место всегда выделяется для параметров регистра, даже если сами параметры никогда не разобрались в стеке; вызывающему гарантируется выделение места по всем его параметрам. Домашние адреса необходимы для аргументов регистра, поэтому смежная область доступна в случае, если вызванная функция должна взять адрес списка аргументов (va_list) или отдельный аргумент. Эта область также обеспечивает удобное место для сохранения аргументов регистра во время выполнения thunk и в качестве опции отладки (например, она упрощает поиск аргументов во время отладки, если они хранятся по их домашним адресам в пролог-коде). Даже если вызванная функция имеет менее 4 параметров, эти 4 местоположения стека фактически принадлежат названной функции и могут быть использованы вызванной функцией для других целей, кроме сохранения значений регистра параметров.  Таким образом, абонент не может сохранять информацию в этой области стека через вызов функции.

Если пространство динамически`alloca`выделено () в функции, то нелетучий регистр должен использоваться в качестве указателя кадра для обозначения базы фиксированной части стека, и этот регистр должен быть сохранен и инициализирован в прологе. Обратите внимание, что при `alloca` использовании звонки к тому же вызывающему абоненту из одного и того же вызываемого абонента могут иметь разные домашние адреса для параметров регистра.

Стек всегда будет поддерживаться 16-байт выровнены, за исключением prolog (например, после возврата адреса толкается), и за исключением случаев, указанных в [типах функций функций функций функций функций функций](#function-types) функций функциональности.

Ниже приводится пример макета стека, где функция A вызывает нелистную функцию B. Prolog функции функции A уже выделил место для всех параметров регистра и стека, требуемых B в нижней части стека. Вызов толкает обратный адрес, а prolog B выделяет пространство для локальных переменных, нелетучих регистров и пространства, необходимого для вызова функций. При использовании `alloca`B пространство выделяется между локальной переменной/нелетучей областью сохранения регистра и областью стека параметров.

![Пример преобразования AMD](../build/media/vcamd_conv_ex_5.png "Пример преобразования AMD")

Когда функция B вызывает другую функцию, обратный адрес нажат чуть ниже домашнего адреса RCX.

## <a name="dynamic-parameter-stack-area-construction"></a>Строительство области динамического параметра

При использовании указателя кадра существует возможность динамического создания области стека параметров. В настоящее время это не делается в компиляторе x64.

## <a name="function-types"></a>Типы функций

Есть в основном два типа функций. Функция, требующая стек кадра, называется *функцией кадра.* Функция, не требуя стек кадра называется *функцией листа.*

Функция кадра — это функция, которая распределяет пространство стека, вызывает другие функции, сохраняет нелетучие регистры или использует обработку исключений. Он также требует ввода таблицы функции. Функция кадра требует пролога и эпилога. Функция кадра может динамически распределять пространство стека и использовать указатель кадра. Функция кадра имеет в своем распоряжении все возможности этого стандарта вызова.

Если функция кадра не вызывает другую функцию, то не требуется выравнивать стек (ссылки в разделе [Распределение стеков).](#stack-allocation)

Функция листа — это функция, которая не требует ввода таблицы функции. Он не может вносить изменения в любые нелетучие регистры, включая RSP, что означает, что он не может вызывать какие-либо функции или выделять пространство стека. Разрешается оставлять стек невыровненный во время выполнения.

## <a name="malloc-alignment"></a>маллок выравнивание

[malloc](../c-runtime-library/reference/malloc.md) гарантированно возвращает память, которая надлежащим образом выровнена для хранения любого объекта, который имеет фундаментальное выравнивание и который может поместиться в объеме выделенной памяти. *Фундаментальное выравнивание* — это выравнивание, которое меньше или равно самому большому выравниванию, поддерживаемому реализацией без спецификации выравнивания. (В visual C , это выравнивание, которое необходимо `double`для, или 8 байтов. В коде, который нацелен на 64-битные платформы, это 16 байтов.) Например, распределение в четыре байта будет выровнено на границе, которая поддерживает любой объект с четырьмя байт или меньшими.

Визуальный C'е позволяет типы, которые *имеют расширенное выравнивание*, которые также известны как *чрезмерно выровненные* типы. Например, типы [__m128](../cpp/m128.md) SSE `__m256`__m128 и типы, `__declspec(align( n ))` `n` которые объявляются с помощью, где больше, чем 8, имеют расширенное выравнивание. Выравнивание памяти на границе, подходящей для объекта, требующего расширенного выравнивания, не `malloc`гарантируется. Чтобы выделить память для перевыравниваемых типов, используйте [_aligned_malloc](../c-runtime-library/reference/aligned-malloc.md) и связанные с ними функции.

## <a name="alloca"></a>alloca

[_alloca](../c-runtime-library/reference/alloca.md) должен быть выровнен на 16 байт и дополнительно требуется для использования указателя кадра.

Стек, который выделяется, должен включать пространство после него для параметров впоследствии называемых функций, как это обсуждалось в [распределении стеков.](#stack-allocation)

## <a name="see-also"></a>См. также раздел

[Программные соглашения для 64-разрядных систем](../build/x64-software-conventions.md)<br/>
[Выровнять](../cpp/align-cpp.md)<br/>
[__declspec](../cpp/declspec.md)
