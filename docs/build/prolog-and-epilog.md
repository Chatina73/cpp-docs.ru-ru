---
title: Пролог и эпилог для 64-разрядных систем
ms.date: 12/17/2018
ms.assetid: 0453ed1a-3ff1-4bee-9cc2-d6d3d6384984
ms.openlocfilehash: d0b7444af6e434a09f6af5f5b1c144b46c79ad56
ms.sourcegitcommit: c123cc76bb2b6c5cde6f4c425ece420ac733bf70
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81328436"
---
# <a name="x64-prolog-and-epilog"></a>Пролог и эпилог для 64-разрядных систем

Каждая функция, которая выделяет пространство стека, вызывает другие функции, сохраняет нелетучие регистры или использует обработку исключений, должна иметь пролог, пределы адреса которого описаны в данных раскручивания, связанных с соответствующей записью таблицы функций. Для получения дополнительной [x64 exception handling](../build/exception-handling-x64.md)информации см. Prolog сохраняет аргумент регистров в своих домашних адресах, если это необходимо, толкает нелетучих регистров на стек, выделяет фиксированную часть стека для местных жителей и временных, и дополнительно устанавливает указатель кадра. Связанные с ними данные раскрутки должны описывать действия пролога и предоставлять информацию, необходимую для отработки эффекта пролог-кода.

Если фиксированное распределение в стеке составляет более одной страницы (т.е. больше 4096 байт), то возможно, что распределение стека может охватывать более одной виртуальной страницы памяти и, следовательно, распределение должно быть проверено до его выделения. Для этого предусмотрена специальная рутина, которая может быть высовещена из пролога и не уничтожает ни один из регистров аргументов.

Предпочтительным методом сохранения нелетучих регистров является перемещение их в стек до выделения фиксированного стека. Если фиксированное распределение стека выполняется до сохранения нелетучих регистров, то, скорее всего, для решения сохраненной области регистра требуется 32-битное смещение. (Сообщается, что нажатия регистров так же быстро, как движется и должны оставаться таковыми в обозримом будущем, несмотря на подразумеваемую зависимость между толчками.) Нелетучие регистры могут быть сохранены в любом порядке. Тем не менее, первое использование нелетучих регистра в prolog должно быть, чтобы сохранить его.

## <a name="prolog-code"></a>Пролог код

Код для типичного пролога может быть:

```MASM
    mov    [RSP + 8], RCX
    push   R15
    push   R14
    push   R13
    sub    RSP, fixed-allocation-size
    lea    R13, 128[RSP]
    ...
```

Этот prolog хранит регистр аргумента RCX в своем домашнем положении, сохраняет nonvolatile регистры R13-R15, выделяет фикчированную часть кадра стека, и устанавливает указатель кадра который указывает 128 байтов в фиксированную зону распределения. Использование смещения позволяет решать более фиксированной области распределения с помощью однобайных смещений.

Если размер фиксированного выделения больше или равен одной странице памяти, то перед изменением RSP необходимо вызвать функцию помощника. Этот помощник, `__chkstk`зондирует диапазон стека, чтобы убедиться, что стек расширен должным образом. В этом случае, предыдущий пример prolog вместо этого будет:

```MASM
    mov    [RSP + 8], RCX
    push   R15
    push   R14
    push   R13
    mov    RAX,  fixed-allocation-size
    call   __chkstk
    sub    RSP, RAX
    lea    R13, 128[RSP]
    ...
```

Помощник `__chkstk` не будет изменять любые регистры, кроме R10, R11 и кодов условий. В частности, он вернет RAX без изменений и оставит все нелетучие регистры и аргумент-проходя регистры неизмененными.

## <a name="epilog-code"></a>Эпилог-код

Эпилоговый код существует при каждом выходе на функцию. В то время как, как правило, есть только один prolog, может быть много эпилогов. Код Epilog урезает стек до фиксированного размера распределения (при необходимости), распределяет фиксированное распределение стека, восстанавливает нелетучие регистры, выталкивая их сохраненные значения из стека, и возвращает.

Эпилог-код должен следовать строгому набору правил для кода раскручивания, чтобы надежно расслабиться через исключения и прерывания. Эти правила уменьшают количество требуемых данных, поскольку для описания каждого эпилога не требуется никаких дополнительных данных. Вместо этого код раскрутки может определить, что эпилог выполняется путем сканирования вперед через поток кода для идентификации эпилога.

Если в функции не используется указатель кадра, то эпилог должен сначала дераспределить фиксированную часть стека, выскочили нелетучие регистры и элемент управления возвращается в функцию вызова. Например,

```MASM
    add      RSP, fixed-allocation-size
    pop      R13
    pop      R14
    pop      R15
    ret
```

Если в функции используется указатель кадра, то стек должен быть обрезан до фиксированного распределения до выполнения эпилога. Это действие технически не является частью эпилога. Например, для отсобки prolog, который ранее использовался, можно использовать следующий эпилог:

```MASM
    lea      RSP, -128[R13]
    ; epilogue proper starts here
    add      RSP, fixed-allocation-size
    pop      R13
    pop      R14
    pop      R15
    ret
```

На практике при использовании указателя кадров нет веских причин для настройки RSP в два этапа, поэтому вместо этого будет использоваться следующий эпилог:

```MASM
    lea      RSP, fixed-allocation-size - 128[R13]
    pop      R13
    pop      R14
    pop      R15
    ret
```

Эти формы являются единственными законными для эпилога. Она должна состоять `add RSP,constant` из `lea RSP,constant[FPReg]`либо или , а затем ряд нуля или более `return` 8-байт регистр а сОЗ и `jmp`или . (Только подмножество `jmp` утверждений допустимо в эпилоге. Подмножество представляет собой исключительно `jmp` класс инструкций со ссылками на память ModRM, где значение поля mod ModRM составляет 00. Запрещается `jmp` использование утверждений в эпилоге с значением поля mod ModRM 01 или 10. Смотрите таблицу A-15 в руководстве AMD x86-64 Архитектура программиста Том 3: Общее назначение и системные инструкции, для получения дополнительной информации о допустимых modRM ссылки.) Другой код не может появиться. В частности, в эпилоге ничего нельзя запланировать, включая загрузку значения возврата.

Когда указатель кадра не используется, эпилог должен использовать `add RSP,constant` для дераспределения фиксированной части стека. Он не `lea RSP,constant[RSP]` может использовать вместо этого. Это ограничение существует, поэтому код раскручивания имеет меньше шаблонов для распознавания при поиске эпилогов.

Следуя этим правилам, код раскручивания позволяет определить, что эпилог в настоящее время выполняется, и имитировать выполнение оставшейся части эпилога, чтобы можно было воссоздать контекст функции вызова.

## <a name="see-also"></a>См. также раздел

[x64 Конвенции о программном обеспечении](x64-software-conventions.md)
