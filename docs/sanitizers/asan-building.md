---
title: Справочник по языку, сборке и отладке Аддресссанитизер
description: Техническое описание создания для Аддресссанитизер
ms.date: 03/02/2021
f1_keywords:
- __SANITIZE_ADDRESS__
- ASAN_VCASAN_DEBUGGING
helpviewer_keywords:
- ASan reference
- AddressSanitizer reference
- Address Sanitizer reference
ms.openlocfilehash: f2f173da6d39b460098afe123a7537e36cbdf6a7
ms.sourcegitcommit: 6ed44d9c3fb32e965e363b9c69686739a90a2117
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/08/2021
ms.locfileid: "102471195"
---
# <a name="addresssanitizer-language-build-and-debugging-reference"></a>Справочник по языку, сборке и отладке Аддресссанитизер

В разделах этой статьи описывается спецификация языка Аддресссанитизер, параметры компилятора и параметры компоновщика. Они также описывают параметры, управляющие интеграцией отладчика Visual Studio, характерными для Аддресссанитизер.

Дополнительные сведения о среде выполнения Аддресссанитизер, перехваченных функциях и о том, как привязать пользовательские распределителя, см. в [справочнике по среде выполнения](./asan-runtime.md). Дополнительные сведения о сохранении аварийных дампов из Аддресссанитизер сбоев см. в [справочнике по аварийному дампу](./asan-offline-crash-dumps.md).

## <a name="language-specification"></a>Спецификация языка

### `__SANITIZE_ADDRESS__`

`__SANITIZE_ADDRESS__`Макрос препроцессора определяется так, как `1` если бы [`/fsanitize=address`](../build/reference/fsanitize.md) он был установлен. Этот макрос полезен для опытных пользователей при условии указания исходного кода на наличие среды выполнения Аддресссанитизер.

```cpp
#include <cstdio>

int main() {
    #ifdef __SANITIZE_ADDRESS__
        printf("Address sanitizer enabled");
    #else
        printf("Address sanitizer not enabled");
    #endif
    return 1;
}
```

### `__declspec(no_sanitize_address)`

[`__declspec(no_sanitize_address)`](../cpp/no-sanitize-address.md)Описатель можно использовать для выборочного отключения функции очистки для функций, локальных переменных или глобальных переменных. Это `__declspec` влияет на поведение _компилятора_ , а не на поведение _во время выполнения_ .

```cpp
__declspec(no_sanitize_address)
void test1() {
    int x[100];
    x[100] = 5; // ASan exception not caught
}

void test2() {
    __declspec(no_sanitize_address) int x[100];
    x[100] = 5; // ASan exception not caught
}

__declspec(no_sanitize_address) int g[100];
void test3() {
    g[100] = 5; // ASan exception not caught
}
```

## <a name="compiler"></a>Компилятор

### <a name="fsanitizeaddress-compiler-option"></a>Параметр компилятора `/fsanitize=address`

[`/fsanitize=address`](../build/reference/fsanitize.md)Параметр компилятора позволяет инструментировать ссылки памяти в коде для перехвата ошибок безопасности памяти во время выполнения. Обработчики инструментирования загружают, хранят, области, выделены и CRT-функции. Он может обнаруживать скрытые ошибки, такие как недопустимые границы, использовать-After-Free, USE-AFTER-Scope и т. д. Неисчерпывающий список ошибок, обнаруженных во время выполнения, см. в разделе [аддресссанитизер Error examples](./asan-error-examples.md).

**`/fsanitize=address`** совместима со всеми существующими уровнями оптимизации C++ или C (например,,,, **`/Od`** **`/O1`** **`/O2`** **`/O2 /GL`** и профильной оптимизации). Код, созданный с помощью этого параметра, работает со статическими и динамическими библиотек CRT (например,,, **`/MD`** **`/MDd`** **`/MT`** и **`/MTd`** ). Этот параметр компилятора можно использовать для создания. EXE или. Библиотека DLL, предназначенная для x86 или x64. Отладочная информация необходима для оптимального форматирования стеков вызовов.

Примеры кода, демонстрирующие несколько типов обнаружения ошибок, см. в разделе [аддресссанитизер Error examples](asan-error-examples.md).

### <a name="fsanitize-address-use-after-return-compiler-option-experimental"></a>`/fsanitize-address-use-after-return` параметр компилятора (экспериментальный)

По умолчанию компилятор КОМПИЛЯТОРОМ MSVC (в отличие от Clang) не создает код для выделения кадров в куче, чтобы перехватывать ошибки использования после возврата. Чтобы перехватить эти ошибки с помощью Аддресссанитизер, необходимо:

1. Скомпилируйте с помощью [`/fsanitize-address-use-after-return`](../build/reference/fsanitize.md) параметра.
2. Перед выполнением программы выполните команду, `set ASAN_OPTIONS=detect_stack_use_after_return=1` чтобы установить параметр проверки среды выполнения.

**`/fsanitize-address-use-after-return`** Параметр приводит к тому, что компилятор создает код для использования двойного кадра стека в куче, когда локальные переменные считаются адресом. Этот код *намного медленнее* , чем использование только **`/fsanitize=address`** одного. Дополнительные сведения и пример см. в разделе [Error: `stack-use-after-return` ](error-stack-use-after-return.md).

Двойной кадр стека в куче остается после возврата из функции, которая ее создала. Рассмотрим пример, где адрес локальной памяти, выделенной для слота в куче, используется после возврата. Теневые байты, связанные с фиктивным кадром кучи, содержат значение 0xF9. Это 0xF9 означает ошибку использования стека после возврата, когда среда выполнения сообщает об ошибке.

Кадры стека выделяются в куче и остаются после возврата функций. Среда выполнения использует сборку мусора для асинхронного освобождения этих фиктивных объектов кадра вызовов по истечении определенного интервала времени. Адреса локальных переменных передаются в постоянные кадры в куче. Система может определить, когда все локальные переменные используются после возврата определяющей функции. Дополнительные сведения см. в описании [алгоритма использования стека после возврата](https://github.com/google/sanitizers/wiki/AddressSanitizerUseAfterReturn) в соответствии с документацией Google.

## <a name="linker"></a><a name="linker"></a> Linker

### <a name="inferasanlibsno-linker-option"></a>`/INFERASANLIBS[:NO]` параметр компоновщика

**`/fsanitize=address`** Параметр компилятора помечает объекты, чтобы указать библиотеку аддресссанитизер для связи с исполняемым файлом. Библиотеки имеют имена, начинающиеся с *`clang_rt.asan*`* . [`/INFERASANLIBS`](../build/reference/inferasanlibs.md)Параметр компоновщика (по умолчанию) связывает эти библиотеки из расположений по умолчанию автоматически. Ниже приведены библиотеки, которые выбираются и автоматически связываются в.

| CRT, параметр | DLL или EXE | СМ? | Библиотеки среды выполнения Аддресссанитизер |
|--|--|--|--|
| MT | EXE | NO | *`clang_rt.asan-{arch}`*, *`clang_rt.asan_cxx-{arch}`* |
| MT | DLL | NO | *`clang_rt.asan_dll_thunk-{arch}`* |
| MD | ЛЮБОЙ | NO | *`clang_rt.asan_dynamic-{arch}`*, *`clang_rt.asan_dynamic_runtime_thunk-{arch}`* |
| MT | EXE | YES | *`clang_rt.asan_dbg-{arch}`*, *`clang_rt.asan_dbg_cxx-{arch}`* |
| MT | DLL | YES | *`clang_rt.asan_dbg_dll_thunk-{arch}`* |
| MD | ЛЮБОЙ | YES | *`clang_rt.asan_dbg_dynamic-{arch}`*, *`clang_rt.asan_dbg_dynamic_runtime_thunk-{arch}`* |

Параметр компоновщика [`/INFERASANLIBS:NO`](../build/reference/inferasanlibs.md) не позволяет компоновщику связывать *`clang_rt.asan*`* файл библиотеки из расположения по умолчанию. При использовании этого параметра добавьте путь к библиотеке в скриптах сборки. В противном случае компоновщик сообщает об ошибке неразрешенного внешнего символа.

## <a name="visual-studio-integration"></a>интеграция Visual Studio

### <a name="fno-sanitize-address-vcasan-lib-compiler-option"></a>Параметр компилятора `/fno-sanitize-address-vcasan-lib`

**`/fsanitize=address`** Параметр содержит ссылки на дополнительные библиотеки для улучшения возможностей отладки Visual Studio при возникновении исключения аддресссанитизер. Эти библиотеки называются **вкасан**. Библиотеки позволяют Visual Studio отображать ошибки Аддресссанитизер в исходном коде. Они также позволяют исполняемому файлу создавать аварийные дампы при создании отчета об ошибке Аддресссанитизер. Дополнительные сведения см. в разделе [Библиотека расширенных функциональных возможностей Visual Studio аддресссанитизер](./asan-debugger-integration.md).

Выбранная библиотека зависит от параметров компилятора и автоматически связывается в.

| Параметр среды выполнения | Версия Вкасан |
|--------------|----------------|
| **`/MT`**        | *`libvcasan.lib`*  |
| **`/MD`**        | *`vcasan.lib`*     |
| **`/MTd`**       | *`libvcasand.lib`* |
| **`/MDd`**       | *`vcasand.lib`*    |

Однако при компиляции с использованием **`/Zl`** (опустить имя библиотеки по умолчанию) необходимо вручную указать библиотеку. Если этого не сделать, вы получите неразрешенную ошибку ссылки на внешний символ. Ниже приведены некоторые типичные примеры.

```Output
error LNK2001: unresolved external symbol __you_must_link_with_VCAsan_lib
error LNK2001: unresolved external symbol ___you_must_link_with_VCAsan_lib
```

Улучшенную отладку можно отключить во время компиляции с помощью [`/fno-sanitize-address-vcasan-lib`](../build/reference/fsanitize.md) параметра.

### <a name="asan_vcasan_debugging-environment-variable"></a>Переменная среды `ASAN_VCASAN_DEBUGGING`.

**`/fsanitize=address`** Параметр компилятора создает двоичный файл, который предоставляет ошибки безопасности памяти во время выполнения. Когда двоичный файл запускается из командной строки, и среда выполнения сообщает об ошибке, она выводит сведения об ошибке. Затем выполняется выход из процесса. `ASAN_VCASAN_DEBUGGING`Переменная среды может быть настроена для немедленного запуска интегрированной среды разработки Visual Studio, когда среда выполнения сообщает об ошибке. Этот параметр компилятора позволяет просмотреть ошибку, наложенную на исходный код, по точной строке и столбцу, вызвавшему ошибку.

Чтобы включить такое поведение, выполните команду `set ASAN_VCASAN_DEBUGGING=1` перед запуском приложения. Вы можете отключить улучшенную отладку, выполнив процедуру `set ASAN_VCASAN_DEBUGGING=0` .

## <a name="see-also"></a>См. также раздел

[Обзор Аддресссанитизер](./asan.md)\
[Известные проблемы Аддресссанитизер](./asan-known-issues.md)\
[Справочник по среде выполнения Аддресссанитизер](./asan-runtime.md)\
[Аддресссанитизер теневых байт](./asan-shadow-bytes.md)\
[Аддресссанитизер облачное или распределенное тестирование](./asan-offline-crash-dumps.md)\
[Интеграция отладчика Аддресссанитизер](./asan-debugger-integration.md)\
[Примеры ошибок Аддресссанитизер](./asan-error-examples.md)
